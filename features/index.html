<!-- FEATURES -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Features — Camila Tiburcio Rubio</title>

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400..800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','sans-serif'],
            serif: ['Source Serif 4','Georgia','serif']
          },
          colors: {
            ink: { 900:'#0E0E0E',700:'#1F1F1F',500:'#3A3A3A',300:'#9CA3AF' },
            cream: '#FAF7F2',
            accent: { DEFAULT:'#C53D2F', dark:'#9E2F24', light:'#E95A49' }
          },
          boxShadow: { soft:'0 10px 30px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <style>
    .u-underline { position: relative; }
    .u-underline::after { content:''; position:absolute; left:0; bottom:-2px; height:2px; width:100%; background:currentColor; transform:scaleX(0); transform-origin:left; transition:transform .25s ease; }
    .u-underline:hover::after { transform:scaleX(1); }

    .author-link:hover .u-underline::after {
      transform: scaleX(1);
    }

    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden; }

    .chip { border:1px solid rgba(0,0,0,.10); border-radius:9999px; padding:.45rem .8rem; font-weight:600; font-size:.85rem; }
    .chip[data-active="true"] { background:rgba(197,61,47,.10); color:#C53D2F; border-color:rgba(197,61,47,.35); }

    ::selection { background: rgba(197,61,47,0.15); }
    mark.hl { background: rgba(197,61,47,.22); color: inherit; padding: 0 .15em; border-radius:.25em; }

    @keyframes fadeInPage {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    body.fade-in-page {
      animation: fadeInPage 0.35s ease-out;
    }

    /* Hide native clear buttons in search inputs */
    input[type="search"]::-webkit-search-cancel-button,
    input[type="search"]::-webkit-search-decoration,
    input[type="search"]::-webkit-search-results-button,
    input[type="search"]::-webkit-search-results-decoration { -webkit-appearance:none; appearance:none; display:none; }
    input[type="search"]::-ms-clear { display:none; }

    /* Stretched-click cues */
    [data-href]{ transition: box-shadow .2s ease, transform .2s ease, background-color .2s ease; cursor: pointer; }
    [data-href]:hover{ transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06); }
    [data-href]:focus-visible{ outline:2px solid #C53D2F; outline-offset:2px; transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06); }

    @media (prefers-reduced-motion: reduce){
      [data-href]{ transition: none !important; }
    }

    /* Hide horizontal scrollbars while keeping scroll */
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE & Edge */
      scrollbar-width: none;     /* Firefox */
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;             /* Chrome, Safari, Opera */
    }
  </style>

  <link rel="canonical" href="https://example.com/features" />
  <meta property="og:type" content="website">
  <meta property="og:title" content="Features — Camila Tiburcio Rubio">
  <meta property="og:description" content="Featured essays, interviews, reviews, and visual stories">
  <meta property="og:url" content="https://example.com/features">
  <meta property="og:image" content="https://picsum.photos/1200/630?features">
  <meta name="twitter:card" content="summary_large_image">
</head>

<body class="bg-cream text-ink-900 antialiased fade-in-page">
  <!-- Top strip -->
  <div class="bg-ink-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
      <p>New: Fall features now live — interviews, essays & visual art</p>
      <a href="../newsletter/" class="u-underline">Subscribe</a>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-cream/80 bg-cream/95 border-b border-black/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Flex row for ALL header items -->
      <div class="flex items-center justify-between h-20">

        <!-- LEFT: Brand -->
        <a href="/CamilaTiburcioRubio/" 
           class="flex items-center gap-3 group" 
           aria-label="Home">

          <img 
            src="../assets/logo.png" 
            alt="Lot K8 logo" 
            class="h-12 w-12 object-contain transition group-hover:opacity-90"
          />

          <!-- Title + Subtitle -->
          <div class="flex flex-col leading-tight">
            <span class="font-serif text-2xl tracking-[0.015em]">
              Lot K8
            </span>
            <span class="text-xs text-ink-300 tracking-wide -mt-0.5">
              Essays, interviews & visual culture
            </span>
          </div>

        </a>

        <!-- MIDDLE: Desktop Navigation -->
        <nav class="hidden md:flex items-center gap-8" aria-label="Primary">
          <a class="u-underline font-semibold text-accent" href="../features/">Features</a>
          <a class="u-underline" href="../latest/">Latest</a>
          <a class="u-underline" href="../sections/">Sections</a>
          <a class="u-underline" href="../about/">About</a>
        </nav>

        <!-- RIGHT: Desktop Search + Hamburger -->
        <div class="hidden md:flex items-center gap-4">
          <!-- Desktop search -->
          <label class="relative" aria-label="Search site">
            <input id="q-desktop" type="search" placeholder="Search…" 
                   class="pl-10 pr-10 py-2 rounded-full border border-black/10 bg-white/70 focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-ink-300" 
                 viewBox="0 0 24 24" aria-hidden="true">
                 <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
                 <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
            <button id="qHeaderBtn" 
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-ink-300 hover:text-ink-500" 
                    aria-label="Search">↵</button>
          </label>
        </div>

        <!-- Mobile hamburger -->
        <div class="md:hidden">
          <button id="menuToggle" 
                  class="p-2 rounded-md border border-black/10 focus:outline-none" 
                  aria-expanded="false" 
                  aria-controls="mobileMenu" 
                  aria-label="Open menu">
            <svg id="menuIcon" 
                 xmlns="http://www.w3.org/2000/svg" 
                 class="h-6 w-6" 
                 fill="none" 
                 viewBox="0 0 24 24" 
                 stroke="currentColor" 
                 aria-hidden="true">
              <path stroke-linecap="round" 
                    stroke-linejoin="round" 
                    stroke-width="2" 
                    d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>

      </div> <!-- END flex row -->

    </div>

    <!-- Mobile dropdown menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-cream border-t border-black/10">
      <nav class="px-4 py-4 space-y-3" aria-label="Mobile">
        <a class="block u-underline font-semibold text-accent" href="../features/">Features</a>
        <a class="block u-underline" href="../latest/">Latest</a>
        <a class="block u-underline" href="../sections/">Sections</a>
        <a class="block u-underline" href="../about/">About</a>

        <!-- Mobile search -->
        <label class="relative block mt-3" aria-label="Search site">
          <input id="q-mobile" type="search" placeholder="Search…" 
                 class="w-full pl-10 pr-10 py-2 rounded-full border border-black/10 bg-white/70 focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
          <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-ink-300" 
               viewBox="0 0 24 24" aria-hidden="true">
               <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
               <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
          <button id="qHeaderMobileBtn" 
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-ink-300 hover:text-ink-500" 
                  aria-label="Search">↵</button>
        </label>
      </nav>
    </div>

  </header>

  <!-- Page header -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div class="flex items-end justify-between">
      <div>
        <div class="text-[10px] sm:text-xs tracking-[0.14em] font-semibold text-accent uppercase">Browse</div>
        <h1 class="font-serif text-4xl sm:text-5xl leading-tight mt-1">Features</h1>
        <p class="text-ink-500 mt-2">Handpicked essays, interviews, reviews, and visual stories.</p>
      </div>
      <div class="hidden sm:flex items-center gap-2">
        <label class="text-sm text-ink-500" for="sort">Sort by</label>
        <select id="sort" class="px-3 py-2 rounded-xl border border-black/10 bg-white">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="title">Title (A–Z)</option>
          <option value="read">Read Time</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Hero featured story (fully clickable) -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <article class="grid lg:grid-cols-3 gap-8 items-stretch card" id="heroWrap">
      <div class="lg:col-span-2">
        <img id="heroImg" class="w-full h-full object-cover aspect-[16/9]" src="https://picsum.photos/1200/675?features" alt="Feature hero image">
      </div>
      <div class="p-6 sm:p-8 flex flex-col">
        <div class="flex items-center gap-3 text-xs uppercase tracking-wide text-accent">
          <span class="bg-accent/10 text-accent px-2.5 py-1 rounded-full">Feature</span>
          <time id="heroDate" class="text-ink-300" datetime="">—</time>
        </div>
        <h2 id="heroTitle" class="font-serif text-3xl mt-3 leading-tight">
          The Archive Sings: Sound, Memory, and Diaspora
        </h2>
        <p id="heroExcerpt" class="text-ink-500 mt-3">A longform essay weaving field recordings, neighborhood histories, and oral tradition into a listening guide for place.</p>

        <!-- HERO TAGS -->
        <div id="heroTags" class="hidden mt-3 flex flex-wrap gap-2"></div>

        <div class="mt-auto pt-5">
          <a href="../about/"
             class="author-link flex items-center gap-4 group"
             aria-label="About Camila Tiburcio Rubio">
            <img
              id="heroAvatar"
              class="h-10 w-10 rounded-full object-cover group-hover:ring-2 group-hover:ring-accent group-hover:ring-offset-2 group-hover:ring-offset-cream"
              src="../assets/camila.jpg"
              alt="Camila Tiburcio Rubio"
            />
            <div>
              <p class="text-sm font-medium">
                By <span class="u-underline">Camila Tiburcio Rubio</span>
              </p>
              <p id="heroRead" class="text-xs text-ink-300">—</p>
            </div>
          </a>
        </div>
        <a id="heroLink" href="#" class="mt-4 inline-block u-underline">Read the feature →</a>
      </div>
    </article>
  </section>

  <!-- Controls (chips + inline search + per-page) -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10">
    <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
      <div class="flex gap-2 overflow-x-auto no-scrollbar -mx-4 px-4 pb-1
                  sm:flex-wrap sm:overflow-visible sm:mx-0 sm:px-0">
        <button class="chip" data-filter="all" data-active="true" aria-pressed="true">All</button>
        <button class="chip" data-filter="Essay">Essay</button>
        <button class="chip" data-filter="Interview">Interview</button>
        <button class="chip" data-filter="Review">Review</button>
        <button class="chip" data-filter="Visual">Visual</button>
        <button class="chip" data-filter="Community">Community</button>
        <button class="chip" data-filter="Memoirs">Memoirs</button>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
        <div class="w-full sm:w-auto">
          <label class="sr-only" for="q-inline">Search titles, tags...</label>
          <input
            id="q-inline"
            type="search"
            placeholder="Search titles, tags…"
            class="w-full sm:w-64 px-3 py-2 rounded-xl border border-black/10 bg-white focus:bg-white outline-none focus:ring-2 focus:ring-accent/40"
          />
        </div>
        <div class="flex items-center justify-end gap-2 text-xs sm:text-sm">
          <label class="text-ink-500" for="pageSize">Per page</label>
          <select id="pageSize" class="px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-xl border border-black/10 bg-white">
            <option>6</option>
            <option selected>9</option>
            <option>12</option>
            <option>18</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>

    <!-- Pagination -->
    <div id="pager" class="mt-6 flex items-center justify-between">
      <button id="prevBtn" class="px-4 py-2 rounded-full border border-black/10 hover:bg-white disabled:opacity-40 disabled:pointer-events-none">← Previous</button>
      <div class="text-sm text-ink-300">
        Page <span id="pageNum">1</span> of <span id="pageTotal">1</span> • <span id="countShown">0</span>/<span id="countTotal">0</span> posts
      </div>
      <button id="nextBtn" class="px-4 py-2 rounded-full border border-black/10 hover:bg-white disabled:opacity-40 disabled:pointer-events-none">Next →</button>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="hidden text-ink-500 text-center py-16">
      <p class="text-lg">No featured posts match your filters.</p>
      <button id="resetFilters" class="mt-4 px-3 py-2 rounded-xl border border-black/10 bg-white hover:bg-cream">
        Clear filters
      </button>
    </div>

    <!-- Error state -->
    <div id="errorState" class="hidden text-center py-16 text-red-600">
      <p class="text-lg font-semibold">Couldn’t load posts. Please try again later.</p>
      <button id="retryBtn" class="mt-4 px-3 py-2 rounded-xl border border-red-200 bg-white hover:bg-red-50">
        Retry
      </button>
    </div>

    <!-- Card template -->
    <template id="cardTemplate">
      <article class="card flex flex-col" data-href="#">
        <img class="aspect-[16/10] object-cover" src="" alt="" />
        <div class="p-6 flex-1 flex flex-col">
          <div class="text-xs uppercase tracking-wide text-accent sectionLabel"></div>
          <h3 class="font-serif text-xl mt-2 leading-snug">
            <a class="u-underline link" href="#"></a>
          </h3>
          <p class="text-ink-500 mt-2 desc"></p>

          <!-- TAGS get injected here -->
          <div class="tagsWrap mt-3 flex flex-wrap gap-2"></div>

          <div class="mt-auto pt-4 text-sm text-ink-300 meta"></div>
        </div>
      </article>
    </template>
  </main>

  <!-- Back to top -->
  <button id="backTop"
          class="fixed right-4 bottom-4 hidden px-3 py-2 rounded-full border border-black/10 bg-white shadow-soft text-sm"
          aria-label="Back to top">↑ Top</button>

  <!-- Footer -->
  <footer class="mt-16 bg-white border-t border-black/10 text-sm text-ink-500">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 hidden sm:grid sm:grid-cols-2 md:grid-cols-4 gap-10">
      <!-- Brand -->
      <div>
        <div class="-ml-1.5">
          <div class="flex items-center gap-1">
            <img src="../assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
            <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
          </div>
        </div>
        <p class="mt-2 text-ink-400 text-sm max-w-xs">
          Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
        </p>
      </div>
      <!-- Explore -->
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Explore</h3>
        <ul class="space-y-2">
          <li><a href="../features/" class="u-underline font-semibold text-accent" aria-current="page">Features</a></li>
          <li><a href="../latest/" class="u-underline">Latest</a></li>
          <li><a href="../sections/" class="u-underline">Sections</a></li>
          <li><a href="../archive/" class="u-underline">Archive</a></li>
          <li><a href="../search/" class="u-underline">Search</a></li>
        </ul>
      </div>
      <!-- About -->
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">About</h3>
        <ul class="space-y-2">
          <li><a href="../about/" class="u-underline">About</a></li>
          <li><a href="../contact/" class="u-underline">Contact</a></li>
          <li><a href="../mission/" class="u-underline">Mission</a></li>
          <li><a href="../resume/" class="u-underline">Résumé</a></li>
          <li><a href="../newsletter/" class="u-underline">Newsletter</a></li>
        </ul>
      </div>
      <!-- Follow -->
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Follow</h3>
        <ul class="space-y-2">
          <li><a href="https://instagram.com" class="u-underline">Instagram</a></li>
          <li><a href="https://twitter.com" class="u-underline">X / Twitter</a></li>
          <li><a href="https://facebook.com" class="u-underline">Facebook</a></li>
          <li><a href="https://linkedin.com" class="u-underline">Linkedin</a></li>
          <li><a href="https://youtube.com" class="u-underline">YouTube</a></li>
        </ul>
      </div>
    </div>
     <!-- Mobile accordion footer -->
    <div class="sm:hidden border-t border-black/10">
      <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Brand -->
        <div class="mb-6">
          <div class="-ml-1.5">
            <div class="flex items-center gap-1">
              <img src="../assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
              <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
            </div>
          </div>
          <p class="mt-2 text-ink-400 text-sm max-w-xs">
            Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
          </p>
        </div>

        <!-- Explore -->
        <div class="border-t border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="explore"
            aria-expanded="false"
          >
            <span>Explore</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="explore"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="explore">
            <a href="../features/" class="u-underline font-semibold text-accent" aria-current="page">Features</a>
            <a href="../latest/" class="block u-underline">Latest</a>
            <a href="../sections/" class="block u-underline">Sections</a>
            <a href="../archive/" class="block u-underline">Archive</a>
            <a href="../search/" class="block u-underline">Search</a>
          </div>
        </div>

        <!-- About -->
        <div class="border-t border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="about"
            aria-expanded="false"
          >
            <span>About</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="about"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="about">
            <a href="../about/" class="block u-underline">About</a>
            <a href="../contact/" class="block u-underline">Contact</a>
            <a href="../mission/" class="block u-underline">Mission</a>
            <a href="../resume/" class="block u-underline">Résumé</a>
            <a href="../newsletter/" class="block u-underline">Newsletter</a>
          </div>
        </div>

        <!-- Follow -->
        <div class="border-t border-black/10 border-b border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="follow"
            aria-expanded="false"
          >
            <span>Follow</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="follow"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="follow">
            <a href="https://instagram.com" class="block u-underline">Instagram</a>
            <a href="https://twitter.com" class="block u-underline">X / Twitter</a>
            <a href="https://facebook.com" class="block u-underline">Facebook</a>
            <a href="https://linkedin.com" class="block u-underline">Linkedin</a>
            <a href="https://youtube.com" class="block u-underline">YouTube</a>
          </div>
        </div>
      </div>
    </div>
    <div class="text-center text-xs text-ink-300 border-t border-black/10 py-6">
      © <span id="year"></span> Camila Tiburcio Rubio. All rights reserved.
    </div>
  </footer>

  <!-- ====================================================== -->
  <!--  SCRIPT: Features page with empty/error + clickable    -->
  <!-- ====================================================== -->
  <script>
    /* ---------- Year + mobile menu ---------- */
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    menuToggle?.addEventListener('click', () => {
      const isHidden = mobileMenu.classList.toggle('hidden');
      menuToggle.setAttribute('aria-expanded', String(!isHidden));
    });

    // Back to top
    const backTop = document.getElementById('backTop');
    const toggleTop = () => { if (window.scrollY > 600) backTop.classList.remove('hidden'); else backTop.classList.add('hidden'); };
    window.addEventListener('scroll', toggleTop, { passive:true });
    backTop.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

    /* ---------- Path helper (GitHub Pages–safe) ---------- */
    function toRoot(path) {
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path;        // leave absolute URLs alone
      path = path.replace(/^\.?\//, '');                  // strip leading "./" or "/"
      return '../' + path;                                // go up one level
    }
    /* ---------- DOM refs ---------- */
    const gridEl = document.getElementById('grid');
    const pageNumEl = document.getElementById('pageNum');
    const pageTotalEl = document.getElementById('pageTotal');
    const countShownEl = document.getElementById('countShown');
    const countTotalEl = document.getElementById('countTotal');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pager = document.getElementById('pager');

    const emptyState = document.getElementById('emptyState');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const errorState = document.getElementById('errorState');
    const retryBtn = document.getElementById('retryBtn');

    const chips   = Array.from(document.querySelectorAll('.chip'));
    const qInline = document.getElementById('q-inline');
    const sortSel = document.getElementById('sort');
    const pageSizeSel = document.getElementById('pageSize');

    /* ---------- Utils ---------- */
    const esc = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const fmtDate = iso => { try { return new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});} catch { return ''; } };
    function highlight(text, terms){
      if (!text || !terms.length) return text;
      const pat = new RegExp('(' + terms.map(esc).join('|') + ')', 'ig');
      return text.replace(pat, '<mark class="hl">$1</mark>');
    }

    // Tag chip factory (accent scheme)
    function makeTagChip(text){
      const s = document.createElement('span');
      s.className = 'inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-accent/10 text-accent border border-accent/20 text-xs font-semibold';
      s.textContent = text;
      return s;
    }

    // Make any element behave like a full-card link (used for hero too)
    function setStretchedClick(el, url){
      if (!el || !url) return;
      el.setAttribute('data-href', url);
      el.setAttribute('role','link');
      el.setAttribute('tabindex','0');
      if (el.__clickBound) return;
      el.__clickBound = true;
      el.addEventListener('click', (e) => {
        if (e.target.closest && e.target.closest('a')) return;
        const to = el.getAttribute('data-href');
        if (to) window.location.href = to;
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const to = el.getAttribute('data-href');
          if (to) window.location.href = to;
        }
      });
      el.addEventListener('mouseenter', () => {
        const to = el.getAttribute('data-href');
        if (!to) return;
        const link = document.createElement('link');
        link.rel = 'prefetch'; link.href = to;
        document.head.appendChild(link);
        setTimeout(()=>link.remove(), 4000);
      });
    }

    /* ---------- Data ---------- */
    let LOAD_ERROR = false;
    async function fetchPostsJson(){
      try{
        const res = await fetch(toRoot('posts.json'), { cache: 'no-store' });
        if (!res.ok) throw new Error('bad status');
        const data = await res.json();
        LOAD_ERROR = false;
        errorState.classList.add('hidden');
        return Array.isArray(data) ? data : null;
      }catch{
        LOAD_ERROR = true;
        errorState.classList.remove('hidden');
        gridEl.classList.add('hidden');
        pager.classList.add('hidden');
        emptyState.classList.add('hidden');
        document.getElementById('heroWrap').classList.add('hidden');
        return null;
      }
    }

    function loadPublishedLocal(){
      const out = [];
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (k && k.startsWith('ctr:admin:published:')) {
          try { const obj = JSON.parse(localStorage.getItem(k)); if (obj && obj.title) out.push(obj); } catch {}
        }
      }
      return out;
    }

    function normalize(p){
      const href = p.url || (p.slug ? `${p.slug}.html` : '#');
      const coverSrc =
        typeof p.cover === 'string'
          ? p.cover
          : (p.cover && p.cover.src ? p.cover.src : '');

      const tagsArr = Array.isArray(p.tags)
        ? p.tags
        : (typeof p.tags === 'string'
            ? p.tags.split(',').map(s => s.trim()).filter(Boolean)
            : []);

      return {
        title:   p.title || '',
        href:    toRoot(href),                              // ← up one level
        section: p.section || '',
        excerpt: p.excerpt || p.description || '',
        date:    p.date || p.publishedAt || '',
        read:    p.readMinutes || '',
        tags:    tagsArr,
        featured: !!p.featured,
        cover:   toRoot(coverSrc || 'images/default-cover.jpg'),
        author:  p.author || 'Camila Tiburcio Rubio'
      };
    }

    let POSTS = [];
    let FEATURED = [];

    /* ---------- Build / Fill ---------- */
    function fillHero(post){
      if (!post) return;
      const heroImg = document.getElementById('heroImg');
      heroImg.src = post.cover || heroImg.src;
      heroImg.alt = post.title || 'Feature hero image';
      document.getElementById('heroTitle').textContent = post.title || '';
      const d = document.getElementById('heroDate'); d.textContent = fmtDate(post.date); d.dateTime = post.date || '';
      document.getElementById('heroExcerpt').textContent = post.excerpt || '';
      document.getElementById('heroRead').textContent = post.read ? `${post.read} min read` : '';
      const href = post.href || '#';
      document.getElementById('heroLink').href = href;

      // HERO TAGS
      const heroTags = document.getElementById('heroTags');
      heroTags.innerHTML = '';
      if (post.tags && post.tags.length){
        heroTags.classList.remove('hidden');
        post.tags.forEach(t => heroTags.appendChild(makeTagChip(t)));
      } else {
        heroTags.classList.add('hidden');
      }

      // Make the ENTIRE hero card clickable
      setStretchedClick(document.getElementById('heroWrap'), href);
    }

    function buildCard(post, terms){
      const tpl = document.getElementById('cardTemplate').content.cloneNode(true);
      const img = tpl.querySelector('img');
      img.src = post.cover; img.alt = `${post.title} cover`;
      img.loading = 'lazy'; img.decoding = 'async';
      img.sizes = '(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw';

      const sectionEl = tpl.querySelector('.sectionLabel');
      sectionEl.textContent = post.section || 'Feature';

      const a = tpl.querySelector('.link');
      a.href = post.href || '#';
      a.textContent = post.title || '';

      const desc = tpl.querySelector('.desc');
      desc.textContent = post.excerpt || '';

      // TAGS (accent chips)
      const tagsWrap = tpl.querySelector('.tagsWrap');
      tagsWrap.innerHTML = '';
      if (post.tags && post.tags.length){
        post.tags.forEach(t => tagsWrap.appendChild(makeTagChip(t)));
      }

      const meta = [];
      if (post.date) meta.push(fmtDate(post.date));
      if (post.read) meta.push(`${post.read} min`);
      tpl.querySelector('.meta').textContent = meta.join(' • ');

      // WHOLE card clickable
      const article = tpl.querySelector('article.card');
      setStretchedClick(article, post.href || '#');

      // inline highlight if needed
      if (terms && terms.length){
        a.innerHTML = highlight(a.textContent, terms);
        desc.innerHTML = highlight(desc.textContent, terms);
      }

      return tpl;
    }

    /* ---------- State ---------- */
    let state = {
      filter: 'all',
      sort: 'new',
      page: 1,
      pageSize: parseInt(pageSizeSel.value,10) || 9,
      q: ''
    };

    function applyFilters(list){
      const norm = s => (s||'').toLowerCase();
      let out = list.slice();

      if (state.filter !== 'all') {
        const f = norm(state.filter);
        out = out.filter(p => norm(p.section) === f || p.tags.some(t => norm(t) === f || norm(t).includes(f)));
      }

      if (state.q) {
        const q = norm(state.q);
        out = out.filter(p =>
          norm(p.title).includes(q) ||
          norm(p.excerpt).includes(q) ||
          p.tags.some(t => norm(t).includes(q))
        );
      }

      out.sort((a,b) => {
        if (state.sort === 'title') return (a.title||'').localeCompare(b.title||'');
        if (state.sort === 'old')   return new Date(a.date||0) - new Date(b.date||0);
        if (state.sort === 'read')  return (a.read||0) - (b.read||0);
        return new Date(b.date||0) - new Date(a.date||0); // 'new'
      });

      return out;
    }

    function render(){
      if (LOAD_ERROR){
        errorState.classList.remove('hidden');
        gridEl.classList.add('hidden');
        pager.classList.add('hidden');
        emptyState.classList.add('hidden');
        return;
      }

      const base = FEATURED; // features page shows ONLY featured posts
      const filtered = applyFilters(base);
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / state.pageSize));
      if (state.page > pages) state.page = pages;

      const start = (state.page - 1) * state.pageSize;
      const pageItems = filtered.slice(start, start + state.pageSize);

      // Grid render
      const terms = state.q.trim() ? state.q.trim().split(/\s+/).filter(Boolean) : [];
      gridEl.innerHTML = '';
      pageItems.forEach(p => gridEl.appendChild(buildCard(p, terms)));

      // Empty state toggle
      const empty = pageItems.length === 0;
      emptyState.classList.toggle('hidden', !empty);
      gridEl.classList.toggle('hidden', empty);

      // Stats / buttons / pager
      pageNumEl.textContent = String(state.page);
      pageTotalEl.textContent = String(pages);
      countShownEl.textContent = String(pageItems.length);
      countTotalEl.textContent = String(total);
      prevBtn.disabled = state.page <= 1;
      nextBtn.disabled = state.page >= pages;
      pager.classList.toggle('hidden', total === 0);

      // Ensure error state hidden when rendering succeeds
      errorState.classList.add('hidden');
    }

    /* ---------- Events ---------- */
    chips.forEach(chip => chip.addEventListener('click', () => {
      chips.forEach(c => { c.dataset.active = 'false'; c.setAttribute('aria-pressed','false'); });
      chip.dataset.active = 'true'; chip.setAttribute('aria-pressed','true');
      state.filter = chip.dataset.filter || 'all';
      state.page = 1;
      render();
    }));

    qInline?.addEventListener('input', (e) => {
      state.q = e.target.value || '';
      state.page = 1;
      render();
    });

    sortSel?.addEventListener('change', () => { state.sort = sortSel.value; state.page = 1; render(); });
    pageSizeSel.addEventListener('change', () => { state.pageSize = parseInt(pageSizeSel.value,10) || 9; state.page = 1; render(); });

    prevBtn.addEventListener('click', () => { state.page = Math.max(1, state.page - 1); render(); });
    nextBtn.addEventListener('click', () => { state.page = state.page + 1; render(); });

    // Empty-state reset
    resetFiltersBtn?.addEventListener('click', () => {
      state = { filter:'all', sort:'new', page:1, pageSize:9, q:'' };
      chips.forEach(c => {
        const on = c.dataset.filter === 'all';
        c.dataset.active = on;
        c.setAttribute('aria-pressed', String(on));
      });
      sortSel.value = 'new';
      qInline.value = '';
      pageSizeSel.value = '9';
      render();
    });

    // Error-state retry
    retryBtn?.addEventListener('click', () => {
      errorState.classList.add('hidden');
      LOAD_ERROR = false;
      init();
    });

    /* ---------- Init ---------- */
    async function init(){
      let data = await fetchPostsJson();

      if (LOAD_ERROR) return; // keep error visible

      if (!data || !data.length){
        const local = loadPublishedLocal();
        if (local.length) data = local;
      }
      if (!data) data = [];

      POSTS = data.map(normalize).sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
      FEATURED = POSTS.filter(p => p.featured);

      if (FEATURED.length) {
        document.getElementById('heroWrap').classList.remove('hidden');
        fillHero(FEATURED[0]); // also makes hero clickable
      } else {
        document.getElementById('heroWrap').classList.add('hidden');
      }

      render();
    }

    init();

    /* ---------- Header search → /search (IDENTICAL binding to Latest) ---------- */
    function goSearch(q){
      const term = (q || '').trim();
      const url = toRoot(term
        ? `search/?q=${encodeURIComponent(term)}`
        : `search/`
      );
      window.location.href = url;
    }

    // Same listeners as latest.html
    document.getElementById('qHeaderBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      goSearch(document.getElementById('q-desktop').value);
    });
    document.getElementById('q-desktop')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        goSearch(e.target.value);
      }
    });
    document.getElementById('q-mobile')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        goSearch(e.target.value);
      }
    });

    /* ---------- Mobile footer accordion ---------- */
    document.querySelectorAll('[data-acc-btn]').forEach(btn => {
      const name = btn.getAttribute('data-acc-btn');
      const panel = document.querySelector(`[data-acc-panel="${name}"]`);
      const chevron = document.querySelector(`[data-acc-chevron="${name}"]`);

      if (!panel) return;

      btn.addEventListener('click', () => {
        const isOpen = !panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!isOpen));

        if (chevron) {
          chevron.classList.toggle('rotate-180', !isOpen);
        }
      });
    });
  </script>
</body>
</html>
