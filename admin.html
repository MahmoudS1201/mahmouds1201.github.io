<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin · Write & Upload Articles — Camila Tiburcio Rubio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400..800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Source Serif 4', 'Georgia', 'serif']
          },
          colors: {
            ink: { 900: '#0E0E0E', 700: '#1F1F1F', 500: '#3A3A3A', 300: '#9CA3AF' },
            cream: '#FAF7F2',
            accent: { DEFAULT: '#C53D2F', dark: '#9E2F24', light: '#E95A49' }
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>
  <style>
    body { -webkit-font-smoothing: antialiased; }
    .u-underline { position: relative; }
    .u-underline::after { content: ''; position: absolute; left: 0; bottom: -2px; height: 2px; width: 100%; background: currentColor; transform: scaleX(0); transform-origin: left; transition: transform .25s ease; }
    .u-underline:hover::after { transform: scaleX(1); }

    .prose h1,.prose h2,.prose h3,.prose h4 { font-family: 'Source Serif 4', Georgia, serif; }
    .prose img{ width:100%; height:480px; object-fit:cover; object-position:center; display:block; border-radius:0.75rem; box-shadow:0 10px 30px rgba(0,0,0,0.06); margin:1.25rem 0;}
    .prose p { margin:0.9em 0; line-height:1.75; }
    .prose .dropcap::first-letter { font-family:'Source Serif 4', Georgia, serif; float:left; font-size:5.2rem; line-height:.9; margin-right:.1rem; font-weight:500; margin-top:-.2rem; color:#C53D2F; }
    .hero-img { width:100%; height:480px; object-fit:cover; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,0.06); }

    .btn { padding:.5rem 1rem; border-radius:.75rem; font-weight:600; border:1px solid rgba(0,0,0,.1); background:#fff; }
    .btn:hover { box-shadow:0 10px 30px rgba(0,0,0,0.06); }

    /* SHARE BAR — force a horizontal row */
    .shareCard{ display:inline-flex; flex-direction:row; align-items:center; gap:14px; width:fit-content; padding:16px 18px; border-radius:9999px; background:#ffffff; border:1px solid rgba(0,0,0,.10); box-shadow:0 10px 30px rgba(0,0,0,.04); margin:0 auto; }
    .shareLabel{ font-weight:700; font-size:.75rem; letter-spacing:.04em; text-transform:uppercase; color:#111; user-select:none; margin-right:2px; }
    .socialContainer{ width:40px; height:40px; border-radius:12px; background:transparent; border:1px solid rgba(0,0,0,.10); color:#3A3A3A; display:flex; align-items:center; justify-content:center; transition:transform .18s ease, background-color .18s ease, border-color .18s ease, color .18s ease; text-decoration:none; cursor:pointer; }
    .socialContainer:hover{ background:rgba(197,61,47,.08); border-color:rgba(197,61,47,.35); color:#C53D2F; transform:translateY(-1px); }
    .socialContainer:active{ transform:scale(.97); }
    .socialContainer svg.fill-icon path { fill: currentColor; }
    .xSvg{ width:16px; height:16px; color:inherit; }
    .socialSvg{ width:18px; height:18px; color:inherit; }
    .clipboard-svg{ width:18px; height:18px; stroke: currentColor; fill:none; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:round; }
    /* Bibliography / citations block in preview */
    .bibliography-section {
      margin-top: 2.5rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(0,0,0,0.08);
      font-size: 0.95rem;
    }

    .bibliography-section h2 {
      font-size: 1.1rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.75rem;
    }

    .bibliography-section ol,
    .bibliography-section ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .bibliography-item {
      position: relative;
      padding-left: 2.25rem;
      margin-bottom: 0.75rem;
      line-height: 1.6;
    }

    /* hanging number */
    .bibliography-item::before {
      content: attr(data-bib-index) ".";
      position: absolute;
      left: 0;
      top: 0;
      width: 1.75rem;
      font-variant-numeric: tabular-nums;
      color: #6B7280;
    }

    /* Accent-colored “flash” for grammar focus */
    .body-highlight {
      border-color: #C53D2F !important; /* accent */
      box-shadow:
        0 0 0 1px rgba(197, 61, 47, 0.7),   /* sharp inner ring */
        0 0 0 4px rgba(197, 61, 47, 0.22);  /* soft outer glow */
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    #body::selection {
      background: rgba(197, 61, 47, 0.16); /* soft accent highlight */
    }

    ::selection {
      background: rgba(197, 61, 47, 0.22);   /* soft accent tint */
      color: inherit;                       /* keep text readable */
    }

    ::-moz-selection {
      background: rgba(197, 61, 47, 0.22);
      color: inherit;
    }

    .grammar-issue {
      cursor: pointer;
    }
    .grammar-issue:hover {
      background: #fdf7f4;
    }

  </style>
  <script>
    (function () {
      try {
        const token = localStorage.getItem('ctr:admin:auth');
        if (token !== 'ok') {
          // Not authenticated → kick back to login
          window.location.href = 'login.html';
        }
      } catch (e) {
        // If anything goes wrong reading storage, also kick out
        window.location.href = 'login.html';
      }
    })();
  </script>
</head>

<div id="draftsDrawer"
     class="fixed inset-0 bg-black/20 backdrop-blur-sm hidden z-50">
  <div class="absolute right-0 top-0 h-full w-[360px] bg-white shadow-xl p-6 overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-serif text-xl">Drafts</h2>
      <button id="closeDraftsBtn" class="text-ink-300 hover:text-ink-900 text-2xl">×</button>
    </div>
    <div id="draftsList" class="space-y-4 text-sm"></div>
  </div>
</div>

<!-- PUBLISHED ARTICLES DRAWER -->
<div id="publishedDrawer"
     class="fixed inset-0 bg-black/20 backdrop-blur-sm hidden z-50">
  <div class="absolute right-0 top-0 h-full w-[420px] bg-white shadow-xl p-6 overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-serif text-xl">Published Articles</h2>
      <button id="closePublishedBtn" class="text-ink-300 hover:text-ink-900 text-2xl">×</button>
    </div>
    <p class="text-xs text-ink-300 mb-3">
      These are live posts from <code>posts.json</code>. Click “Edit” to load one into the editor.
    </p>
    <div id="publishedList" class="space-y-4 text-sm"></div>
  </div>
</div>

<body class="bg-cream text-ink-900 antialiased">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-cream/80 bg-cream/95 border-b border-black/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-1">
        <a href="index.html" class="flex items-center gap-2" aria-label="Home">
          <img src="assets/logo.png" alt="Camila Tiburcio Rubio logo" class="h-12 w-12 object-contain" />
          <span class="font-serif text-2xl tracking-tight">Camila Tiburcio Rubio</span>
        </a>
      </div>
      <nav class="hidden md:flex items-center gap-3 text-sm">
        <!-- <button id="openDraftsBtn" class="btn">Drafts</button>
        <button id="openPublishedBtn" class="btn">Published</button> -->
        <button id="importJsonBtn" class="btn">Import JSON</button>
        <button id="exportJsonBtn" class="btn bg-accent text-white border-transparent hover:bg-accent-dark">Export JSON</button> 
        <button id="exportHtmlBtn" class="btn">Export HTML</button>
        <button id="clearDraftBtn" class="btn">Clear Draft</button>
        <button id="logoutBtn" class="btn text-sm">Log out</button>

        <span
        id="changeIndicator"
        class="ml-4 inline-flex items-center gap-2 text-xs text-ink-300">
        <span
          id="changeDot"
          class="h-2 w-2 rounded-full bg-emerald-500"></span>
        <span id="changeText">All changes saved</span>
      </span>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Form -->
      <section class="bg-white shadow-soft rounded-2xl p-6 lg:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-serif text-xl">Write Article</h2>

          <div class="flex gap-2">
            <button id="openDraftsBtn"
              type="button"
              class="px-4 py-1.5 rounded-full border border-black/10 text-xs font-medium text-ink-600 hover:bg-ink-50">
              Drafts
            </button>

            <button id="openPublishedBtn"
              type="button"
              class="px-4 py-1.5 rounded-full border border-black/10 text-xs font-medium text-ink-600 hover:bg-ink-50">
              Published
            </button>
          </div>
        </div>
        <form id="articleForm" class="space-y-6" onsubmit="return false;">
          <div class="grid sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm font-medium">Title</span>
              <input id="title" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40" placeholder="The Inefficiency of Efficie..." />
            </label>
            <label class="block">
              <span class="text-sm font-medium">Slug</span>
              <input id="slug" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40" placeholder="auto-generated" />
            </label>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm font-medium">Section</span>
              <select id="section" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40">
                <option>Essay</option>
                <option>Interview</option>
                <option>Review</option>
                <option>Visual</option>
                <option>Community</option>
                <option>Memoirs</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm font-medium">Tags (comma-separated)</span>
              <input id="tags" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40" placeholder="Diaspora, Cuba, Art" />
            </label>
          </div>

          <div class="grid sm:grid-cols-3 gap-4">
            <label class="block">
              <span class="text-sm font-medium">Author</span>
              <input id="author" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40" placeholder="Camila Tiburcio Rubio" />
            </label>
            <label class="block">
              <span class="text-sm font-medium">Publish date</span>
              <input id="date" type="datetime-local" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40" />
            </label>
            <label class="block">
              <span class="text-sm font-medium">Read time (auto)</span>
              <input id="readTime" readonly class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 bg-cream/60" />
            </label>
          </div>

          <label class="block">
            <span class="text-sm font-medium">Excerpt</span>
            <textarea id="excerpt" rows="3" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40" placeholder="Stories of the growing popularity of efficiency homes in Miami..."></textarea>
          </label>

          <!-- Cover image uploader -->
          <div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">Cover image</span>
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" id="featured" class="rounded"/> Featured
              </label>
            </div>
            <div id="dropzone" class="mt-2 border-2 border-dashed border-black/10 rounded-2xl p-6 text-center bg-cream/50">
              <p class="text-sm text-ink-500">Drag & drop an image here, or <label for="coverInput" class="u-underline cursor-pointer">browse</label></p>
              <input id="coverInput" type="file" accept="image/*" class="hidden" />
              <div id="coverPreview" class="hidden mt-4 relative">
                <img id="coverImg" class="w-full max-h-64 object-cover rounded-xl"/>
                <button type="button" id="removeCover" class="absolute top-2 right-2 bg-white/90 rounded-full px-3 py-1 text-sm border border-black/10">Remove</button>
                <input id="coverAlt" class="mt-2 w-full px-3 py-2 rounded-xl border border-black/10" placeholder="Alt text (accessibility)" />
              </div>
            </div>
          </div>

              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium">Body Editor</span>
                  <div class="flex gap-2 text-sm">
                    <button type="button" data-md="HEADER_SECTION" class="btn">Header</button>
                    <button type="button" data-md="**bold**" class="btn">B</button>
                    <button type="button" data-md="*italic*" class="btn"><em>I</em></button>
                    <button type="button" data-md="> " class="btn">Quote</button>
                    <button type="button" data-md="- list item" class="btn">List</button>
                    <button type="button" data-md="1. " class="btn">OL</button>
                    <button type="button" id="insertImageBtn" class="btn">Insert img</button>
                  </div>
                </div>

                <!-- Outline panel (Body Editor Outline) -->
                <div class="mt-4">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-medium text-ink-700">Outline</span>
                    <button
                      type="button"
                      id="outlineToggle"
                      class="text-[11px] text-ink-300 hover:text-ink-500">
                      Hide outline
                    </button>
                  </div>
                  <div
                    id="outlinePanel"
                    class="max-h-52 overflow-y-auto rounded-xl border border-black/5 bg-white px-3 py-2 text-xs">
                    <p class="text-[11px] text-ink-300">
                      Add headings (#, ##, ###) in the body to see an outline.
                    </p>
                  </div>
                </div>

                <!-- Wrapper makes it possible to “float” buttons inside the box -->
                <div class="relative">
                  <textarea
                    id="body"
                    rows="14"
                    class="w-full px-3 py-3 pr-16 rounded-xl border border-black/10 outline-none focus:ring-2 focus:ring-accent/40"
                    placeholder="Write or paste your text here..."
                    spellcheck="true"
                    autocapitalize="sentences"
                    autocomplete="off"></textarea>

                  <!-- Undo / Redo visually inside top-right of the textarea -->
                  <div class="absolute top-2 right-2 flex gap-1 pointer-events-none">
                    <button
                      type="button"
                      id="undoBtn"
                      class="btn px-2 py-1 text-xs pointer-events-auto"
                      title="Undo">
                      ⟲
                    </button>
                    <button
                      type="button"
                      id="redoBtn"
                      class="btn px-2 py-1 text-xs pointer-events-auto"
                      title="Redo">
                      ⟳
                    </button>
                  </div>
                </div>

                <!-- (optional) grammar button + stats + panel go here -->
                <div class="flex items-center justify-between mt-2">
                  <button
                    type="button"
                    id="checkTextBtn"
                    class="btn px-3 py-1 text-xs">
                    Check spelling &amp; grammar
                  </button>
                  <span id="bodyStats" class="text-[11px] text-ink-300"></span>
                </div>

                <div
                  id="grammarPanel"
                  class="mt-2 text-xs text-ink-500 space-y-1 hidden bg-cream/60 border border-dashed border-black/10 rounded-xl p-3">
                </div>

                <input id="inlineImageInput" type="file" accept="image/*" class="hidden" />
              </div>

          <!-- SEO -->
          <details class="rounded-xl border border-black/10 p-4 bg-cream/60">
            <summary class="cursor-pointer font-medium">SEO (optional)</summary>
            <div class="grid sm:grid-cols-2 gap-4 mt-4">
              <label class="block">
                <span class="text-sm font-medium">Meta title</span>
                <input id="metaTitle" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10" />
              </label>
              <label class="block sm:col-span-2">
                <span class="text-sm font-medium">Meta description</span>
                <textarea id="metaDesc" rows="2" class="mt-1 w-full px-3 py-2 rounded-xl border border-black/10"></textarea>
              </label>
            </div>
          </details>

          <!-- Actions Row (Full Width Buttons) -->
          <div class="mt-6 flex flex-col gap-3">

            <!-- Full-width secondary actions -->
            <button
              type="button"
              id="saveDraftBtn"
              class="w-full px-4 py-3 rounded-xl border border-black/10 bg-white text-sm text-ink-700 hover:bg-cream/60 transition">
              Save Draft (local)
            </button>

            <button
              type="button"
              id="previewBtn"
              class="w-full px-4 py-3 rounded-xl border border-black/10 bg-white text-sm text-ink-700 hover:bg-cream/60 transition">
              Refresh Preview
            </button>

            <button
              type="button"
              id="previewTabBtn"
              class="w-full px-4 py-3 rounded-xl border border-black/10 bg-white text-sm text-ink-700 hover:bg-cream/60 transition">
              Preview in New Tab
            </button>

            <!-- Primary action: full-width accent button -->
            <button
              type="button"
              id="publishBtn"
              class="w-full px-4 py-3 rounded-xl bg-accent text-white text-sm font-semibold shadow-sm hover:bg-accent/90 transition">
              Mark as Published
            </button>

          </div>
          <p id="statusMsg" class="text-sm text-ink-300"></p>
        </form>
      </section>

      <!-- Preview -->
      <section class="bg-white shadow-soft rounded-2xl p-0 overflow-hidden">
        <div id="previewCover" class="aspect-[16/9] bg-ink-900/5 flex items-center justify-center text-ink-300">Cover preview</div>
        <div class="p-6 lg:p-8">
          <div class="flex items-center gap-3 text-xs uppercase tracking-wide text-accent">
            <span id="previewSection" class="bg-accent/10 text-accent px-2.5 py-1 rounded-full">Essay</span>
            <time id="previewDate" class="text-ink-300"></time>
          </div>
          <h1 id="previewTitle" class="font-serif text-3xl lg:text-4xl mt-3 leading-tight">Title…</h1>
          <p id="previewExcerpt" class="text-ink-500 mt-3 max-w-2xl">Excerpt…</p>
          <div class="mt-6 flex items-center gap-4">
            <div class="h-10 w-10 rounded-full bg-ink-300 overflow-hidden">
              <img src="assets/camila.jpg" alt="" class="w-full h-full object-cover"/>
            </div>
            <div>
              <p class="text-sm font-medium">By <span id="previewAuthor">Author</span></p>
              <p class="text-xs text-ink-300"><span id="previewRead">0</span> min read</p>
            </div>
          </div>
          <article id="previewBody" class="prose prose-neutral mt-6 max-w-none"></article>
        </div>
      </section>
    </div>
  </main>

  <input id="jsonFileInput" type="file" accept="application/json" class="hidden" />

   <div id="publishModal"
       class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-2xl shadow-soft max-w-sm w-full mx-4 p-6 text-center">
      <div class="mx-auto mb-3 h-10 w-10 rounded-full bg-accent/10 flex items-center justify-center">
        <span class="text-accent text-2xl">✓</span>
      </div>
      <h2 class="font-serif text-xl mb-2">Article published</h2>
      <p class="text-sm text-ink-500 mb-4">
        Your article has been committed to GitHub. It may take a moment to appear live.
      </p>
      <button id="publishModalClose"
              class="btn bg-accent text-white border-transparent hover:bg-accent-dark w-full">
        Got it
      </button>
    </div>
  </div>

  <script>
    /* =========================
       Utilities
    ========================= */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function insertAtCursor(el, before, after = null, opts = { selectInside: false }) {
      const start = el.selectionStart ?? 0;
      const end   = el.selectionEnd ?? start;
      const hadSel = start !== end;
      const prevScroll = el.scrollTop;

      let insert;
      if (after !== null && hadSel) {
        const selected = el.value.slice(start, end);
        insert = before + selected + after;
        el.setRangeText(insert, start, end, 'select');
        const newStart = start + before.length;
        const newEnd   = newStart + selected.length;
        requestAnimationFrame(() => {
          el.focus({ preventScroll: true });
          if (opts.selectInside) el.setSelectionRange(newStart, newEnd);
          else                   el.setSelectionRange(newEnd, newEnd);
          el.scrollTop = prevScroll;
        });
      } else {
        insert = before;
        el.setRangeText(insert, start, end, 'end');
        const pos = start + insert.length;
        requestAnimationFrame(() => {
          el.focus({ preventScroll: true });
          el.setSelectionRange(pos, pos);
          el.scrollTop = prevScroll;
        });
      }
    }

    function slugify(str) {
      return (str || '')
        .toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .replace(/[^a-z0-9\s-]/g,'')
        .trim().replace(/\s+/g,'-')
        .replace(/-+/g,'-');
    }

    function wordsCount(text) {
      return (text || '').trim().split(/\s+/).filter(Boolean).length;
    }

    function estimateReadMinutes(text) {
      const wpm = 225;
      const words = wordsCount(text);
      return Math.max(1, Math.round(words / wpm));
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Tiny Markdown -> HTML (single, non-conflicting pass)
    function md(str = '') {
      let s = (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;');

      // code blocks
      s = s.replace(/```([\s\S]*?)```/g, (m, code) =>
        `<pre class="bg-cream p-4 rounded-xl overflow-auto"><code>${code.replace(/\n/g,'<br/>')}</code></pre>`
      );

      // inline code
      s = s.replace(/`([^`]+)`/g, '<code class="bg-cream px-1 rounded">$1</code>');

      // images (with optional caption line after)
      s = s.replace(/!\[([^\]]*)\]\(([^\)]+)\)(?:\n\*([^\n]+)\*)?/g, (m, alt, src, caption) => {
        if (caption) {
          return `<figure><img src="${src}" alt="${alt}"><figcaption class="text-center text-sm text-ink-300 mt-2">${caption.trim()}</figcaption></figure>`;
        }
        return `<figure><img src="${src}" alt="${alt}"></figure>`;
      });

      // links
      s = s.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a class="u-underline" href="$2">$1</a>');

      // bold + italic
      s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/\*([^*]+)\*/g, '<em>$1</em>');

      // headers
      s = s.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
      s = s.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
      s = s.replace(/^#\s+(.+)$/gm,  '<h1>$1</h1>');

      // blockquotes with optional last-line attribution
      s = s.replace(/(^|\n)(>(?:[^\n]*)(?:\n>.*)*)/g, (_, lead, block) => {
        const lines = block.trim().split(/\n/).map(l => l.replace(/^>\s?/, '').trim());
        const quote = lines.slice(0, -1).join('<br/>');
        const last = lines[lines.length - 1];
        const isAttr = /^[-–—]\s?/.test(last);
        const attribution = isAttr ? `<cite class="quote-cite">${last.replace(/^[-–—]\s?/, '')}</cite>` : '';
        const content = isAttr ? quote : lines.join('<br/>');
        return `${lead}<blockquote>${content}${attribution}</blockquote>`;
      });

      // unordered lists
      s = s.replace(/(?:^|\n)(-\s+.+(?:\n-\s+.+)*)/g, (m) => {
        const items = m.trim().split(/\n/).map(l => l.replace(/^-+\s+/, '').trim());
        return '<ul class="list-disc pl-6">' + items.map(i => `<li>${i}</li>`).join('') + '</ul>';
      });

      // paragraphs
      const BLOCK_RE = /^<(?:h[1-6]|ul|ol|li|pre|code|blockquote|img|figure|p)(\s|>)/i;
      s = s
        .split(/\n\s*\n/)
        .map(chunk => chunk.trim())
        .filter(Boolean)
        .map(chunk => BLOCK_RE.test(chunk) ? chunk : `<p>${chunk.replace(/\n/g,'<br/>')}</p>`)
        .join('\n');

      return s;
    }

    /* =========================
       Elements
    ========================= */
    const titleEl = $('#title');
    const slugEl = $('#slug');
    const sectionEl = $('#section');
    const tagsEl = $('#tags');
    const authorEl = $('#author');
    const dateEl = $('#date');
    const readEl = $('#readTime');
    const excerptEl = $('#excerpt');
    const bodyEl = $('#body');
    const featuredEl = $('#featured');
    const metaTitleEl = $('#metaTitle');
    const metaDescEl = $('#metaDesc');

    // Cover controls
    const dropzone = $('#dropzone');
    const coverInput = $('#coverInput');
    const coverPreview = $('#coverPreview');
    const coverImg = $('#coverImg');
    const coverAlt = $('#coverAlt');
    const removeCoverBtn = $('#removeCover');

    // Preview nodes
    const previewCover = $('#previewCover');
    const previewSection = $('#previewSection');
    const previewDate = $('#previewDate');
    const previewTitle = $('#previewTitle');
    const previewExcerpt = $('#previewExcerpt');
    const previewAuthor = $('#previewAuthor');
    const previewRead = $('#previewRead');
    const previewBody = $('#previewBody');

    const statusMsg = $('#statusMsg');

        // Track changes indicator
    const changeIndicator = $('#changeIndicator');
    const changeDot       = $('#changeDot');
    const changeText      = $('#changeText');
    let isDirty = false;

    function setDirtyState(dirty) {
      isDirty = dirty;
      if (!changeIndicator || !changeDot || !changeText) return;

      changeIndicator.classList.remove('hidden');

      if (dirty) {
        changeDot.classList.remove('bg-emerald-500', 'bg-ink-300');
        changeDot.classList.add('bg-accent'); // accent when unsaved
        changeText.textContent = 'Unsaved changes';
        changeIndicator.classList.remove('text-ink-300');
        changeIndicator.classList.add('text-accent');
      } else {
        changeDot.classList.remove('bg-accent');
        changeDot.classList.add('bg-emerald-500'); // green when saved
        changeText.textContent = 'All changes saved';
        changeIndicator.classList.remove('text-accent');
        changeIndicator.classList.add('text-ink-300');
      }
    }

    function markDirty() {
      if (!isDirty) setDirtyState(true);
    }

    function markClean() {
      setDirtyState(false);
    }

    const articleForm = $('#articleForm');
    if (articleForm) {
      // Any user edit marks the form as dirty
      articleForm.addEventListener('input', markDirty);
      articleForm.addEventListener('change', markDirty);
    }


        /* =========================
       Spellcheck + grammar assist
    ========================= */
    const checkTextBtn  = $('#checkTextBtn');
    const grammarPanel  = $('#grammarPanel');
    const bodyStatsSpan = $('#bodyStats');

    function updateBodyStats() {
      const text  = bodyEl.value || '';
      const words = (text.trim().match(/\S+/g) || []).length;
      const chars = text.length;
      const mins  = estimateReadMinutes(text);
      if (bodyStatsSpan) {
        bodyStatsSpan.textContent = `${words} words • ${chars} chars • ~${mins} min read`;
      }
    }

    function runGrammarAssist() {
      const text = bodyEl.value || '';
      const issues = [];

      // 1) Very long sentences (over ~40 words)
      const sentenceRegex = /[^.!?]+[.!?]+/g;
      let match;
      while ((match = sentenceRegex.exec(text)) !== null) {
        const sentence = match[0];
        const start = match.index;
        const end = start + sentence.length;
        const words = (sentence.trim().match(/\S+/g) || []).length;

        if (words > 40) {
          issues.push({
            type: 'Long sentence',
            detail: `This sentence is ${words} words. Consider splitting it.`,
            snippet: sentence.slice(0, 140) + (sentence.length > 140 ? '…' : ''),
            start,
            end
          });
        }
      }

      // 2) Repeated words: "the the"
      const repeatRegex = /\b(\w+)\s+\1\b/gi;
      while ((match = repeatRegex.exec(text)) !== null) {
        const start = match.index;
        const end = start + match[0].length;
        const snippet = text.slice(
          Math.max(0, start - 40),
          Math.min(text.length, end + 40)
        ).trim();

        issues.push({
          type: 'Repeated word',
          detail: `The word “${match[1]}” appears twice in a row.`,
          snippet,
          start,
          end
        });
      }

      // 3) Double spaces
      const doubleSpaceRegex = / {2,}/g;
      while ((match = doubleSpaceRegex.exec(text)) !== null) {
        const start = match.index;
        const end = start + match[0].length;
        const snippet = text.slice(
          Math.max(0, start - 30),
          Math.min(text.length, end + 30)
        ).trim();

        issues.push({
          type: 'Extra spaces',
          detail: 'Found multiple spaces together.',
          snippet,
          start,
          end
        });
      }

      // 4) Punctuation followed by no space (",word", ".word")
      const punctNoSpaceRegex = /([.,;:!?])([^\s\d])/g;
      while ((match = punctNoSpaceRegex.exec(text)) !== null) {
        const start = match.index;
        const end = start + match[0].length;
        const snippet = text.slice(
          Math.max(0, start - 30),
          Math.min(text.length, end + 30)
        ).trim();

        issues.push({
          type: 'Missing space',
          detail: `There may be a missing space after “${match[1]}”.`,
          snippet,
          start,
          end
        });
      }

      if (!grammarPanel) return;

      if (!issues.length) {
        grammarPanel.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <p class="text-ink-400 text-xs">
              No obvious grammar issues found. Spelling is still handled by your browser — look for red underlines.
            </p>
            <button
              type="button"
              id="grammarCloseBtn"
              class="text-[11px] px-2 py-1 rounded-full border border-black/10 hover:bg-ink-50">
              Close
            </button>
          </div>
        `;
        grammarPanel.classList.remove('hidden');

        const closeBtn = document.getElementById('grammarCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            grammarPanel.classList.add('hidden');
          });
        }
        return;
      }


      // Render clickable issue blocks with data-start/end
      // Render clickable issue blocks with data-start/end + Close button
      grammarPanel.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-[11px] font-semibold uppercase tracking-[0.14em] text-ink-400">
            Grammar check
          </span>
          <button
            type="button"
            id="grammarCloseBtn"
            class="text-[11px] px-2 py-1 rounded-full border border-black/10 hover:bg-ink-50">
            Close
          </button>
        </div>
        ${issues.map(issue => `
          <button
            type="button"
            class="grammar-issue w-full text-left border border-black/10 rounded-lg bg-white px-3 py-2 mb-1"
            data-start="${issue.start}"
            data-end="${issue.end}">
            <div class="flex items-center justify-between mb-1">
              <span class="font-semibold text-[11px] uppercase tracking-[0.14em] text-accent">
                ${issue.type}
              </span>
            </div>
            <p class="text-[11px] text-ink-500 mb-1">${issue.detail}</p>
            <p class="text-[11px] text-ink-400 italic">“${issue.snippet.replace(/"/g, '&quot;')}”</p>
          </button>
        `).join('')}
      `;

      grammarPanel.classList.remove('hidden');

      // Wire click handlers to highlight/select text in the editor
      grammarPanel.querySelectorAll('.grammar-issue').forEach(btn => {
        btn.addEventListener('click', () => {
          const start = parseInt(btn.getAttribute('data-start'), 10) || 0;
          const end = parseInt(btn.getAttribute('data-end'), 10) || start;

          bodyEl.focus();
          bodyEl.setSelectionRange(start, end);

          bodyEl.classList.add('body-highlight');
          setTimeout(() => {
            bodyEl.classList.remove('body-highlight');
          }, 400);
        });
      });

      // Wire close button
      const closeBtn = document.getElementById('grammarCloseBtn');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          grammarPanel.classList.add('hidden');
        });
      }


      // Wire click handlers to highlight/select text in the editor
      grammarPanel.querySelectorAll('.grammar-issue').forEach(btn => {
        btn.addEventListener('click', () => {
          const start = parseInt(btn.getAttribute('data-start'), 10) || 0;
          const end = parseInt(btn.getAttribute('data-end'), 10) || start;

          bodyEl.focus();
          bodyEl.setSelectionRange(start, end);

          const text = bodyEl.value || '';
          const ratio = text.length ? start / text.length : 0;
          const maxScroll = bodyEl.scrollHeight - bodyEl.clientHeight;
          const targetScroll = Math.max(0, Math.min(maxScroll, ratio * maxScroll));

          bodyEl.scrollTo({
            top: targetScroll,
            behavior: 'smooth'
          });

          // Briefly highlight the textarea so it's obvious
          bodyEl.classList.add('body-highlight');
          setTimeout(() => {
            bodyEl.classList.remove('body-highlight');
          }, 400);
        });
      });
    }

    if (checkTextBtn) {
      checkTextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        runGrammarAssist();
      });
    }

        /* =========================
       Undo / Redo for Body Editor
    ========================= */
    let undoStack = [];
    let redoStack = [];
    let isApplyingHistory = false;

    function getBodySnapshot() {
      return {
        value: bodyEl.value,
        selectionStart: bodyEl.selectionStart ?? 0,
        selectionEnd: bodyEl.selectionEnd ?? 0,
      };
    }

    function pushSnapshot() {
      if (isApplyingHistory) return;
      const snap = getBodySnapshot();
      const last = undoStack[undoStack.length - 1];

      // Avoid duplicates
      if (
        last &&
        last.value === snap.value &&
        last.selectionStart === snap.selectionStart &&
        last.selectionEnd === snap.selectionEnd
      ) {
        return;
      }

      undoStack.push(snap);
      if (undoStack.length > 100) undoStack.shift(); // cap history
      redoStack.length = 0; // clear redo on new edits
    }

    function applySnapshot(snap) {
      if (!snap) return;
      isApplyingHistory = true;
      bodyEl.value = snap.value;

      requestAnimationFrame(() => {
        bodyEl.focus({ preventScroll: true });
        bodyEl.setSelectionRange(snap.selectionStart, snap.selectionEnd);
        isApplyingHistory = false;
        updateDerived();
      });
    }

    function undoBody() {
      if (undoStack.length < 2) return;
      // Current state → redo
      const current = undoStack.pop();
      redoStack.push(current);
      const prev = undoStack[undoStack.length - 1];
      applySnapshot(prev);
    }

    function redoBody() {
      if (!redoStack.length) return;
      const snap = redoStack.pop();
      undoStack.push(snap);
      applySnapshot(snap);
    }

    const undoBtn = $('#undoBtn');
    const redoBtn = $('#redoBtn');

    if (undoBtn) {
      undoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        undoBody();
      });
    }
    if (redoBtn) {
      redoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        redoBody();
      });
    }

    // Keyboard shortcuts: Cmd/Ctrl+Z and Cmd/Ctrl+Shift+Z
    bodyEl.addEventListener('keydown', (e) => {
      const mod = e.metaKey || e.ctrlKey;
      if (!mod) return;

      if (e.key.toLowerCase() === 'z' && !e.shiftKey) {
        e.preventDefault();
        undoBody();
      } else if ((e.key.toLowerCase() === 'z' && e.shiftKey) || e.key.toLowerCase() === 'y') {
        e.preventDefault();
        redoBody();
      }
    });


    const publishModal = $('#publishModal');
    const publishModalClose = $('#publishModalClose');

    function openPublishModal() {
      if (!publishModal) return;
      publishModal.classList.remove('hidden');
      publishModal.classList.add('flex');
    }

    function closePublishModal() {
      if (!publishModal) return;
      publishModal.classList.add('hidden');
      publishModal.classList.remove('flex');

      setTimeout(() => {
        location.reload();
      }, 50);
    }

    if (publishModalClose) {
      publishModalClose.addEventListener('click', closePublishModal);
    }

    // click on the dark backdrop closes it too
    if (publishModal) {
      publishModal.addEventListener('click', (e) => {
        if (e.target === publishModal) closePublishModal();
      });
    }


    /* =========================
       Toolbar buttons
    ========================= */
    $$('#articleForm [data-md]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const token = btn.getAttribute('data-md');

        if (token === '**bold**') {
          insertAtCursor(bodyEl, '**', '**', { selectInside: true });
        } 
        else if (token === '*italic*') {
          insertAtCursor(bodyEl, '*', '*', { selectInside: true });
        } 
        else if (token === 'HEADER_SECTION') {
          const start = bodyEl.selectionStart ?? 0;
          const end   = bodyEl.selectionEnd ?? start;
          const hadSel = start !== end;
          const prevScroll = bodyEl.scrollTop;

          if (hadSel) {
            const selected = bodyEl.value.slice(start, end).replace(/\n+/g, ' ').trim();
            const v     = bodyEl.value;
            const atBOL = start === 0 || v[start - 1] === '\n';
            const prefix = (atBOL ? '' : '\n') + '## ';
            const insert = `${prefix}${selected}\n\n`;
            bodyEl.setRangeText(insert, start, end, 'end');

            requestAnimationFrame(() => {
              bodyEl.focus({ preventScroll: true });
              bodyEl.scrollTop = prevScroll;
              const caretPos = start + insert.length;
              bodyEl.setSelectionRange(caretPos, caretPos);
            });
          } else {
            const v     = bodyEl.value;
            const pos   = bodyEl.selectionStart ?? 0;
            const atBOL = pos === 0 || v[pos - 1] === '\n';
            const line  = '## Section title';
            const tmpl  = (atBOL ? '' : '\n') + line + '\n\n';

            insertAtCursor(bodyEl, tmpl);
            requestAnimationFrame(() => {
              bodyEl.focus({ preventScroll: true });
              bodyEl.scrollTop = prevScroll;
              const base = pos + (atBOL ? 0 : 1);
              const selStart = base + 3;
              const selEnd   = selStart + 'Section title'.length;
              bodyEl.setSelectionRange(selStart, selEnd);
            });
          }
        }
        else if (token === '> ') {
          const start = bodyEl.selectionStart ?? 0;
          const end   = bodyEl.selectionEnd ?? start;
          const hadSel = start !== end;
          const prevScroll = bodyEl.scrollTop;

          if (hadSel) {
            const selected = bodyEl.value.slice(start, end);
            const quoted   = selected.split('\n').map(l => '> ' + l).join('\n');
            const insert   = quoted + '\n>\n> - Attribution';
            bodyEl.setRangeText(insert, start, end, 'end');

            requestAnimationFrame(() => {
              bodyEl.focus({ preventScroll: true });
              bodyEl.scrollTop = prevScroll;
              const caretPos = start + insert.length - ' Attribution'.length - 2;
              bodyEl.setSelectionRange(caretPos, caretPos);
            });
          } else {
            const tmpl = '> Quote\n>\n> - Attribution\n';
            const v     = bodyEl.value;
            const pos   = bodyEl.selectionStart ?? 0;
            const atBOL = pos === 0 || v[pos - 1] === '\n';
            const text  = (atBOL ? '' : '\n') + tmpl;

            insertAtCursor(bodyEl, text);
            requestAnimationFrame(() => {
              bodyEl.focus({ preventScroll: true });
              bodyEl.scrollTop = prevScroll;
              const base = pos + (atBOL ? 0 : 1);
              const quoteStartOffset = 2;
              const quoteEndOffset   = quoteStartOffset + 'Quote'.length;
              bodyEl.setSelectionRange(base + quoteStartOffset, base + quoteEndOffset);
            });
          }
        }
        else if (token === '1. ') {
          const start = bodyEl.selectionStart ?? 0;
          const end   = bodyEl.selectionEnd ?? start;
          const hadSel = start !== end;
          const prevScroll = bodyEl.scrollTop;

          if (hadSel) {
            const selected = bodyEl.value.slice(start, end).replace(/\s+$/,'');
            const lines = selected.split('\n');

            let idx = 1;
            const numbered = lines.map(l => {
              if (l.trim().length === 0) return '';
              return `${idx++}. ${l.replace(/^\d+\.\s+/, '')}`;
            }).join('\n');

            bodyEl.setRangeText(numbered, start, end, 'end');

            requestAnimationFrame(() => {
              bodyEl.focus({ preventScroll: true });
              bodyEl.scrollTop = prevScroll;
              const caretPos = start + numbered.length;
              bodyEl.setSelectionRange(caretPos, caretPos);
            });
          } else {
            const pos   = bodyEl.selectionStart ?? 0;
            const v     = bodyEl.value;
            const atBOL = pos === 0 || v[pos - 1] === '\n';
            const text  = (atBOL ? '' : '\n') + '1. ';
            insertAtCursor(bodyEl, text);
          }
        }
        else if (token === '# ' || token === '## ' || token === '- list item') {
          const pos   = bodyEl.selectionStart ?? 0;
          const v     = bodyEl.value;
          const atBOL = pos === 0 || v[pos - 1] === '\n';
          const text  = (atBOL ? '' : '\n') + token;
          insertAtCursor(bodyEl, text);
        } 
        else {
          insertAtCursor(bodyEl, token + (token.endsWith(' ') ? '' : '\n'));
        }

        updateDerived();
      });
    });

    /* =========================
       Inline image insertion
    ========================= */
    let inlineImageStore = {}; // token -> dataURL

    $('#insertImageBtn').addEventListener('click', () => $('#inlineImageInput').click());
    $('#inlineImageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const b64 = await toBase64(file);
      const alt = prompt('Alt text for image?') || '';

      const id = (crypto?.randomUUID && crypto.randomUUID()) || ('img-' + Date.now());
      inlineImageStore[id] = b64;

      const mdImg = `![${alt}](ctr-img:${id})\n*Insert caption here*`;
      insertAtCursor(bodyEl, '\n' + mdImg + '\n');

      updateDerived();
      e.target.value = '';
    });

    function expandInlineImages(markdown='') {
      return markdown.replace(/\((ctr-img:([a-z0-9-]+))\)/gi, (m, full, id) => {
        return `(${inlineImageStore[id] || full})`;
      });
    }

    /* =========================
       Cover upload / drag
    ========================= */
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('bg-white'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('bg-white'));
    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault(); dropzone.classList.remove('bg-white');
      const file = e.dataTransfer.files[0]; if (file) await setCover(file);
    });
    coverInput.addEventListener('change', async (e) => { const f = e.target.files[0]; if (f) await setCover(f); });
    removeCoverBtn.addEventListener('click', () => { coverImg.src=''; coverPreview.classList.add('hidden'); previewCover.innerHTML='Cover preview'; });

    async function setCover(file){
      const b64 = await toBase64(file);
      coverImg.src = b64; coverPreview.classList.remove('hidden');
      previewCover.innerHTML = `<img class="w-full h-full object-cover" src="${b64}" alt="">`;
    }

    /* =========================
       Derived preview values
    ========================= */
    titleEl.addEventListener('input', () => { if(!slugEl.dataset.touched){ slugEl.value = slugify(titleEl.value); } updateDerived(); });
    slugEl.addEventListener('input', () => { slugEl.dataset.touched = '1'; });
    /* === Word-based undo batching + live preview === */
    let typingTimer;
    let lastValue = "";

    function scheduleSnapshot() {
      if (bodyEl.value === lastValue) return;
      pushSnapshot();
      lastValue = bodyEl.value;
    }

    /* =========================
       Outline mode
    ========================= */

    const outlinePanel  = $('#outlinePanel');
    const outlineToggle = $('#outlineToggle');

    function buildOutline(markdown = '') {
      const lines = markdown.split('\n');
      const outline = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const m = /^(#{1,3})\s+(.+)$/.exec(line); // #, ##, ### headings only
        if (!m) continue;

        outline.push({
          level: m[1].length,     // 1, 2, 3
          text: m[2].trim(),
          lineIndex: i
        });
      }

      return outline;
    }

    // Move cursor to the start of a given line in the textarea
    function jumpToLine(lineIndex) {
      if (!bodyEl) return;

      const text  = bodyEl.value || '';
      const lines = text.split('\n');

      let pos = 0;
      for (let i = 0; i < lineIndex && i < lines.length; i++) {
        pos += lines[i].length + 1; // +1 for the newline
      }

      bodyEl.focus({ preventScroll: true });
      bodyEl.setSelectionRange(pos, pos);

      // Rough scroll into view: scroll based on position ratio
      const ratio = text.length ? pos / text.length : 0;
      bodyEl.scrollTop = ratio * (bodyEl.scrollHeight - bodyEl.clientHeight);
    }

    function renderOutline() {
      if (!outlinePanel || !bodyEl) return;

      const outline = buildOutline(bodyEl.value || '');

      if (!outline.length) {
        outlinePanel.innerHTML = `
          <p class="text-[11px] text-ink-300">
            Add headings (#, ##, ###) in the body to see an outline.
          </p>
        `;
        return;
      }

      outlinePanel.innerHTML = outline.map(item => {
        const indent =
          item.level === 1 ? '' :
          item.level === 2 ? 'ml-3' :
                             'ml-6';
        const size = item.level === 1 ? 'text-[13px]' : 'text-[11px]';

        return `
          <button
            type="button"
            class="outline-item block w-full truncate ${indent} ${size} py-1 text-left
                   text-ink-600 hover:text-accent"
            data-line="${item.lineIndex}">
            ${item.text.replace(/"/g, '&quot;')}
          </button>
        `;
      }).join('');

      // hook up click → jump to that heading
      outlinePanel.querySelectorAll('.outline-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.line, 10);
          if (!Number.isNaN(idx)) jumpToLine(idx);
        });
      });
    }

    // Toggle show/hide
    if (outlineToggle && outlinePanel) {
      outlineToggle.addEventListener('click', () => {
        const isHidden = outlinePanel.classList.toggle('hidden');
        outlineToggle.textContent = isHidden ? 'Show outline' : 'Hide outline';
      });
    }

    bodyEl.addEventListener('input', (e) => {
      // always update preview + stats on input
      updateDerived();
      renderOutline();

      const key = e.data;

      // If pressing space, Enter, or performing an action that yields no char (deletes, paste etc.)
      if (key === " " || key === null) {
        scheduleSnapshot();
        return;
      }

      // Otherwise: wait for a short pause to batch the word
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        scheduleSnapshot();
      }, 400);
    });


    excerptEl.addEventListener('input', updateDerived);
    sectionEl.addEventListener('change', updateDerived);
    authorEl.addEventListener('input', updateDerived);
    dateEl.addEventListener('input', updateDerived);

    function enhanceBibliographyIn(root) {
      if (!root) return;

      var article = root;
      // if root is a wrapper, find the article element inside
      if (root.matches && !root.matches('article.prose')) {
        var inside = root.querySelector('article.prose');
        if (inside) article = inside;
      }

      if (!article) return;

      var headings = Array.prototype.filter.call(
        article.querySelectorAll('h2'),
        function (h) {
          var text = (h.textContent || '').trim().toLowerCase();
          return (
            text === 'bibliography' ||
            text === 'references' ||
            text === 'works cited'
          );
        }
      );

      if (!headings.length) return;

      var h = headings[0];
      var parent = h.parentNode;
      if (!parent) return;

      var wrapper = document.createElement('section');
      wrapper.className = 'bibliography-section';
      parent.insertBefore(wrapper, h);

      var node = h;
      while (node) {
        var next = node.nextSibling;
        wrapper.appendChild(node);

        if (next && next.nodeType === 1) {
          var tag = next.tagName;
          if (tag === 'H1' || tag === 'H2') {
            break;
          }
        }
        node = next;
      }

      var index = 1;
      Array.prototype.forEach.call(
        wrapper.querySelectorAll('ol li, ul li'),
        function (li) {
          li.classList.add('bibliography-item');
          li.setAttribute('data-bib-index', String(index++));
        }
      );
    }


    function updateDerived(){
      readEl.value = estimateReadMinutes(bodyEl.value) + ' min';
      previewSection.textContent = sectionEl.value;
      previewTitle.textContent = titleEl.value || 'Title…';
      previewExcerpt.textContent = excerptEl.value || 'Excerpt…';
      previewAuthor.textContent = authorEl.value || 'Camila Tiburcio Rubio';
      previewRead.textContent = estimateReadMinutes(bodyEl.value);
      previewDate.textContent = dateEl.value
        ? new Date(dateEl.value).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})
        : new Date().toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
      previewBody.innerHTML = md(expandInlineImages(bodyEl.value));
      addDropcap();
      enhanceBibliographyIn(previewBody);

      // keep body stats in sync
      updateBodyStats();
    }

    function addDropcap() {
      const firstP = document.querySelector('#previewBody p');
      if (firstP && !firstP.classList.contains('dropcap')) firstP.classList.add('dropcap');
    }

    /* =========================
       Draft (localStorage)
    ========================= */
    function collect(){
      const coverSrc = coverImg.src || '';
      const mdRaw = bodyEl.value;
      const mdExpanded = expandInlineImages(mdRaw);
      return {
        title: titleEl.value.trim(),
        slug: slugEl.value.trim() || slugify(titleEl.value),
        section: sectionEl.value,
        tags: tagsEl.value.split(',').map(t=>t.trim()).filter(Boolean),
        author: authorEl.value.trim() || 'Camila Tiburcio Rubio',
        excerpt: excerptEl.value.trim(),
        date: dateEl.value || new Date().toISOString(),
        readMinutes: estimateReadMinutes(mdRaw),
        featured: featuredEl.checked,
        cover: coverSrc ? { src: coverSrc, alt: coverAlt.value.trim() } : null,
        bodyMarkdown: mdRaw,
        bodyHtml: md(mdExpanded),
        images: inlineImageStore,
        seo: { title: metaTitleEl.value.trim(), description: metaDescEl.value.trim() },
        version: 1
      };
    }

    function validate(data){
      const errors = [];
      if(!data.title) errors.push('Title is required.');
      if(!data.slug) errors.push('Slug is required.');
      if(!data.excerpt) errors.push('Excerpt is required.');
      if(!data.bodyMarkdown) errors.push('Body is required.');
      return errors;
    }

    function saveDraft(){
      const data = collect();
      localStorage.setItem('ctr:admin:draft', JSON.stringify(data));
      markClean();
      statusMsg.textContent = 'Draft saved locally ✓';
      setTimeout(()=> statusMsg.textContent = '', 2000);
    }

    function loadDraft(){
      const raw = localStorage.getItem('ctr:admin:draft');
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        inlineImageStore = d.images || {};
        titleEl.value = d.title || '';
        slugEl.value = d.slug || '';
        sectionEl.value = d.section || 'Essay';
        tagsEl.value = (d.tags || []).join(', ');
        authorEl.value = d.author || '';
        excerptEl.value = d.excerpt || '';
        dateEl.value = d.date ? d.date.slice(0,16) : '';
        readEl.value = (d.readMinutes||0) + ' min';
        featuredEl.checked = !!d.featured;
        if(d.cover && d.cover.src){
          coverImg.src = d.cover.src;
          coverPreview.classList.remove('hidden');
          previewCover.innerHTML = `<img class="w-full h-full object-cover" src="${d.cover.src}" alt="">`;
          coverAlt.value = d.cover.alt || '';
        }
        bodyEl.value = d.bodyMarkdown || '';
        metaTitleEl.value = d.seo?.title || '';
        metaDescEl.value = d.seo?.description || '';
        updateDerived();
        renderOutline();
        markClean();
      }catch(e){ console.warn('Failed to load draft', e); }
    }

    $('#saveDraftBtn').addEventListener('click', () => {
      saveMultiDraft();
      statusMsg.textContent = "Draft saved ✓";
      setTimeout(()=> statusMsg.textContent="", 1500);
    });
    $('#previewBtn').addEventListener('click', updateDerived);

    /* =========================
       JSON Import / Export
    ========================= */
    $('#importJsonBtn').addEventListener('click', () => $('#jsonFileInput').click());
    $('#jsonFileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try { const d = JSON.parse(text); populateFromJSON(d); saveDraft(); } catch(err){ alert('Invalid JSON'); }
      e.target.value='';
    });

    function populateFromJSON(d){
      inlineImageStore = d.images || {};
      titleEl.value = d.title || '';
      slugEl.value = d.slug || slugify(d.title||'');
      sectionEl.value = d.section || 'Essay';
      tagsEl.value = (d.tags||[]).join(', ');
      authorEl.value = d.author || '';
      excerptEl.value = d.excerpt || '';
      dateEl.value = d.date ? d.date.slice(0,16) : '';
      readEl.value = (d.readMinutes||estimateReadMinutes(d.bodyMarkdown||'')) + ' min';
      featuredEl.checked = !!d.featured;
      if(d.cover && d.cover.src){
        coverImg.src = d.cover.src;
        coverPreview.classList.remove('hidden');
        previewCover.innerHTML = `<img class='w-full h-full object-cover' src='${d.cover.src}' alt=''>`;
        coverAlt.value = d.cover.alt || '';
      }
      bodyEl.value = d.bodyMarkdown || '';
      metaTitleEl.value = d.seo?.title || '';
      metaDescEl.value = d.seo?.description || '';
      updateDerived();
      renderOutline();
      markClean();
    }

    const exportJsonBtn = $('#exportJsonBtn');
    exportJsonBtn.addEventListener('click', () => {
      const data = collect();
      const errs = validate(data);
      if(errs.length){ alert('Please fix:\n' + errs.join('\n')); return; }
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `article-${data.slug}.json`;
      a.click();
    });

        /* =========================
       Preview in New Tab
    ========================= */
    const previewTabBtn = $('#previewTabBtn');

    if (previewTabBtn) {
      previewTabBtn.addEventListener('click', () => {
        const data = collect();

        // Minimal guard: don't open an empty page
        if (!data.title && !data.bodyMarkdown) {
          alert('Please add at least a title or some body text before previewing.');
          return;
        }

        const html = buildArticleHtml(data); // uses the same template as exportHtmlBtn

        const win = window.open('', '_blank');
        if (!win) {
          alert('Popup blocked. Please allow pop-ups for this site to use "Preview in New Tab".');
          return;
        }

        win.document.open();
        win.document.write(html);
        win.document.close();
      });
    }


    /* ============================================
       MULTI-DRAFT SYSTEM (non-destructive upgrade)
       keys: ctr:admin:draft:{slug}
    ============================================ */

    function allDraftKeys() {
      return Object.keys(localStorage).filter(k => k.startsWith("ctr:admin:draft:"));
    }

    function saveMultiDraft(isAutosave = false) {
      const data = collect();

      // 1) Don’t autosave completely empty drafts (stops spam from idle tabs)
      const hasContent =
        data.title ||
        data.excerpt ||
        data.bodyMarkdown ||
        (data.cover && data.cover.src);

      if (!hasContent) {
        // For autosave, just bail quietly.
        // For manual "Save Draft", this will also do nothing if absolutely nothing is filled in.
        return null;
      }

      // 2) Build a stable slug
      let slug = data.slug || slugify(data.title || '');

      // If there is still no slug (no title yet), use a fixed key for autosave
      if (!slug) {
        // Autosave: always overwrite the same "current" draft instead of making new ones
        slug = isAutosave ? 'current' : ('draft-' + Date.now());
      }

      const key = 'ctr:admin:draft:' + slug;

      data._savedAt = new Date().toISOString();
      localStorage.setItem(key, JSON.stringify(data));
      markClean();
      return key;
    }


    function loadMultiDraft(slug) {
      const key = "ctr:admin:draft:" + slug;
      const raw = localStorage.getItem(key);
      if (!raw) return;
      const d = JSON.parse(raw);
      populateFromJSON(d);
    }

      function removeDraftForSlug(slug) {
      if (!slug) return;
      const prefix = "ctr:admin:draft:";
      const keys = allDraftKeys();
      keys.forEach(k => {
        const s = k.startsWith(prefix) ? k.slice(prefix.length) : null;
        if (s === slug) {
          localStorage.removeItem(k);
        }
      });

      // also clean up the legacy single-draft + “current” autosave, just in case
      try {
        localStorage.removeItem('ctr:admin:draft');          // old single draft key
        localStorage.removeItem('ctr:admin:draft:current');  // untitled autosave
      } catch (e) {
        console.warn('Failed to clear old draft keys', e);
      }
    }


    /* Autosave every 30s */
    setInterval(() => saveMultiDraft(true), 30000);

    /* Drawer UI */
    const drawer = $("#draftsDrawer");
    const draftsList = $("#draftsList");

    $("#openDraftsBtn").addEventListener("click", () => {
      drawer.classList.remove("hidden");
      renderDraftsList();
    });

    $("#closeDraftsBtn").addEventListener("click", () => {
      drawer.classList.add("hidden");
    });

    const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          try { localStorage.removeItem('ctr:admin:auth'); } catch {}
          window.location.href = 'login.html';
        });
      }

    function renderDraftsList() {
      draftsList.innerHTML = "";

      const keys = allDraftKeys();
      if (keys.length === 0) {
        draftsList.innerHTML = `<p class="text-ink-300">No drafts yet.</p>`;
        return;
      }

      keys.forEach(k => {
        const d = JSON.parse(localStorage.getItem(k));
        const slug = k.replace("ctr:admin:draft:", "");
        const title = d.title || "(Untitled)";
        const section = d.section || "";
        const time = new Date(d._savedAt).toLocaleString();

        const item = document.createElement("div");
        item.className = "border border-black/10 rounded-xl p-3";

        item.innerHTML = `
          <div class="font-medium">${title}</div>
          <div class="text-xs text-ink-300">${section} • ${time}</div>

          <div class="flex gap-2 mt-3">
            <button data-open="${slug}"
              class="px-3 py-1 rounded bg-accent text-white text-xs">Open</button>

            <button data-del="${slug}"
              class="px-3 py-1 rounded border border-black/10 text-xs">Delete</button>
          </div>
        `;

        draftsList.appendChild(item);
      });

      // attach handlers
      draftsList.querySelectorAll("[data-open]").forEach(btn => {
        btn.onclick = () => {
          const slug = btn.dataset.open;
          loadMultiDraft(slug);
          drawer.classList.add("hidden");
        };
      });

      draftsList.querySelectorAll("[data-del]").forEach(btn => {
        btn.onclick = () => {
          const slug = btn.dataset.del;
          localStorage.removeItem("ctr:admin:draft:" + slug);
          renderDraftsList();
        };
      });
    }

    if (drawer) {
      drawer.addEventListener("click", (e) => {
        // Only close if clicking the backdrop, not the inner panel
        if (e.target === drawer) {
          drawer.classList.add("hidden");
        }
      });
    }

    /* ============================================
       PUBLISHED ARTICLES BROWSER + EDITOR
       - Reads posts.json via GitHub API
       - Loads data/posts/{slug}.json into editor
    ============================================ */

    const publishedDrawer = $("#publishedDrawer");
    const publishedList   = $("#publishedList");
    const openPublishedBtn  = $("#openPublishedBtn");
    const closePublishedBtn = $("#closePublishedBtn");

    if (openPublishedBtn && publishedDrawer && publishedList) {
      openPublishedBtn.addEventListener("click", async () => {
        publishedDrawer.classList.remove("hidden");
        await renderPublishedList();
      });
    }

    if (closePublishedBtn && publishedDrawer) {
      closePublishedBtn.addEventListener("click", () => {
        publishedDrawer.classList.add("hidden");
      });
    }


    async function fetchPostsList() {
      try {
        // Use GitHub API helper to read posts.json from the repo
        const file = await getRepoFile("posts.json");
        if (!file || !file.content) return [];
        const json = atob(file.content.replace(/\n/g, ""));
        const list = JSON.parse(json);
        return Array.isArray(list) ? list : [];
      } catch (e) {
        console.warn("Failed to fetch posts.json", e);
        return [];
      }
    }

    // Close published drawer when clicking the dark backdrop
    if (publishedDrawer) {
      publishedDrawer.addEventListener("click", (e) => {
        if (e.target === publishedDrawer) {
          publishedDrawer.classList.add("hidden");
        }
      });
    }

    (function () {
      // === CONFIG ===
      const MAX_IDLE_MINUTES = 30;  // change to 10, 15, 45, etc.

      function logout() {
        localStorage.removeItem("ctr:admin:auth");
        localStorage.removeItem("ctr:admin:lastActive");
        window.location.href = "login.html";
      }

      // Check if logged in
      const token = localStorage.getItem("ctr:admin:auth");
      if (token !== "ok") logout();

      // Check idle timeout
      const last = parseInt(localStorage.getItem("ctr:admin:lastActive") || "0", 10);
      const now = Date.now();
      const diffMinutes = (now - last) / 1000 / 60;

      if (diffMinutes > MAX_IDLE_MINUTES) {
        logout();
      }

      // Update "last active" on any interaction
      function refreshActive() {
        localStorage.setItem("ctr:admin:lastActive", Date.now());
      }

      window.addEventListener("mousemove", refreshActive, { passive: true });
      window.addEventListener("keydown", refreshActive);
      window.addEventListener("click", refreshActive, { passive: true });
      window.addEventListener("scroll", refreshActive, { passive: true });
      window.addEventListener("touchstart", refreshActive, { passive: true });

    })();


    async function renderPublishedList() {
      publishedList.innerHTML = `<p class="text-ink-300 text-sm">Loading…</p>`;

      const posts = await fetchPostsList();
      if (!posts.length) {
        publishedList.innerHTML = `<p class="text-ink-300 text-sm">No published articles yet.</p>`;
        return;
      }

      publishedList.innerHTML = "";
      posts.forEach(post => {
        const item = document.createElement("div");
        item.className = "border border-black/10 rounded-xl p-3";

        const dateStr = post.date
          ? new Date(post.date).toLocaleDateString(undefined, {
              year: "numeric", month: "short", day: "numeric"
            })
          : "";

        item.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-medium line-clamp-2">${escapeHtml(post.title || "(Untitled)")}</div>
              <div class="mt-1 text-xs text-ink-300">
                ${(post.section || "").toUpperCase()}${dateStr ? " • " + dateStr : ""}
              </div>
            </div>
            <span class="inline-flex items-center rounded-full bg-accent/10 text-accent text-[10px] px-2 py-0.5 uppercase tracking-[0.16em]">
              Live
            </span>
          </div>

          <div class="flex gap-2 mt-3">
            <button data-edit-published="${post.slug}"
              class="px-3 py-1 rounded bg-accent text-white text-xs">
              Edit
            </button>

            <a href="${post.url || (post.slug + ".html")}"
               target="_blank"
               rel="noopener noreferrer"
               class="px-3 py-1 rounded border border-black/10 text-xs text-ink-500 hover:text-ink-900">
              View
            </a>
          </div>
        `;

        publishedList.appendChild(item);
      });

      // wire up Edit buttons
      publishedList.querySelectorAll("[data-edit-published]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const slug = btn.getAttribute("data-edit-published");
          await editPublishedArticle(slug);
          publishedDrawer.classList.add("hidden");
        });
      });
    }

    async function editPublishedArticle(slug) {
      try {
        const path = `data/posts/${slug}.json`;
        const file = await getRepoFile(path);
        if (!file || !file.content) {
          alert("No editable JSON found for this article yet.\nTry re-publishing it once with this updated admin.");
          return;
        }

        const jsonText = atob(file.content.replace(/\n/g, ""));
        const data = JSON.parse(jsonText);

        // Load into the form using your existing helper
        populateFromJSON(data);

        // Optionally stash it as a draft for safety
        if (typeof saveMultiDraft === "function") {
          saveMultiDraft();
        }

        statusMsg.textContent = `Loaded "${data.title || slug}" for editing.`;
        setTimeout(() => { statusMsg.textContent = ""; }, 2500);
      } catch (e) {
        console.error(e);
        alert("Unable to load published article for editing: " + e.message);
      }
    }


    /* =========================
       Export Standalone HTML
    ========================= */
    $('#exportHtmlBtn').addEventListener('click', () => {
      const data = collect();
      const errs = validate(data);
      if(errs.length){ alert('Please fix:\n' + errs.join('\n')); return; }
      const html = buildArticleHtml(data);
      const blob = new Blob([html], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${data.slug}.html`;
      a.click();
    });

    function escapeHtml(s=''){
      return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    /* =========================
       Build Article HTML
    ========================= */
    function buildArticleHtml(data){
      const hasTags   = Array.isArray(data.tags) && data.tags.length;
      const coverCredit = data.cover?.credit || "";

      return `<!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>${escapeHtml(data.seo?.title || data.title)} — Camila Tiburcio Rubio</title>
      <meta name="description" content="${escapeHtml(data.seo?.description || data.excerpt)}" />
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400..800&display=swap" rel="stylesheet">
      <script src="https://cdn.tailwindcss.com"><\/script>
      <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Inter','system-ui','sans-serif'],
                serif: ['Source Serif 4','Georgia','serif']
              },
              colors: {
                ink: { 900:'#0E0E0E',700:'#1F1F1F',500:'#3A3A3A',300:'#9CA3AF' },
                cream: '#FAF7F2',
                accent: { DEFAULT:'#C53D2F', dark:'#9E2F24', light:'#E95A49' }
              },
              boxShadow: { soft:'0 10px 30px rgba(0,0,0,0.06)' }
            }
          }
        }
      <\/script>
      <style>
        .u-underline{position:relative}
        .u-underline:after{content:'';position:absolute;left:0;bottom:-2px;height:2px;width:100%;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .25s}
        .u-underline:hover:after{transform:scaleX(1)}
        .prose h1,.prose h2,.prose h3,.prose h4{font-family:'Source Serif 4',Georgia,serif}
        .prose img{ width:100%; height:480px; object-fit:cover; object-position:center; display:block; border-radius:0.75rem; box-shadow:0 10px 30px rgba(0,0,0,0.06); margin:1.25rem 0; }
        .prose p{margin:1.05em 0;line-height:1.8}
        .tag{display:inline-block;padding:.35rem .65rem;border-radius:9999px;background:rgba(197,61,47,.08);color:#C53D2F;font-weight:600;font-size:.8rem;border:1px solid rgba(0,0,0,.06)}
        .hero-img{width:100%;height:480px;object-fit:cover;object-position:center;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,.06)}
        blockquote{border-left:4px solid #C53D2F;background:rgba(197,61,47,.08);padding:1rem 1.25rem;border-radius:.5rem;font-style:italic}
        #progress-bar{position:fixed;top:0;left:0;height:3px;background:#C53D2F;width:0;z-index:60}
        #progress-label{
          position:fixed;
          top:6px;
          right:16px;
          padding:2px 9px;
          border-radius:9999px;
          background:rgba(14,14,14,0.78);
          color:#F9FAFB;
          font-size:10px;
          letter-spacing:.16em;
          text-transform:uppercase;
          z-index:70;
          display:none;
          pointer-events:none;
        }
        #progress-label span{
          font-variant-numeric:tabular-nums;
          white-space:nowrap;
        }
        blockquote::before { content: "“"; font-size: 3rem; line-height: 0; vertical-align: -0.4rem; color: #C53D2F; margin-right: 0.25rem; }
        .prose .dropcap::first-letter { font-family: 'Source Serif 4', Georgia, serif; float: left; font-size: 5.5rem; line-height: 0.9; margin-right: 0.1rem; font-weight: 500; margin-top: -0.2rem; color: #C53D2F; }
        .prose p.dropcap { text-indent: 0; margin-top: 0.4em; }
        article.prose { animation: fadeIn 0.35s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        ::selection { background: rgba(197,61,47,0.15); }
        /* Keep share bar horizontal on standalone page too */
        .shareCard{ display:inline-flex; flex-direction:row; }
        /* Share bar styles */
        .shareCard{
          display:inline-flex; flex-direction:row; align-items:center; gap:14px;
          width:fit-content; padding:16px 18px; border-radius:9999px; background:#fff;
          border:1px solid rgba(0,0,0,.10); box-shadow:0 10px 30px rgba(0,0,0,.04); margin:0 auto;
        }
        .shareLabel{ font-weight:700; font-size:.75rem; letter-spacing:.04em; text-transform:uppercase; color:#111; user-select:none; margin-right:2px; }
        .socialContainer{
          width:40px; height:40px; border-radius:12px; background:transparent;
          border:1px solid rgba(0,0,0,.10); color:#3A3A3A; display:flex; align-items:center; justify-content:center;
          transition:transform .18s ease, background-color .18s ease, border-color .18s ease, color .18s ease;
          text-decoration:none; cursor:pointer;
        }
        .socialContainer:hover{ background:rgba(197,61,47,.08); border-color:rgba(197,61,47,.35); color:#C53D2F; transform:translateY(-1px); }
        .socialContainer:active{ transform:scale(.97); }
        .xSvg{ width:16px; height:16px; color:inherit; }
        .socialSvg{ width:18px; height:18px; color:inherit; }
        .fill-icon path{ fill: currentColor; }
        .clipboard-svg{ width:18px; height:18px; stroke: currentColor; fill:none; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:round; }

                /* Stronger section headers inside article */
        article.prose h2 {
          font-family: 'Source Serif 4', Georgia, serif;
          font-size: 1.9rem;              /* bigger — feels like a true section */
          line-height: 1.25;
          color: #0E0E0E;                 /* darker than body text */
          font-weight: 600;
          margin-top: 3.5rem;             /* big spacing above */
          margin-bottom: 1.5rem;          /* spacing below */
          scroll-margin-top: 110px;       /* fixes jump-to offset nicely */
          border-left: 4px solid #C53D2F; /* subtle accent mark */
          padding-left: 0.85rem;
        }



        #ttsToggle[data-state="playing"] {
          background: rgba(197, 61, 47, 0.09);
          color: #C53D2F;
          border-color: rgba(197, 61, 47, 0.35);
        }

        #ttsToggle[data-state="playing"] {
          background: rgba(197,61,47,0.09);
          color: #C53D2F;
          border-color: rgba(197,61,47,0.35);
        }

        /* Play/pause button states */
        #ttsPlayPause[data-state="playing"] {
          background: rgba(197,61,47,0.09);
          color: #C53D2F;
          border-color: rgba(197,61,47,0.35);
        }

        #ttsPlayPause[data-state="paused"] {
          background: #ffffff;
        }

        /* Show correct icon for state */
        #ttsPlayPause [data-icon="play"],
        #ttsPlayPause [data-icon="pause"] {
          display: none;
        }

        #ttsPlayPause[data-state="paused"] [data-icon="play"] {
          display: block;
        }

        #ttsPlayPause[data-state="playing"] [data-icon="pause"] {
          display: block;
        }

        /* TTS progress bar styling */
        #ttsProgressRange {
          -webkit-appearance: none;
          appearance: none;
          height: 4px;
          border-radius: 9999px;
          background: transparent; /* we'll draw the track via JS gradient */
          outline: none;
          cursor: pointer;
        }

        /* WebKit thumb */
        #ttsProgressRange::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 14px;
          height: 14px;
          border-radius: 9999px;
          background: #C53D2F;
          border: 2px solid #F9FAFB;
          box-shadow: 0 0 0 1px rgba(0,0,0,0.10);
          margin-top: -5px; /* centers thumb on 4px track */
        }

        /* Firefox thumb */
        #ttsProgressRange::-moz-range-thumb {
          width: 14px;
          height: 14px;
          border-radius: 9999px;
          background: #C53D2F;
          border: 2px solid #F9FAFB;
          box-shadow: 0 0 0 1px rgba(0,0,0,0.10);
        }

        /* Firefox track */
        #ttsProgressRange::-moz-range-track {
          height: 4px;
          border-radius: 9999px;
          background: transparent;
        }

        /* Play/pause button states */
        #ttsPlayPause[data-state="playing"] {
          background: rgba(197,61,47,0.09);
          color: #C53D2F;
          border-color: rgba(197,61,47,0.35);
        }

        #ttsPlayPause[data-state="paused"] {
          background: #ffffff;
        }

        /* TTS progress bar styling */
        #ttsProgressRange {
          -webkit-appearance: none;
          appearance: none;
          height: 4px;
          border-radius: 9999px;
          background: rgba(15,23,42,0.08);
          outline: none;
          cursor: pointer;
        }

        #ttsProgressRange::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 12px;
          height: 12px;
          border-radius: 9999px;
          background: #C53D2F;
          border: 2px solid #F9FAFB;
          box-shadow: 0 0 0 1px rgba(0,0,0,0.10);
          margin-top: -4px;
        }

        #ttsProgressRange::-moz-range-thumb {
          width: 12px;
          height: 12px;
          border-radius: 9999px;
          background: #C53D2F;
          border: 2px solid #F9FAFB;
          box-shadow: 0 0 0 1px rgba(0,0,0,0.10);
        }

        #ttsProgressRange::-moz-range-track {
          height: 4px;
          border-radius: 9999px;
          background: rgba(15,23,42,0.08);
        }

        /* Base track */
        #ttsProgressRange {
          -webkit-appearance: none;
          appearance: none;
          height: 4px;
          background: rgba(0,0,0,0.1);
          border-radius: 999px;
          outline: none;
        }

        /* WebKit thumb (Safari + Chrome) */
        #ttsProgressRange::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 14px;
          height: 14px;
          background: #C53D2F;
          border-radius: 50%;
          cursor: pointer;

          /* THIS controls vertical alignment */
          margin-top: 0px; /* Adjust between -4 and -8 until perfect */
        }

        /* Firefox thumb */
        #ttsProgressRange::-moz-range-thumb {
          width: 14px;
          height: 14px;
          background: #C53D2F;
          border-radius: 50%;
          cursor: pointer;

          margin-top: 0; /* Firefox centers by default */
        }

        #ttsProgressRange::-webkit-slider-thumb {
          margin-top: 0px !important;

        }
        #ttsProgressRange::-moz-range-thumb {
          margin-top: -3px !important;
        }

        /* Sticky TTS mini-player container */
        #ttsStickyBar {
          position: fixed;
          left: 0;
          right: 0;
          bottom: 1rem;
          z-index: 60;
          display: none;       /* shown when listening starts */
          pointer-events: none; /* inner card handles clicks */
        }

        /* Inner card gets actual pointer events */
        #ttsStickyInner {
          pointer-events: auto;
        }

        /* Highlight for the sentence currently being read */
        .tts-sentence--active {
          background: rgba(197, 61, 47, 0.14);
          border-radius: 4px;
          padding: 0 1px;
          transition: background 0.08s ease-out;
        }

        /* Bibliography / citations block on article page */
        .bibliography-section {
          margin-top: 2.5rem;
          padding-top: 1.25rem;
          border-top: 1px solid rgba(0,0,0,0.08);
          font-size: 0.95rem;
        }

        .bibliography-section h2 {
          font-size: 1.1rem;
          letter-spacing: 0.16em;
          text-transform: uppercase;
          font-weight: 600;
          color: #374151;
          margin-bottom: 0.75rem;
        }

        /* Remove default bullets / numbers – we'll draw our own */
        .bibliography-section ol,
        .bibliography-section ul {
          list-style: none;
          padding-left: 0;
          margin: 0;
        }

        /* One “item” per reference (works for <li> or <p>) */
        .bibliography-item {
          position: relative;
          margin-bottom: 0.75rem;
          line-height: 1.7;
          padding-left: 2.25rem;   /* where the text block starts */
        }

        /* Number column */
        .bibliography-item::before {
          content: attr(data-bib-index) ".";
          position: absolute;
          left: 0;
          top: 0;
          width: 1.75rem;
          text-align: right;
          font-variant-numeric: tabular-nums;
          color: #6B7280;
        }


        /* --- Jump-to-section: desktop floating card (softer) --- */
        #jumpFloatingDesktop {
          position: fixed;
          top: 190px; /* a bit lower so it's aligned with content */
          right: max(1.25rem, (100vw - 1120px) / 2 - 80px);
          width: 200px;
          z-index: 30;

          /* fade-in behavior */
          opacity: 0;
          pointer-events: none;
          transform: translateY(4px);
          transition: opacity 0.22s ease-out, transform 0.22s ease-out;
        }

        #jumpFloatingDesktop.jump-visible {
          opacity: 1;
          pointer-events: auto;
          transform: translateY(0);
        }

        /* Card container */
        #jumpFloatingDesktop .jump-card-inner {
          background: rgba(250, 247, 242, 0.78); /* soft, slightly translucent cream */
          border-radius: 16px;
          border: 1px solid rgba(0, 0, 0, 0.03);
          box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
          padding: 10px 12px 8px;
          font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* "JUMP TO" label as a real header */
        #jumpFloatingDesktop .jump-label {
          font-size: 10px;
          letter-spacing: 0.16em;
          text-transform: uppercase;
          color: #374151;              /* darker than section items */
          font-weight: 700;
          margin-bottom: 6px;
          border-bottom: 1px solid rgba(0,0,0,0.10);
          padding-bottom: 3px;
        }

        /* List container */
        #jumpFloatingDesktop .jump-list {
          list-style: none;
          margin: 0;
          padding: 0;
        }

        /* Each button */
        #jumpFloatingDesktop .jump-list button {
          width: 100%;
          border-radius: 9999px;
          border: none;
          padding: 4px 8px;
          margin-top: 3px;
          font-size: 12px;
          text-align: left;
          background: transparent;
          color: #6B7280; /* muted gray */
          cursor: pointer;
          transition:
            background-color 0.16s ease,
            color 0.16s ease,
            transform 0.10s ease;
        }

        #jumpFloatingDesktop .jump-list button:hover {
          background: rgba(15, 23, 42, 0.03);
          color: #111827;
          transform: translateX(0.5px);
        }

        /* Active = soft accent pill */
        #jumpFloatingDesktop .jump-list button[data-active="true"] {
          background: rgba(197, 61, 47, 0.12); /* soft accent */
          color: #C53D2F;
          font-weight: 500;
        }

        /* Hide desktop jump card on smaller screens */
        @media (max-width: 1023px) {
          #jumpFloatingDesktop {
            display: none;
          }
        }

      </style>
    </head>

    <body class="bg-cream text-ink-900 antialiased">
      <div id="progress-bar"></div>
      <div id="progress-label" aria-hidden="true">
        <span data-progress-text>0% read</span>
      </div>

      <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-cream/80 bg-cream/95 border-b border-black/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div class="flex items-center gap-1">
            <a href="index.html" class="flex items-center gap-2" aria-label="Home">
              <img src="assets/logo.png" alt="Camila Tiburcio Rubio logo" class="h-12 w-12 object-contain" />
              <span class="font-serif text-2xl tracking-tight">Camila Tiburcio Rubio</span>
            </a>
          </div>
          <a id="backBtn" class="u-underline text-sm" href="index.html" title="Go back">← Go back</a>
        </div>
      </header>

      <section class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pt-10 text-center">
        <div class="text-[10px] sm:text-xs tracking-[0.14em] font-semibold text-accent uppercase">
          ${escapeHtml(data.section || '')}
        </div>

        <h1 class="font-serif text-4xl sm:text-5xl mt-3 leading-tight">
          ${escapeHtml(data.title)}
        </h1>

        ${data.excerpt ? `<p class="text-ink-500 mt-3 max-w-2xl mx-auto">${escapeHtml(data.excerpt)}</p>` : ''}


        <div class="mt-4 flex items-center justify-center gap-3 text-sm">
          <div class="w-9 h-9 rounded-full overflow-hidden bg-ink-300">
            ${data.author === 'Camila Tiburcio Rubio'
              ? `<img src="assets/camila.jpg" alt="Camila Tiburcio Rubio" class="w-full h-full object-cover"/>`
              : ''}
          </div>
          <div class="text-left">
            <div class="font-medium">By ${escapeHtml(data.author || 'Camila Tiburcio Rubio')}</div>
            <div class="text-ink-300">
              ${new Date(data.date).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'})}
              • ${data.readMinutes} min read
            </div>
          </div>
        </div>

        ${hasTags ? `
          <div class="mt-3 flex justify-center flex-wrap gap-2">
            ${data.tags
              .map(t => `
                <a class="tag" href="search.html?q=${encodeURIComponent(t)}">
                  ${escapeHtml(t)}
                </a>
              `)
              .join('')}
          </div>` : ``}

        <div class="mt-3 flex justify-center">
          <button
            id="ttsToggle"
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-black/10 bg-white/80 px-3 py-1.5 text-xs text-ink-500 shadow-soft hover:border-black/20 hover:text-ink-900 transition"
          >
            <span>Listen to article</span>
          </button>
        </div>

        <!-- TTS controls: play/pause + progress (hidden until listening starts) -->
        <div
          id="ttsControls"
          class="mt-2 flex items-center justify-center gap-3 text-[10px] text-ink-300"
          style="display:none;"
        >
          <!-- Slider & Time -->
          <div class="flex items-center gap-2">
            <input
              id="ttsProgressRangeInLine"
              type="range"
              min="0"
              max="100"
              step="1"
              value="0"
              style="width:260px;max-width:100%;"
            />
            <div
              id="ttsProgressLabelInLine"
              class="text-[11px] text-ink-400 font-medium tabular-nums"
            >
              00:00
            </div>
          </div>

          <!-- Play / Pause button (now aligned vertically) -->
          <button
            id="ttsPlayPauseInLine"
            type="button"
            data-state="paused"
            class="inline-flex items-center justify-center rounded-full border border-black/10 bg-white/90 w-8 h-8 text-ink-500 shadow-soft hover:border-black/20 hover:text-ink-900 transition"
            aria-label="Play or pause article audio"
          >
            <!-- Play icon -->
            <svg data-icon="play" viewBox="0 0 24 24" class="h-3.5 w-3.5" aria-hidden="true">
              <polygon points="8,5 19,12 8,19"></polygon>
            </svg>

            <!-- Pause icon -->
            <svg data-icon="pause" viewBox="0 0 24 24" class="h-3.5 w-3.5" aria-hidden="true">
              <rect x="7" y="5" width="3.2" height="14" rx="1"></rect>
              <rect x="13.8" y="5" width="3.2" height="14" rx="1"></rect>
            </svg>
          </button>
        </div>

      </section>

      ${data.cover ? `
      <figure class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <img class="hero-img" src="${data.cover.src}" alt="${escapeHtml(data.cover.alt||'')}"/>
        ${coverCredit ? `<figcaption class="text-center text-xs text-ink-300 mt-2">Image credit: ${escapeHtml(coverCredit)}</figcaption>` : ``}
      </figure>` : ``}

      <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <!-- Jump to section menu -->
        <div id="jumpMenu" class="not-prose mb-6 mt-2 lg:mb-4">
          <!-- Mobile: collapsible -->
          <div class="lg:hidden">
            <button
              id="jumpToggleBtn"
              type="button"
              class="w-full flex items-center justify-between rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs text-ink-500 shadow-soft"
            >
              <span class="tracking-[0.18em] uppercase text-[10px] text-ink-300 font-semibold">
                Jump to
              </span>
              <span class="flex items-center gap-1">
                <span class="text-[11px] text-ink-500" data-jump-current>Sections</span>
                <span class="text-xs text-ink-300">▾</span>
              </span>
            </button>

            <div
              id="jumpMobileList"
              class="mt-2 hidden rounded-2xl border border-black/10 bg-white px-3 py-2 text-sm space-y-1"
            ></div>
          </div>
        </div>

        <div class="relative">
          <div class="fade-top"></div>
          <div class="fade-bottom"></div>
          <article class="prose prose-neutral max-w-none">
            ${data.bodyHtml}
          </article>
        </div>

        <div class="mt-10 not-prose flex justify-center">
          <div class="shareCard" role="group" aria-label="Share">
            <span class="shareLabel">Share</span>

            <a id="share-x" class="socialContainer containerX" aria-label="Share on X" target="_blank" rel="noopener noreferrer">
              <svg class="xSvg fill-icon" viewBox="0 0 1200 1227" aria-hidden="true">
                <path d="M714.2 519.9 1161.5 0H1055L671.7 442.2 356.1 0H0l468.9 684.1L0 1226.6h106.5l407.4-467.9 336.7 467.9h356.1L714.2 519.9Zm-144 165.6-47.2-65.3L180.4 80h162.7l228.6 316.8 47.2 65.3L1021 1146.6H858.3L570.2 685.5Z"/>
              </svg>
            </a>

            <a id="share-fb" class="socialContainer containerFB" aria-label="Share on Facebook" target="_blank" rel="noopener noreferrer">
              <svg class="socialSvg fill-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M22 12.073C22 6.486 17.523 2 12 2S2 6.486 2 12.073C2 17.09 5.657 21.127 10.438 22v-6.999H7.898v-2.928h2.54V9.845c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.47h-1.26c-1.243 0-1.63.772-1.63 1.562v1.874h2.773l-.443 2.928h-2.33V22C18.343 21.127 22 17.09 22 12.073"/>
              </svg>
            </a>

            <a id="share-mail" class="socialContainer containerMail" aria-label="Share via Email">
              <svg class="socialSvg fill-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 4-8 5-8-5V6l8 5 8-5v2Z"/>
              </svg>
            </a>

            <button id="share-copy" class="socialContainer containerCopy" aria-label="Copy link" type="button">
              <svg class="clipboard-svg" viewBox="0 0 24 24" aria-hidden="true">
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                <path d="M16 4h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
              </svg>
            </button>
          </div>
        </div>

        <section class="mt-12 border-t border-black/10 pt-6">
          <div class="flex items-start gap-4">
            ${data.author === 'Camila Tiburcio Rubio'
              ? `<img src="assets/camila.jpg" alt="Photo of Camila Tiburcio Rubio" class="w-14 h-14 rounded-full object-cover" />`
              : `<div class="w-14 h-14 rounded-full bg-ink-300"></div>`}
            <div>
              <p class="font-semibold">${escapeHtml(data.author || 'Camila Tiburcio Rubio')}</p>
              <p class="text-sm text-ink-300 mt-1">
                Writer and cultural researcher focusing on Cuba and the Caribbean,
                Masters Candidate in Latin America and Caribbean Studies at NYU.
              </p>
            </div>
          </div>
        </section>

        <section id="more" class="mt-12 border-t border-black/10 pt-8">
          <div class="flex items-center justify-between gap-3 mb-4">
            <h2 class="font-serif text-2xl">More ${escapeHtml(data.section)}s</h2>
            <div class="hidden sm:flex items-center gap-2">
              <button
                id="morePrev"
                type="button"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-black/10 bg-white text-xs text-ink-500 hover:text-ink-900 hover:border-black/20 shadow-soft transition"
                aria-label="Previous articles"
              >
                ←
              </button>
              <button
                id="moreNext"
                type="button"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-black/10 bg-white text-xs text-ink-500 hover:text-ink-900 hover:border-black/20 shadow-soft transition"
                aria-label="Next articles"
              >
                →
              </button>
            </div>
          </div>

          <div class="-mx-4 sm:mx-0">
            <div
              id="moreScroller"
              class="flex gap-5 overflow-x-auto pb-3 pl-4 sm:pl-0 snap-x snap-mandatory scroll-smooth"
            ></div>
          </div>

          <p id="moreSectionEmpty" class="hidden text-sm text-ink-300 mt-4">
            No related articles yet.
          </p>
        </section>

        <!-- Tag-based cross-section carousel -->
        <section id="moreTags" class="mt-10">
          <div class="flex items-center justify-between gap-3 mb-4">
            <h2 class="font-serif text-2xl">You may also like</h2>
            <div class="hidden sm:flex items-center gap-2">
              <button
                id="moreTagsPrev"
                type="button"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-black/10 bg-white text-xs text-ink-500 hover:text-ink-900 hover:border-black/20 shadow-soft transition"
                aria-label="Previous tagged articles"
              >
                ←
              </button>
              <button
                id="moreTagsNext"
                type="button"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-black/10 bg-white text-xs text-ink-500 hover:text-ink-900 hover:border-black/20 shadow-soft transition"
                aria-label="Next tagged articles"
              >
                →
              </button>
            </div>
          </div>

          <div class="-mx-4 sm:mx-0">
            <div
              id="moreTagsScroller"
              class="flex gap-5 overflow-x-auto pb-3 pl-4 sm:pl-0 snap-x snap-mandatory scroll-smooth"
            ></div>
          </div>

          <p id="moreTagsEmpty" class="hidden text-sm text-ink-300 mt-4">
            No tag-related articles yet.
          </p>
        </section>
      </main>

      <!-- Sticky TTS mini-player -->
      <div
        id="ttsStickyBar"
        class="fixed inset-x-0 bottom-4 z-50 flex justify-center px-4"
        style="display:none;"
      >
        <div
          id="ttsStickyInner"
          class="max-w-2xl w-full rounded-full border border-black/10 bg-white/95 shadow-soft backdrop-blur flex items-center gap-3 px-3 py-2"
        >
          <!-- Optional stop button on the left (desktop only) -->
          <button
            id="ttsStickyStop"
            type="button"
            class="hidden sm:inline-flex text-[11px] px-2.5 py-1 rounded-full border border-black/10 bg-white text-ink-400 hover:text-ink-900"
          >
            Stop
          </button>

          <!-- Progress bar -->
          <input
            id="ttsProgressRange"
            type="range"
            min="0"
            max="100"
            step="1"
            value="0"
            class="flex-1 mx-2"
          />

          <!-- Time label -->
          <span
            id="ttsProgressLabel"
            class="text-[11px] text-ink-400 font-medium tabular-nums whitespace-nowrap"
          >
            00:00 / 00:00
          </span>

          <!-- Play / Pause circle on the right -->
          <button
            id="ttsPlayPause"
            type="button"
            data-state="paused"
            class="inline-flex items-center justify-center rounded-full border border-black/10 bg-white/90 w-8 h-8 text-ink-500 shadow-soft hover:border-black/20 hover:text-ink-900 transition ml-1"
            aria-label="Play or pause article audio"
          >
            <!-- Play icon -->
            <svg data-icon="play" viewBox="0 0 24 24" class="h-3.5 w-3.5" aria-hidden="true">
              <polygon points="8,5 19,12 8,19"></polygon>
            </svg>

            <!-- Pause icon -->
            <svg data-icon="pause" viewBox="0 0 24 24" class="h-3.5 w-3.5" aria-hidden="true">
              <rect x="7" y="5" width="3.2" height="14" rx="1"></rect>
              <rect x="13.8" y="5" width="3.2" height="14" rx="1"></rect>
            </svg>
          </button>
        </div>
      </div>


      <!-- Back to top -->
      <button id="backTop"
              class="fixed right-4 bottom-4 hidden px-3 py-2 rounded-full border border-black/10 bg-white shadow-soft text-sm"
              aria-label="Back to top">↑ Top</button>

      <!-- Footer -->
      <footer class="mt-16 bg-white border-t border-black/10 text-sm text-ink-500">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 grid sm:grid-cols-2 md:grid-cols-4 gap-10">
          <div>
            <div class="-ml-1.5">
              <div class="flex items-center gap-1">
                <img src="assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
                <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
              </div>
            </div>
            <p class="mt-2 text-ink-400 text-sm max-w-xs">
              Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
            </p>
          </div>
          <div>
            <h3 class="font-semibold text-ink-900 mb-3">Explore</h3>
            <ul class="space-y-2">
              <li><a href="features.html" class="u-underline">Features</a></li>
              <li><a href="latest.html" class="u-underline">Latest</a></li>
              <li><a href="sections.html" class="u-underline">Sections</a></li>
              <li><a href="archive.html" class="u-underline">Archive</a></li>
              <li><a href="search.html" class="u-underline">Search</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-ink-900 mb-3">About</h3>
            <ul class="space-y-2">
              <li><a href="about2.html" class="u-underline">About</a></li>
              <li><a href="contact.html" class="u-underline">Contact</a></li>
              <li><a href="mission.html" class="u-underline">Mission</a></li>
              <li><a href="resume.html" class="u-underline">Résumé</a></li>
              <li><a href="newsletter.html" class="u-underline">Newsletter</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-ink-900 mb-3">Follow</h3>
            <ul class="space-y-2">
              <li><a href="https://instagram.com" class="u-underline">Instagram</a></li>
              <li><a href="https://twitter.com" class="u-underline">X / Twitter</a></li>
              <li><a href="https://facebook.com" class="u-underline">Facebook</a></li>
              <li><a href="https://linkedin.com" class="u-underline">Linkedin</a></li>
              <li><a href="https://youtube.com" class="u-underline">YouTube</a></li>
            </ul>
          </div>
        </div>
        <div class="text-center text-xs text-ink-300 border-t border-black/10 py-6">
          © <span id="year"></span> Camila Tiburcio Rubio. All rights reserved.
        </div>
      </footer>

      <!-- Define CURRENT so related-posts JS works -->
      <script>
        window.CURRENT = {
          slug: ${JSON.stringify(data.slug)},
          section: ${JSON.stringify(data.section || '')},
          tags: ${JSON.stringify(hasTags ? data.tags : [])},
          date: ${JSON.stringify(data.date)},
          title: ${JSON.stringify(data.title)}
        };
      <\/script>

      <script>
        (function(){
          const bar   = document.getElementById('progress-bar');
          const label = document.getElementById('progress-label');
          const textSpan = label ? label.querySelector('[data-progress-text]') : null;
          if (!bar) return;

          function onScroll(){
            const max = document.body.scrollHeight - innerHeight;
            const raw = max > 0 ? (scrollY / max) * 100 : 0;
            const pct = Math.max(0, Math.min(100, raw));

            bar.style.width = pct + '%';

            if (label && textSpan){
              if (pct < 5){
                label.style.display = 'none';
              } else if (pct >= 99){
                label.style.display = 'inline-flex';
                textSpan.textContent = 'Done';
              } else {
                label.style.display = 'inline-flex';
                textSpan.textContent = Math.round(pct) + '% read';
              }
            }
          }

          window.addEventListener('scroll', onScroll, { passive:true });
          onScroll();
        })();

        // Back/Top buttons
        (function () {
          const link = document.getElementById('backBtn');
          if (!link) return;
          const fallbackHref = link.getAttribute('href') || '/';
          link.addEventListener('click', (e) => {
            const ref = document.referrer;
            const sameOrigin = ref && new URL(ref, location.href).origin === location.origin;
            if (sameOrigin) { e.preventDefault(); history.back(); }
            else if (!ref)  { link.setAttribute('href', fallbackHref); }
            else            { link.setAttribute('href', fallbackHref); }
          });
        })();

        const backTop = document.getElementById('backTop');
        const toggleTop = () => {
          if (window.scrollY > 600) backTop.classList.remove('hidden');
          else backTop.classList.add('hidden');
        };
        window.addEventListener('scroll', toggleTop, { passive:true });
        backTop.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

        (function addDropcap(){
          const firstP = document.querySelector('article.prose p');
          if(firstP) firstP.classList.add('dropcap');
        })();

        (function enhanceBibliographyOnPage() {
          var article = document.querySelector('article.prose');
          if (!article) return;

          // 1) Find the “Bibliography / References / Works Cited” heading
          var headings = Array.prototype.filter.call(
            article.querySelectorAll('h2'),
            function (h) {
              var text = (h.textContent || '').trim().toLowerCase();
              return (
                text === 'bibliography' ||
                text === 'references' ||
                text === 'works cited'
              );
            }
          );

          if (!headings.length) return;

          var h = headings[0];
          var parent = h.parentNode;
          if (!parent) return;

          // 2) Wrap the heading + following content until next H1/H2
          var wrapper = document.createElement('section');
          wrapper.className = 'bibliography-section';
          parent.insertBefore(wrapper, h);

          var node = h;
          while (node) {
            var next = node.nextSibling;
            wrapper.appendChild(node);

            if (next && next.nodeType === 1) {
              var tag = next.tagName;
              if (tag === 'H1' || tag === 'H2') {
                break;
              }
            }
            node = next;
          }

          // 3) Turn either <li> OR <p> references into .bibliography-items
          var index = 1;
          Array.prototype.forEach.call(
            wrapper.querySelectorAll('ol li, ul li, p'),
            function (item) {
              var raw = (item.textContent || '').trim();

              // If the text already starts with "1. ...", strip that out
              // and keep the number as data-bib-index.
              var m = raw.match(/^(\d+)\.\s*(.*)$/);
              if (m) {
                item.textContent = m[2];          // drop the "1." in the visible text
                item.setAttribute('data-bib-index', m[1]);
              } else {
                item.setAttribute('data-bib-index', String(index));
              }

              item.classList.add('bibliography-item');
              index++;
            }
          );
        })();


        // Share links
        (function(){
          const url  = encodeURIComponent(location.href);
          const text = encodeURIComponent(document.title || 'Check this out');
          const x    = document.getElementById('share-x');
          const fb   = document.getElementById('share-fb');
          const mail = document.getElementById('share-mail');
          const copy = document.getElementById('share-copy');
          if (x)  x.href  = 'https://twitter.com/intent/tweet?text=' + text + '&url=' + url;
          if (fb) fb.href = 'https://www.facebook.com/sharer/sharer.php?u=' + url;
          if (mail){
            mail.href = 'mailto:?subject=' + text + '&body=' + url;
            mail.addEventListener('click', async (e) => {
              if (navigator.share) { e.preventDefault(); try { await navigator.share({ title: document.title, url: location.href }); } catch {} }
            });
          }
          if (copy){
            copy.addEventListener('click', async () => {
              try { await navigator.clipboard.writeText(location.href); copy.style.transform = 'scale(0.96)'; setTimeout(function(){ copy.style.transform = ''; }, 120); }
              catch { alert("Couldn't copy the link."); }
            });
          }
        })();

        // Jump-to-section menu (auto from <h2> headings)
        // Jump-to-section menu (auto from <h2> headings)
        (function setupJumpMenu(){
          const article    = document.querySelector('article.prose');
          const mobileBox  = document.getElementById('jumpMenu');
          const mobileList = document.getElementById('jumpMobileList');
          const toggleBtn  = document.getElementById('jumpToggleBtn');

          if (!article) return;

          const headings = Array.from(article.querySelectorAll('h2'));
          if (headings.length < 2) {
            if (mobileBox) mobileBox.classList.add('hidden');
            return;
          }

          function makeId(text, index){
            var slug = (text || '')
              .toLowerCase()
              .replace(/[^\w]+/g, '-')
              .replace(/^-+|-+$/g, '');
            if (!slug) slug = 'section-' + (index + 1);
            if (!document.getElementById(slug)) return slug;
            return slug;
          }

          const items = headings.map(function(h, index){
            const label = (h.textContent || '').trim() || ('Section ' + (index + 1));
            const id    = h.id || makeId(label, index);
            if (!h.id) h.id = id;
            return { id: id, label: label, el: h };
          });

          const headerOffset = 90;

          function scrollToId(id){
            const target = document.getElementById(id);
            if (!target) return;
            const top = target.getBoundingClientRect().top + window.scrollY - headerOffset;
            window.scrollTo({ top: top, behavior: 'smooth' });
          }

          // Mobile dropdown
          if (mobileBox && mobileList && toggleBtn){
            mobileBox.classList.remove('hidden');
            mobileList.innerHTML = '';

            items.forEach(function(item){
              const b = document.createElement('button');
              b.type = 'button';
              b.textContent = item.label;
              b.className =
                'block w-full text-left text-sm text-ink-500 hover:text-ink-900 py-1';
              b.addEventListener('click', function () {
                scrollToId(item.id);
                mobileList.classList.add('hidden');
              });
              mobileList.appendChild(b);
            });

            toggleBtn.addEventListener('click', function () {
              mobileList.classList.toggle('hidden');
            });
          }

          // Desktop floating pill
          let desktopCard = document.getElementById('jumpFloatingDesktop');
          if (!desktopCard){
            desktopCard = document.createElement('aside');
            desktopCard.id = 'jumpFloatingDesktop';
            desktopCard.innerHTML =
              '<div class="jump-card-inner">' +
                '<p class="jump-label">Jump to</p>' +
                '<ul class="jump-list"></ul>' +
              '</div>';
            document.body.appendChild(desktopCard);
          }

          const ul = desktopCard.querySelector('ul');
          ul.innerHTML = '';

          items.forEach(function(item, idx){
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = item.label;
            btn.dataset.id = item.id;
            if (idx === 0) btn.dataset.active = 'true';
            btn.addEventListener('click', function () { scrollToId(item.id); });

            const li = document.createElement('li');
            li.appendChild(btn);
            ul.appendChild(li);
          });

          function updateActive(){
            const scrollPos = window.scrollY + headerOffset + 10;
            let currentIndex = 0;

            items.forEach(function(item, idx){
              const top = item.el.getBoundingClientRect().top + window.scrollY;
              if (top <= scrollPos) currentIndex = idx;
            });

            const buttons = desktopCard.querySelectorAll('button');
            buttons.forEach(function(btn, idx){
              btn.dataset.active = idx === currentIndex ? 'true' : 'false';
            });
          }

          // NEW: fade-in behavior when scrolling down a bit
          function updateVisibility() {
            if (window.scrollY > 320) {
              desktopCard.classList.add('jump-visible');
            } else {
              desktopCard.classList.remove('jump-visible');
            }
          }

          window.addEventListener('scroll', updateActive, { passive:true });
          window.addEventListener('scroll', updateVisibility, { passive:true });

          updateActive();
          updateVisibility();
        })();

        var TTS_TOTAL_SECONDS = ${JSON.stringify((data.readMinutes || 1) * 60)};

                // Read-aloud / text-to-speech for article with progress + scrubbing
                // Read-aloud / text-to-speech with sticky bar + word highlight
        (function setupTTS() {
          if (!('speechSynthesis' in window)) {
            var btn = document.getElementById('ttsToggle');
            var bar = document.getElementById('ttsStickyBar');
            if (btn) btn.style.display = 'none';
            if (bar) bar.style.display = 'none';
            return;
          }

          var synth      = window.speechSynthesis;
          var article    = document.querySelector('article.prose');
          var listenBtn  = document.getElementById('ttsToggle');
          var stickyBar  = document.getElementById('ttsStickyBar');
          var playPause  = document.getElementById('ttsPlayPause');
          var range      = document.getElementById('ttsProgressRange');
          var label      = document.getElementById('ttsProgressLabel');
          var stopBtn    = document.getElementById('ttsStickyStop');

          if (!article || !listenBtn || !stickyBar || !playPause || !range || !label) return;

          /* ===========
             Sentence-level wrapping for highlight
          =========== */
          var sentenceSpans  = [];
          var sentenceStarts = [];
          var speechText     = '';
          var lastSentenceIndex = -1;

          function processTextNode(node) {
            var text = node.textContent;
            if (!text || !text.trim()) return;

            var frag = document.createDocumentFragment();
            var sentenceRegex = /[^.!?]+[.!?]+/g;
            var match;
            var lastIndex = 0;

            while ((match = sentenceRegex.exec(text)) !== null) {
              var sentence  = match[0];
              var startIdx  = match.index;

              if (startIdx > lastIndex) {
                var before = text.slice(lastIndex, startIdx);
                frag.appendChild(document.createTextNode(before));
                speechText += before;
              }

              var span = document.createElement('span');
              span.textContent = sentence;
              span.className = 'tts-sentence';
              span.setAttribute('data-sentence-index', String(sentenceSpans.length));

              sentenceSpans.push(span);
              sentenceStarts.push(speechText.length);
              speechText += sentence;

              frag.appendChild(span);
              lastIndex = startIdx + sentence.length;
            }

            if (lastIndex < text.length) {
              var tail = text.slice(lastIndex);
              frag.appendChild(document.createTextNode(tail));
              speechText += tail;
            }

            node.parentNode.replaceChild(frag, node);
          }

          function walk(node) {
            if (node.nodeType === Node.TEXT_NODE) {
              processTextNode(node);
              return;
            }
            if (node.nodeType !== Node.ELEMENT_NODE) return;
            if (node.classList && node.classList.contains('tts-sentence')) return;

            var child = node.firstChild;
            while (child) {
              var next = child.nextSibling;
              walk(child);
              child = next;
            }
          }

          walk(article);

          if (!speechText.trim().length || !sentenceSpans.length) {
            listenBtn.style.display = 'none';
            stickyBar.style.display = 'none';
            return;
          }

          var totalLength = speechText.length;

          /* ===========
             Time estimate fallback
          =========== */
          var wordsCount = speechText.split(/\s+/).filter(Boolean).length;
          var estimatedSeconds = Math.max(10, Math.round((wordsCount / 180) * 60));
          var totalSeconds =
            typeof window.TTS_TOTAL_SECONDS === 'number' && window.TTS_TOTAL_SECONDS > 0
              ? window.TTS_TOTAL_SECONDS
              : estimatedSeconds;

          function formatTime(sec) {
            sec = Math.max(0, Math.round(sec));
            var m = Math.floor(sec / 60);
            var s = sec % 60;
            return (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
          }

          /* ===========
             Highlight helpers
          =========== */
          function highlightSentence(index) {
            if (index < 0 || index >= sentenceSpans.length) return;
            if (lastSentenceIndex >= 0 && sentenceSpans[lastSentenceIndex]) {
              sentenceSpans[lastSentenceIndex].classList.remove('tts-sentence--active');
            }
            sentenceSpans[index].classList.add('tts-sentence--active');
            lastSentenceIndex = index;
          }

          function clearHighlight() {
            if (lastSentenceIndex >= 0 && sentenceSpans[lastSentenceIndex]) {
              sentenceSpans[lastSentenceIndex].classList.remove('tts-sentence--active');
            }
            lastSentenceIndex = -1;
          }

          function findSentenceIndexFromChar(charIndex) {
            if (!sentenceStarts.length) return -1;
            var lo = 0;
            var hi = sentenceStarts.length - 1;
            var ans = 0;

            while (lo <= hi) {
              var mid = (lo + hi) >> 1;
              if (sentenceStarts[mid] <= charIndex) {
                ans = mid;
                lo = mid + 1;
              } else {
                hi = mid - 1;
              }
            }
            return ans;
          }

          /* ===========
             Player State
          =========== */
          var utterance  = null;
          var isActive   = false;
          var isPlaying  = false;
          var isPaused   = false;
          var baseOffset = 0;
          var currentIdx = 0;

          function setPlayState(state) {
            playPause.setAttribute('data-state', state);

            var playIcon  = playPause.querySelector('[data-icon="play"]');
            var pauseIcon = playPause.querySelector('[data-icon="pause"]');

            if (state === 'playing') {
              playIcon.style.display = 'none';
              pauseIcon.style.display = 'block';
            } else {
              playIcon.style.display = 'block';
              pauseIcon.style.display = 'none';
            }
          }

          function updateProgressUI(percent) {
            var pct = Math.max(0, Math.min(100, percent));
            range.value = pct;

            var currentSeconds = (totalSeconds * pct) / 100;
            label.textContent = formatTime(currentSeconds) + ' / ' + formatTime(totalSeconds);

            var fill  = '#C53D2F';
            var track = 'rgba(15,23,42,0.08)';

            range.style.background =
              'linear-gradient(to right, '
              + fill  + ' 0%, '
              + fill  + ' ' + pct + '%, '
              + track + ' ' + pct + '%, '
              + track + ' 100%)';
          }

          function resetPlayback(keepProgress) {
            synth.cancel();
            utterance  = null;
            isPlaying  = false;
            isPaused   = false;
            baseOffset = 0;
            currentIdx = 0;
            setPlayState('paused');
            if (!keepProgress) {
              updateProgressUI(0);
              clearHighlight();
            }
          }

          function hideStickyBar() { stickyBar.style.display = 'none'; }
          function showStickyBar() { stickyBar.style.display = 'flex'; }

          function stopListeningMode() {
            resetPlayback(false);
            isActive = false;
            hideStickyBar();
            clearHighlight();
            listenBtn.textContent = 'Listen to article';
          }

          /* ===========
             Create utterance from offset
          =========== */
          function createUtteranceFromOffset(offset) {
            if (!totalLength) return;

            var clamped = Math.max(0, Math.min(totalLength - 1, offset));
            var slice   = speechText.slice(clamped);
            if (!slice.trim()) {
              resetPlayback(false);
              updateProgressUI(100);
              return;
            }

            synth.cancel();
            utterance = new SpeechSynthesisUtterance(slice);
            utterance.lang = 'en-US';
            utterance.rate = 1.0;

            baseOffset = clamped;
            currentIdx = 0;

            utterance.onboundary = function (e) {
              if (typeof e.charIndex === 'number') {
                currentIdx = e.charIndex;
                var absolute = baseOffset + currentIdx;
                var pct = (absolute / totalLength) * 100;
                updateProgressUI(pct);

                var sentenceIndex = findSentenceIndexFromChar(absolute);
                if (sentenceIndex >= 0) highlightSentence(sentenceIndex);
              }
            };

            utterance.onend = function () {
              isPlaying = false;
              isPaused = false;
              updateProgressUI(100);
              setPlayState('paused');
            };

            utterance.onerror = function () {
              resetPlayback(false);
            };

            isPlaying = true;
            isPaused  = false;
            setPlayState('playing');
            synth.speak(utterance);
          }

          /* ===========
             HANDLERS
          =========== */

          listenBtn.addEventListener('click', function () {
            if (!isActive) {
              isActive = true;
              showStickyBar();
              listenBtn.textContent = 'Stop listening';
              updateProgressUI(0);
              clearHighlight();
              createUtteranceFromOffset(0);
            } else {
              stopListeningMode();
            }
          });

          playPause.addEventListener('click', function () {
            if (!isActive) return;

            if (!isPlaying && !isPaused) {
              var pct = parseFloat(range.value) || 0;
              var offset = Math.floor((pct / 100) * totalLength);
              createUtteranceFromOffset(offset);
              return;
            }

            if (isPlaying && !isPaused) {
              synth.pause();
              isPaused = true;
              setPlayState('paused');
              return;
            }

            if (isPlaying && isPaused) {
              synth.resume();
              isPaused = false;
              setPlayState('playing');
            }
          });

          if (stopBtn) {
            stopBtn.addEventListener('click', function () {
              if (!isActive) return;
              stopListeningMode();
            });
          }

          range.addEventListener('input', function () {
            if (!isActive || !totalLength) return;

            var pct = Math.max(0, Math.min(100, parseFloat(range.value)));
            updateProgressUI(pct);

            var absolute = Math.floor((pct / 100) * totalLength);
            var sIdx = findSentenceIndexFromChar(absolute);
            if (sIdx >= 0) highlightSentence(sIdx);

            if (isPlaying) {
              createUtteranceFromOffset(absolute);
            }
          });

          window.addEventListener('beforeunload', function () {
            synth.cancel();
          });

          updateProgressUI(0);
        })();

        async function loadRelated () {
          const scrollerSection = document.getElementById('moreScroller');
          const scrollerTags    = document.getElementById('moreTagsScroller');
          const emptySection    = document.getElementById('moreSectionEmpty');
          const emptyTags       = document.getElementById('moreTagsEmpty');
          const sectionBlock    = document.getElementById('more');
          const tagsBlock       = document.getElementById('moreTags');

          if (!scrollerSection && !scrollerTags) return;

          function makeCard(p) {
            const card = document.createElement('a');
            card.href = p.url || (p.slug + '.html');
            card.className =
              'group relative shrink-0 w-[260px] sm:w-[280px] md:w-[320px] snap-start rounded-2xl border border-black/10 bg-white overflow-hidden hover:shadow-soft transition';

            if (p.cover) {
              const wrap = document.createElement('div');
              wrap.className = 'aspect-[16/9] w-full overflow-hidden bg-ink-900/5';

              const img = document.createElement('img');
              img.src = p.cover;
              img.alt = '';
              img.loading = 'lazy';
              img.className =
                'h-full w-full object-cover transition-transform duration-200 group-hover:scale-[1.03]';

              wrap.appendChild(img);
              card.appendChild(wrap);
            }

            const info = document.createElement('div');
            info.className = 'p-3';

            const sec = document.createElement('div');
            sec.className =
              'mb-1 text-[10px] tracking-[.14em] font-semibold uppercase text-accent';
            sec.textContent = p.section || '';
            info.appendChild(sec);

            const h3 = document.createElement('h3');
            h3.className = 'font-serif text-lg leading-snug text-ink-900 line-clamp-2';
            h3.textContent = p.title || '';
            info.appendChild(h3);

            const meta = document.createElement('div');
            meta.className = 'mt-1 text-xs text-ink-300';
            const dateStr = p.date
              ? new Date(p.date).toLocaleDateString(undefined, {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                })
              : '';
            meta.textContent =
              (dateStr ? dateStr + ' • ' : '') + (p.readMinutes || 1) + ' min read';
            info.appendChild(meta);

            card.appendChild(info);
            return card;
          }

          function setupButtons(prevId, nextId, scroller) {
            const prevBtn = document.getElementById(prevId);
            const nextBtn = document.getElementById(nextId);
            if (!scroller) return;

            const amount = function () { return Math.max(scroller.clientWidth * 0.7, 260); };

            if (prevBtn) {
              prevBtn.onclick = function () {
                scroller.scrollBy({ left: -amount(), behavior: 'smooth' });
              };
            }
            if (nextBtn) {
              nextBtn.onclick = function () {
                scroller.scrollBy({ left: amount(), behavior: 'smooth' });
              };
            }
          }

          try {
            const res = await fetch('posts.json', { cache: 'no-store' });
            if (!res.ok) throw new Error('posts.json not found');
            const list = await res.json();

            const currentSlug   = window.CURRENT && window.CURRENT.slug || '';
            const currentTags   = Array.isArray(window.CURRENT && window.CURRENT.tags) ? window.CURRENT.tags : [];
            const currentSection= window.CURRENT && window.CURRENT.section || '';

            const baseList = list.filter(function(p){ return p.slug !== currentSlug; });

            const usedSlugs = new Set();

            let sectionPicks = [];
            if (scrollerSection) {
              const scored = baseList
                .map(function(p){
                  const tags = Array.isArray(p.tags) ? p.tags : [];
                  const overlap = tags.filter(function(t){ return currentTags.includes(t); }).length;
                  const sameSection = p.section === currentSection ? 1 : 0;
                  return Object.assign({}, p, { score: sameSection * 3 + overlap });
                })
                .sort(function(a, b){
                  return (b.score - a.score) || (new Date(b.date) - new Date(a.date));
                });

              let pool = scored.filter(function(p){ return p.score > 0; });
              if (!pool.length) {
                pool = baseList
                  .filter(function(p){ return p.section === currentSection; })
                  .sort(function(a, b){ return new Date(b.date) - new Date(a.date); });

                if (!pool.length) {
                  pool = baseList.slice().sort(function(a, b){
                    return new Date(b.date) - new Date(a.date);
                  });
                }
              }

              sectionPicks = pool.slice(0, 6);

              if (!sectionPicks.length) {
                if (emptySection) emptySection.classList.remove('hidden');
              } else {
                scrollerSection.replaceChildren();
                sectionPicks.forEach(function(p){
                  usedSlugs.add(p.slug);
                  scrollerSection.appendChild(makeCard(p));
                });
                setupButtons('morePrev', 'moreNext', scrollerSection);
              }
            }

            if (scrollerTags && currentTags.length) {
              const tagCandidates = baseList.filter(function(p){ return !usedSlugs.has(p.slug); });

              let tagPicks = [];

              if (tagCandidates.length) {
                const tagScored = tagCandidates
                  .map(function(p){
                    const tags = Array.isArray(p.tags) ? p.tags : [];
                    const overlap = tags.filter(function(t){ return currentTags.includes(t); }).length;
                    return Object.assign({}, p, { overlap: overlap });
                  })
                  .filter(function(p){ return p.overlap > 0; })
                  .sort(function(a, b){
                    return (b.overlap - a.overlap) || (new Date(b.date) - new Date(a.date));
                  });

                tagPicks = tagScored.slice(0, 6);
              }

              if (!tagPicks.length) {
                const fallback = baseList
                  .filter(function(p){ return !usedSlugs.has(p.slug); })
                  .sort(function(a, b){ return new Date(b.date) - new Date(a.date); });

                tagPicks = fallback.slice(0, 6);
              }

              if (!tagPicks.length) {
                if (tagsBlock) tagsBlock.classList.add('hidden');
                else if (emptyTags) emptyTags.classList.remove('hidden');
              } else {
                scrollerTags.replaceChildren();
                tagPicks.forEach(function(p){
                  usedSlugs.add(p.slug);
                  scrollerTags.appendChild(makeCard(p));
                });
                setupButtons('moreTagsPrev', 'moreTagsNext', scrollerTags);
              }
            } else if (tagsBlock && !currentTags.length) {
              tagsBlock.classList.add('hidden');
            }
          } catch (e) {
            console.warn('Related articles unavailable:', e);
            if (sectionBlock) sectionBlock.classList.add('hidden');
            if (tagsBlock)   tagsBlock.classList.add('hidden');
          }
        }

        if (document.readyState !== 'loading') loadRelated();
        else document.addEventListener('DOMContentLoaded', loadRelated);
      <\/script>

    </body>
    </html>`;
    }

    /* ===============================
       GitHub PUBLISH ADD-ONS
    =============================== */
    const GH_OWNER  = 'MahmoudS1201';
    const GH_REPO   = 'CamilaTiburcioRubio';
    const GH_BRANCH = 'main';
    const GH_IMAGES_ROOT = 'images';
    let   GH_TOKEN = localStorage.getItem('ctr:gh:token') || '';

    function apiPath(p){ return (p||'').split('/').map(encodeURIComponent).join('/'); }
    function stripLeadingSlash(p){ return (p||'').replace(/^\/+/, ''); }
    function yyyymm(dateIso){
      const d = dateIso ? new Date(dateIso) : new Date();
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,'0');
      return `${y}/${m}`;
    }
    function b64utf8(s){ return btoa(unescape(encodeURIComponent(s))); }

    function ensureToken(){
      if (!GH_TOKEN) {
        GH_TOKEN = prompt('Paste a GitHub Personal Access Token (Contents: Read/Write for this repo):') || '';
        if (!GH_TOKEN) throw new Error('GitHub token required.');
        localStorage.setItem('ctr:gh:token', GH_TOKEN);
      }
    }

    async function gh(path, init={}){
      ensureToken();
      const res = await fetch('https://api.github.com' + path, {
        ...init,
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': 'token ' + GH_TOKEN,
          ...(init.headers || {})
        }
      });
      if (!res.ok){
        const t = await res.text();
        try { throw new Error(JSON.parse(t).message || t); }
        catch { throw new Error(t || (res.status + ' ' + res.statusText)); }
      }
      return res.json();
    }

    async function getRepoFile(path){
      try {
        const enc = apiPath(path);
        return await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${enc}?ref=${encodeURIComponent(GH_BRANCH)}`);
      } catch (e) {
        if (String(e.message).includes('Not Found')) return null;
        throw e;
      }
    }

    async function putRepoFile(path, base64Content, message){
      const existing = await getRepoFile(path);
      const sha = existing?.sha;
      const enc = apiPath(path);

      const res = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${enc}`, {
        method: 'PUT',
        body: JSON.stringify({
          message,
          content: base64Content,
          branch: GH_BRANCH,
          ...(sha ? { sha } : {})
        })
      });

      return res;
    }

    function dataUrlInfo(dataUrl){
      const m = /^data:([^;]+);base64,(.*)$/i.exec(dataUrl || "");
      if (!m) return null;
      return { mime: m[1].toLowerCase(), b64: m[2] };
    }
    function mimeToExt(mime){
      if (!mime) return 'bin';
      if (mime.includes('jpeg')) return 'jpg';
      if (mime.includes('png'))  return 'png';
      if (mime.includes('webp')) return 'webp';
      if (mime.includes('svg'))  return 'svg';
      if (mime.includes('gif'))  return 'gif';
      return 'bin';
    }
    function safeFilename(s, max=50){
      const base = (s || '').toLowerCase().replace(/[^a-z0-9-_]+/g, '-').replace(/-+/g,'-').replace(/^-|-$/g,'');
      return base.slice(0,max) || 'img';
    }

    async function uploadDataImageForPost(slug, dateIso, dataUrl, hintName='image'){
      const info = dataUrlInfo(dataUrl);
      if (!info) return dataUrl; // already a path

      const ext = mimeToExt(info.mime);
      const dir = `${GH_IMAGES_ROOT}/${yyyymm(dateIso)}/${slug}`;
      const file = `${dir}/${safeFilename(hintName)}.${ext}`;

      await putRepoFile(file, info.b64, `image: ${slug}/${hintName}.${ext}`);
      return file; // repo-relative path
    }

    async function uploadAndRewriteInlineImages(slug, dateIso, bodyMarkdown, bodyHtml, imageStore){
      if (!imageStore) return { bodyMarkdown, bodyHtml };
      const tokenRe = /\(ctr-img:([a-z0-9-]+)\)/ig;
      const seen = new Map();

      async function resolve(id){
        if (seen.has(id)) return seen.get(id);
        const dataUrl = imageStore[id];
        if (!dataUrl) return `ctr-img:${id}`;
        const path = await uploadDataImageForPost(slug, dateIso, dataUrl, `inline-${id}`);
        seen.set(id, path);
        return path;
      }

      async function rewrite(str){
        let out = ''; let last = 0; let m;
        while ((m = tokenRe.exec(str)) !== null){
          out += str.slice(last, m.index);
          const path = await resolve(m[1]);
          out += `(${path})`;
          last = m.index + m[0].length;
        }
        return out + str.slice(last);
      }

      return {
        bodyMarkdown: await rewrite(bodyMarkdown || ''),
        bodyHtml:     await rewrite(bodyHtml || '')
      };
    }

    function normalize(entry){
      return {
        slug: entry.slug,
        title: entry.title,
        section: entry.section,
        tags: Array.isArray(entry.tags) ? entry.tags : [],
        author: entry.author || 'Camila Tiburcio Rubio',
        excerpt: entry.excerpt || '',
        date: entry.date,
        readMinutes: entry.readMinutes || 1,
        featured: !!entry.featured,
        cover: entry.cover?.src ? stripLeadingSlash(entry.cover.src) : null,
        url: `${entry.slug}.html`
      };
    }

    async function pushPostsJson(entry){
      const path = 'posts.json';
      const existing = await getRepoFile(path);
      let list = [];

      if (existing && existing.content){
        try {
          const json = atob(existing.content.replace(/\n/g,''));
          list = JSON.parse(json);
          if (!Array.isArray(list)) list = [];
        } catch { list = []; }
      }

      const idx = list.findIndex(p => p.slug === entry.slug);
      if (idx >= 0) list[idx] = entry; else list.push(entry);

      list.sort((a,b) => new Date(b.date) - new Date(a.date));
      const contentB64 = b64utf8(JSON.stringify(list, null, 2));
      await putRepoFile(path, contentB64, `posts.json: ${entry.slug}`);
    }

    /* ===============================
       PUBLISH
    =============================== */
    document.getElementById('publishBtn').addEventListener('click', async () => {
      const data = collect();
      const errs = validate(data);
      if (errs.length){ alert('Please fix:\n' + errs.join('\n')); return; }

      try {
        data.slug = data.slug || (data.title ? data.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'') : String(Date.now()));
        data.date = data.date || new Date().toISOString();

        // Upload cover if it is a data URL
        if (data.cover?.src && /^data:/i.test(data.cover.src)) {
          const path = await uploadDataImageForPost(data.slug, data.date, data.cover.src, 'cover');
          data.cover.src = stripLeadingSlash(path);
        } else if (data.cover?.src) {
          data.cover.src = stripLeadingSlash(data.cover.src);
        }

        // Inline images
        const expanded = await uploadAndRewriteInlineImages(
          data.slug,
          data.date,
          data.bodyMarkdown || '',
          data.bodyHtml || '',
          data.images || inlineImageStore || {}
        );
        data.bodyMarkdown = expanded.bodyMarkdown;
        data.bodyHtml     = expanded.bodyHtml;

        data.status = 'published';

        // Small cache
        const tiny = (({ slug, title, date, readMinutes, section, author, excerpt, status }) =>
          ({ slug, title, date, readMinutes, section, author, excerpt, status }))(data);

        try { localStorage.setItem(`ctr:admin:published:${data.slug}`, JSON.stringify(tiny)); }
        catch (e) { console.warn('Skipping published cache (quota):', e); }

        try { localStorage.removeItem('ctr:admin:draft'); } catch {}

        // 1) Update posts.json (minimal entry)
        const entry = normalize({
          ...data,
          cover: data.cover ? { src: stripLeadingSlash(data.cover.src), alt: data.cover.alt || '' } : null
        });
        await pushPostsJson(entry);

        // 2) Commit full JSON source for future editing
        const jsonForRepo = { ...data };
        delete jsonForRepo.images; // images are now file paths in bodyMarkdown/bodyHtml
        const jsonContentB64 = b64utf8(JSON.stringify(jsonForRepo, null, 2));
        await putRepoFile(
          `data/posts/${data.slug}.json`,
          jsonContentB64,
          `data: ${data.slug}.json`
        );

        // 3) Commit the standalone article page
        const html = buildArticleHtml(data);
        const htmlRes = await putRepoFile(
          `${entry.url}`,
          b64utf8(html),
          `page: ${entry.slug}.html`
        );
        console.log('HTML commit response:', {
          path: htmlRes.content?.path,
          sha: htmlRes.content?.sha,
          url: htmlRes.content?.html_url
        });
        if (!htmlRes.content?.path) throw new Error('HTML commit returned no content.path');

        statusMsg.textContent = 'Published ✓ — page and posts.json committed';
        markClean();
        setTimeout(()=> statusMsg.textContent = '', 2500);
        openPublishModal();
        removeDraftForSlug(data.slug);

        try {
          if (!document.getElementById('draftsDrawer').classList.contains('hidden')) {
            renderDraftsList();
          }
        } catch (e) {
          console.warn('Could not refresh drafts list after publish', e);
        }

      } catch (e) {
        console.error(e);
        alert('Publish failed: ' + e.message);
      }
    });

    /* ===============================
       Clear draft
    =============================== */
    $('#clearDraftBtn').addEventListener('click', () => {
      if (confirm('Clear current draft from this browser?')) {
        localStorage.removeItem('ctr:admin:draft');
        location.reload();
      }
    });

    /* ===============================
       Init
    =============================== */
    (function init(){
      authorEl.value = 'Camila Tiburcio Rubio';
      dateEl.value = new Date().toISOString().slice(0,16);
      loadDraft();
      updateDerived();
      renderOutline();
      markClean();

      // Seed undo history with the loaded/initial state
      undoStack = [];
      redoStack = [];
      pushSnapshot();
      lastValue = bodyEl.value;
    })();
  </script>
</body>
</html>
