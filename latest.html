<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Latest — Camila Tiburcio Rubio</title>

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400..800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','sans-serif'],
            serif: ['Source Serif 4','Georgia','serif']
          },
          colors: {
            ink: { 900:'#0E0E0E',700:'#1F1F1F',500:'#3A3A3A',300:'#9CA3AF' },
            cream: '#FAF7F2',
            accent: { DEFAULT:'#C53D2F', dark:'#9E2F24', light:'#E95A49' }
          },
          boxShadow: { soft:'0 10px 30px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <style>
    .u-underline { position: relative; }
    .u-underline::after {
      content:''; position:absolute; left:0; bottom:-2px; height:2px; width:100%;
      background:currentColor; transform:scaleX(0); transform-origin:left; transition:transform .25s ease;
    }
    .u-underline:hover::after { transform:scaleX(1); }
    ::selection { background: rgba(197,61,47,0.15); }

    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden; }
    .chip { border:1px solid rgba(0,0,0,.10); border-radius:9999px; padding:.45rem .8rem; font-weight:600; font-size:.85rem; }
    .chip[data-active="true"] { background:rgba(197,61,47,.10); color:#C53D2F; border-color:rgba(197,61,47,.35); }
    mark.hl { background: rgba(197,61,47,.22); color:inherit; padding:0 .15em; border-radius:.25rem; }

    /* Hide native search clear buttons */
    input[type="search"]::-webkit-search-cancel-button,
    input[type="search"]::-webkit-search-decoration,
    input[type="search"]::-webkit-search-results-button,
    input[type="search"]::-webkit-search-results-decoration { -webkit-appearance:none; appearance:none; display:none; }
    input[type="search"]::-ms-clear { display:none; }

    /* Stretched-click cues */
    [data-href]{ transition: box-shadow .2s ease, transform .2s ease, background-color .2s ease; }
    [data-href]:hover{ transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06); }
    [data-href]:focus-visible{ outline:2px solid #C53D2F; outline-offset:2px; transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06); }
  </style>

  <!-- Canonical / Social -->
  <link rel="canonical" href="https://example.com/latest" />
  <meta property="og:type" content="website">
  <meta property="og:title" content="Latest — Camila Tiburcio Rubio">
  <meta property="og:description" content="Fresh essays, interviews, reviews, and visual stories.">
  <meta property="og:url" content="https://example.com/latest">
  <meta property="og:image" content="https://picsum.photos/1200/630?latest">
  <meta name="twitter:card" content="summary_large_image">
</head>

<body class="bg-cream text-ink-900 antialiased">
  <!-- Top strip -->
  <div class="bg-ink-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
      <p>New: Fall features now live — interviews, essays & visual art</p>
      <a href="Home.html#newsletter" class="u-underline">Subscribe</a>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-cream/80 bg-cream/95 border-b border-black/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <a href="index.html" class="flex items-center gap-2" aria-label="Home">
          <img src="assets/logo.png" alt="Camila Tiburcio Rubio logo" class="h-10 w-10 object-contain" />
          <span class="font-serif text-2xl tracking-tight">Camila Tiburcio Rubio</span>
        </a>

        <nav class="hidden md:flex items-center gap-8" aria-label="Primary">
          <a class="u-underline" href="features.html">Features</a>
          <a class="u-underline font-semibold text-accent" href="latest.html" aria-current="page">Latest</a>
          <a class="u-underline" href="sections.html">Sections</a>
          <a class="u-underline" href="about2.html">About</a>
        </nav>

        <!-- Header search -->
        <div class="hidden md:flex items-center gap-4">
          <label class="relative" aria-label="Search site">
            <input id="q-desktop" type="search" placeholder="Search…" class="pl-10 pr-9 py-2 rounded-full border border-black/10 bg-white/70 focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-ink-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke-width="2"/><path stroke-width="2" d="M21 21l-3.5-3.5"/></svg>
            <button id="qHeaderBtn" class="absolute right-2 top-1/2 -translate-y-1/2 text-ink-300 hover:text-ink-500" aria-label="Go to search">↵</button>
          </label>
        </div>

        <div class="md:hidden">
          <button id="menuToggle" class="p-2 rounded-md border border-black/10 focus:outline-none" aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">
            <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile dropdown -->
    <div id="mobileMenu" class="hidden md:hidden bg-cream border-t border-black/10">
      <nav class="px-4 py-4 space-y-3" aria-label="Mobile">
        <a class="block u-underline" href="features.html">Features</a>
        <a class="block u-underline font-semibold text-accent" href="latest.html" aria-current="page">Latest</a>
        <a class="block u-underline" href="sections.html">Sections</a>
        <a class="block u-underline" href="about2.html">About</a>
        <label class="relative block mt-3" aria-label="Search site">
          <input id="q-mobile" type="search" placeholder="Search..." class="w-full pl-10 pr-3 py-2 rounded-full border border-black/10 bg-white/70 focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
          <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-ink-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke-width="2"/><path stroke-width="2" d="M21 21l-3.5-3.5"/></svg>
        </label>
      </nav>
    </div>
  </header>

  <!-- Page header -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div class="flex items-end justify-between">
      <div>
        <div class="text-[10px] sm:text-xs tracking-[0.14em] font-semibold text-accent uppercase">Browse</div>
        <h1 class="font-serif text-4xl sm:text-5xl leading-tight mt-1">Latest</h1>
        <p class="text-ink-500 mt-2">Newest posts across all sections.</p>
      </div>
      <div class="hidden sm:flex items-center gap-2">
        <label class="text-sm text-ink-500" for="sort">Sort by</label>
        <select id="sort" class="px-3 py-2 rounded-xl border border-black/10 bg-white">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="title">Title (A–Z)</option>
          <option value="read">Read time</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Hero (newest overall) -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <article id="hero" class="grid lg:grid-cols-3 gap-8 items-stretch card hidden" data-href="#">
      <div class="lg:col-span-2">
        <img id="heroImg" class="w-full h-full object-cover aspect-[16/9]" src="" alt="Latest hero image">
      </div>
      <div class="p-6 sm:p-8 flex flex-col">
        <div class="flex items-center gap-3 text-xs uppercase tracking-wide text-accent">
          <span id="heroSection" class="bg-accent/10 text-accent px-2.5 py-1 rounded-full">Latest</span>
          <time id="heroDate" class="text-ink-300" datetime=""></time>
        </div>
        <h2 id="heroTitle" class="font-serif text-3xl mt-3 leading-tight"></h2>
        <p id="heroExcerpt" class="text-ink-500 mt-3"></p>
        <div class="mt-auto pt-5 flex items-center gap-4">
          <img id="heroAvatar" class="h-10 w-10 rounded-full object-cover" src="https://i.pravatar.cc/100?img=15" alt="Author avatar"/>
          <div>
            <p class="text-sm font-medium">By <a class="u-underline" href="about2.html">Camila Tiburcio Rubio</a></p>
            <p id="heroRead" class="text-xs text-ink-300"></p>
          </div>
        </div>
        <a id="heroLink" href="#" class="mt-4 inline-block u-underline">Read the story →</a>
      </div>
    </article>
  </section>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10">
    <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
      <div class="flex flex-wrap gap-2">
        <button class="chip" data-filter="all" data-active="true" aria-pressed="true">All</button>
        <button class="chip" data-filter="Essay">Essay</button>
        <button class="chip" data-filter="Interview">Interview</button>
        <button class="chip" data-filter="Review">Review</button>
        <button class="chip" data-filter="Visual">Visual</button>
        <button class="chip" data-filter="Community">Community</button>
        <button class="chip" data-filter="Memoirs">Memoirs</button>
      </div>
      <div class="flex items-center gap-3">
        <label class="sr-only" for="q-inline">Search title or tags</label>
        <input id="q-inline" type="search" placeholder="Search title or tags…" class="px-3 py-2 rounded-xl border border-black/10 bg-white w-64 max-w-full focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
        <label class="text-sm text-ink-500" for="pageSize">Per page</label>
        <select id="pageSize" class="px-3 py-2 rounded-xl border border-black/10 bg-white">
          <option>6</option><option selected>9</option><option>12</option><option>18</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>

    <!-- Pagination -->
    <div class="mt-6 flex items-center justify-between">
      <button id="prevBtn" class="px-4 py-2 rounded-full border border-black/10 hover:bg-white disabled:opacity-40 disabled:pointer-events-none">← Newer</button>
      <div class="text-sm text-ink-300">
        Page <span id="pageNum">1</span> of <span id="pageTotal">1</span> • <span id="countShown">0</span>/<span id="countTotal">0</span> posts
      </div>
      <button id="nextBtn" class="px-4 py-2 rounded-full border border-black/10 hover:bg-white disabled:opacity-40 disabled:pointer-events-none">Older →</button>
    </div>

    <!-- Card template -->
    <template id="cardTemplate">
      <article class="card flex flex-col" data-href="#">
        <img class="aspect-[16/10] object-cover" src="" alt="" />
        <div class="p-6 flex-1 flex flex-col">
          <div class="text-xs uppercase tracking-wide text-accent sectionLabel"></div>
          <h3 class="font-serif text-xl mt-2 leading-snug">
            <a class="u-underline link" href="#"></a>
          </h3>
          <p class="text-ink-500 mt-2 desc"></p>
          <div class="mt-auto pt-4 text-sm text-ink-300 meta"></div>
        </div>
      </article>
    </template>
  </main>

  <!-- Back to top -->
  <button id="backTop"
          class="fixed right-4 bottom-4 hidden px-3 py-2 rounded-full border border-black/10 bg-white shadow-soft text-sm"
          aria-label="Back to top">↑ Top</button>

  <!-- Footer -->
  <footer class="mt-16 bg-white border-t border-black/10 text-sm text-ink-500">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 grid sm:grid-cols-2 md:grid-cols-4 gap-10">
      <div>
        <div class="-ml-1.5">
          <div class="flex items-center gap-1">
            <img src="assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
            <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
          </div>
        </div>
        <p class="mt-2 text-ink-400 text-sm max-w-xs">
          Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
        </p>
      </div>
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Explore</h3>
        <ul class="space-y-2">
          <li><a href="features.html" class="u-underline">Features</a></li>
          <li><a href="latest.html" class="u-underline font-semibold text-accent">Latest</a></li>
          <li><a href="sections.html" class="u-underline">Sections</a></li>
          <li><a href="archive.html" class="u-underline">Archive</a></li>
          <li><a href="search.html" class="u-underline">Search</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">About</h3>
        <ul class="space-y-2">
          <li><a href="about2.html" class="u-underline">About</a></li>
          <li><a href="contact.html" class="u-underline">Contact</a></li>
          <li><a href="mission.html" class="u-underline">Mission</a></li>
          <li><a href="resume.html" class="u-underline">Résumé</a></li>
          <li><a href="newsletter.html" class="u-underline">Newsletter</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Follow</h3>
        <ul class="space-y-2">
          <li><a href="https://instagram.com" class="u-underline">Instagram</a></li>
          <li><a href="https://twitter.com" class="u-underline">X / Twitter</a></li>
          <li><a href="https://facebook.com" class="u-underline">Facebook</a></li>
          <li><a href="https://linkedin.com" class="u-underline">Linkedin</a></li>
          <li><a href="https://youtube.com" class="u-underline">YouTube</a></li>
        </ul>
      </div>
    </div>
    <div class="text-center text-xs text-ink-300 border-t border-black/10 py-6">
      © <span id="year"></span> Camila Tiburcio Rubio. All rights reserved.
    </div>
  </footer>

  <script>
    // ---------- Year + mobile menu ----------
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    menuToggle?.addEventListener('click', () => {
      const isHidden = mobileMenu.classList.toggle('hidden');
      menuToggle.setAttribute('aria-expanded', String(!isHidden));
    });

    // Back to top
    const backTop = document.getElementById('backTop');
    const toggleTop = () => { if (window.scrollY > 600) backTop.classList.remove('hidden'); else backTop.classList.add('hidden'); };
    window.addEventListener('scroll', toggleTop, { passive:true });
    backTop.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

    // ---------- GitHub Pages subpath helper ----------
    const basePath = location.pathname.replace(/[^/]*$/, ''); // e.g. "/CamilaTiburcioRubio/"
    function toBase(u){
      if (!u) return '';
      if (/^https?:\/\//i.test(u)) return u;                    // absolute URL
      if (u.startsWith('./') || u.startsWith('../')) return new URL(u, location.origin + basePath).pathname;
      if (u.startsWith('/')) return basePath + u.slice(1);      // strip leading slash to repo subdir
      return basePath + u;                                      // plain relative
    }

    // ---------- Header search routing ----------
    function goSearch(q){
      const term = (q || '').trim();
      const url = toBase(term ? `search.html?q=${encodeURIComponent(term)}` : `search.html`);
      window.location.href = url;
    }
    document.getElementById('qHeaderBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); goSearch(document.getElementById('q-desktop').value); });
    document.getElementById('q-desktop')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goSearch(e.target.value);} });
    document.getElementById('q-mobile')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goSearch(e.target.value);} });

    // ---------- Data loading ----------
    const FALLBACK = 'https://picsum.photos/seed/ctr-latest/1200/675';

    async function fetchPostsJson(){
      try{
        const res = await fetch(toBase('posts.json'), { cache:'no-store' });
        if(!res.ok) throw new Error('bad status');
        const data = await res.json();
        return Array.isArray(data) ? data : null;
      }catch{ return null; }
    }
    function loadPublishedLocal(){
      const out=[];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('ctr:admin:published:')){
          try{ const obj = JSON.parse(localStorage.getItem(k)); if(obj && obj.title) out.push(obj);}catch{}
        }
      }
      return out;
    }

    function canonicalSection(s=''){
      const x = String(s).trim().toLowerCase();
      if (x==='essays') return 'Essay';
      if (x==='interviews') return 'Interview';
      if (x==='reviews') return 'Review';
      if (x==='visuals') return 'Visual';
      if (x==='memoir' || x==='memoirs') return 'Memoirs';
      if (x==='communities') return 'Community';
      return x ? x.charAt(0).toUpperCase()+x.slice(1) : 'Essay';
    }

    function normalize(p){
      const slug = (p.slug || '').replace(/^\/+/,'').replace(/\.html$/,'');
      const href0 = (p.url && p.url.trim()) ? p.url.trim() : (slug ? `${slug}.html` : '#');
      const coverStr = typeof p.cover === 'string' ? p.cover : (p.cover && p.cover.src);
      const tagsArr = Array.isArray(p.tags) ? p.tags : (typeof p.tags==='string' ? p.tags.split(',').map(s=>s.trim()) : []);
      return {
        title:   p.title || '',
        section: canonicalSection(p.section || ''),
        href:    toBase(href0),
        excerpt: p.excerpt || p.description || '',
        date:    p.date || p.publishedAt || '',
        read:    p.readMinutes || p.read || '',
        tags:    tagsArr,
        cover:   coverStr ? toBase(coverStr) : FALLBACK
      };
    }

    // ---------- Elements ----------
    const hero    = document.getElementById('hero');
    const heroImg = document.getElementById('heroImg');
    const heroSection = document.getElementById('heroSection');
    const heroDate = document.getElementById('heroDate');
    const heroTitle = document.getElementById('heroTitle');
    const heroExcerpt = document.getElementById('heroExcerpt');
    const heroRead = document.getElementById('heroRead');
    const heroLink = document.getElementById('heroLink');

    const gridEl = document.getElementById('grid');
    const tpl = document.getElementById('cardTemplate');

    const chips = Array.from(document.querySelectorAll('.chip'));
    const qInline = document.getElementById('q-inline');
    const sortSel = document.getElementById('sort');
    const pageSizeSel = document.getElementById('pageSize');

    const pageNumEl = document.getElementById('pageNum');
    const pageTotalEl = document.getElementById('pageTotal');
    const countShownEl = document.getElementById('countShown');
    const countTotalEl = document.getElementById('countTotal');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // ---------- State ----------
    let ALL = [];
    let state = {
      filter: 'all',
      sort: 'new',
      page: 1,
      pageSize: parseInt(pageSizeSel.value,10) || 9,
      q: ''
    };

    // ---------- Helpers ----------
    const fmtDate = iso => { try { return new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});} catch { return ''; } };
    const esc = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    function highlight(text, rawTerm){
      if (!rawTerm) return String(text || '');
      const parts = String(rawTerm).trim().split(/\s+/).filter(w => w.length >= 2);
      if (!parts.length) return String(text || '');
      const pat = new RegExp('(' + parts.map(esc).join('|') + ')', 'ig');
      return String(text || '').replace(pat, '<mark class="hl">$1</mark>');
    }

    function buildCard(p, term){
      const node = tpl.content.cloneNode(true);
      const img = node.querySelector('img'); img.src = p.cover; img.alt = `${p.title} cover`;
      node.querySelector('.sectionLabel').textContent = p.section || 'Article';
      const a = node.querySelector('.link'); a.href = p.href; a.innerHTML = highlight(p.title, term);
      const desc = node.querySelector('.desc'); desc.innerHTML = highlight(p.excerpt || '', term);
      const meta = [];
      if (p.date) meta.push(fmtDate(p.date));
      if (p.read) meta.push(`${p.read} min`);
      node.querySelector('.meta').textContent = meta.join(' • ');

      // Stretched click
      const article = node.querySelector('article');
      article.setAttribute('data-href', p.href);
      return node;
    }

    function enableCardClicks(root=document){
      root.querySelectorAll('[data-href]').forEach(el => {
        if (el.__clickBound) return;
        el.__clickBound = true;
        el.classList.add('cursor-pointer');
        el.setAttribute('role','link');
        el.setAttribute('tabindex','0');
        el.addEventListener('click', e => {
          if (e.target.closest && e.target.closest('a')) return;
          const url = el.getAttribute('data-href');
          if (url) window.location.href = url;
        });
        el.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const url = el.getAttribute('data-href');
            if (url) window.location.href = url;
          }
        });
      });
    }

    function applyFilters(list){
      const norm = s => (s||'').toLowerCase();
      let out = list.slice();

      if (state.filter !== 'all'){
        const f = norm(state.filter);
        out = out.filter(p => norm(p.section) === f || (p.tags||[]).map(norm).includes(f));
      }

      if (state.q){
        const q = norm(state.q);
        out = out.filter(p =>
          norm(p.title).includes(q) || norm(p.excerpt).includes(q) || (p.tags||[]).some(t => norm(t).includes(q))
        );
      }

      out.sort((a,b) => {
        if (state.sort === 'title') return (a.title||'').localeCompare(b.title||'');
        if (state.sort === 'old')   return new Date(a.date||0) - new Date(b.date||0);
        if (state.sort === 'read')  return (a.read||0) - (b.read||0);
        return new Date(b.date||0) - new Date(a.date||0); // 'new'
      });

      return out;
    }

    function render(){
      const filtered = applyFilters(ALL);
      const total = filtered.length;

      // hero visible only on page 1 and when we have posts
      const heroVisible = (state.page === 1 && total > 0);
      if (heroVisible){
        const h = filtered[0];
        heroImg.src = h.cover; heroImg.alt = h.title || 'Latest hero image';
        heroSection.textContent = h.section || 'Latest';
        heroDate.textContent = fmtDate(h.date); heroDate.dateTime = h.date || '';
        heroTitle.innerHTML = highlight(h.title, state.q);
        heroExcerpt.innerHTML = highlight(h.excerpt || '', state.q);
        heroRead.textContent = h.read ? `${h.read} min read` : '';
        heroLink.href = h.href || '#';
        hero.setAttribute('data-href', h.href || '#');
        hero.classList.remove('hidden');
        enableCardClicks(hero.parentElement);
      } else {
        hero.classList.add('hidden');
      }

      const perPage = state.pageSize;
      const pages = Math.max(1, Math.ceil((total - (heroVisible ? 1 : 0)) / perPage));
      if (state.page > pages) state.page = pages;

      // slice grid items (skip hero if shown)
      const start = heroVisible ? 1 + (state.page - 1) * perPage : (state.page - 1) * perPage;
      const end = start + perPage;
      const pageItems = filtered.slice(start, end);

      // render grid
      gridEl.innerHTML = '';
      const term = (state.q || '').trim();
      pageItems.forEach(p => gridEl.appendChild(buildCard(p, term)));
      enableCardClicks(gridEl);

      // footer stats + buttons
      pageNumEl.textContent = String(state.page);
      pageTotalEl.textContent = String(pages);
      countShownEl.textContent = String(pageItems.length + (heroVisible ? 1 : 0));
      countTotalEl.textContent = String(total);
      prevBtn.disabled = state.page <= 1;
      nextBtn.disabled = state.page >= pages;
    }

    // ---------- Events ----------
    document.querySelectorAll('.chip').forEach(chip => chip.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(c => { c.dataset.active = 'false'; c.setAttribute('aria-pressed','false'); });
      chip.dataset.active = 'true'; chip.setAttribute('aria-pressed','true');
      state.filter = chip.dataset.filter || 'all';
      state.page = 1;
      render();
    }));
    qInline?.addEventListener('input', (e)=>{ state.q = e.target.value; state.page = 1; render(); });
    sortSel?.addEventListener('change', ()=>{ state.sort = sortSel.value; state.page = 1; render(); });
    pageSizeSel.addEventListener('change', ()=>{ state.pageSize = parseInt(pageSizeSel.value,10)||9; state.page = 1; render(); });
    prevBtn.addEventListener('click', ()=>{ state.page = Math.max(1, state.page - 1); render(); });
    nextBtn.addEventListener('click', ()=>{ state.page = state.page + 1; render(); });

    // ---------- Init ----------
    (async function init(){
      let data = await fetchPostsJson();
      if (!data || !data.length){
        const local = loadPublishedLocal();
        if (local.length) data = local;
      }
      if (!data) data = [];

      ALL = data.map(normalize).sort((a,b)=> new Date(b.date||0)-new Date(a.date||0));
      render();
    })();
  </script>
</body>
</html>
