<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search — Camila Tiburcio Rubio</title>

  <!-- SEO -->
  <meta name="robots" content="noindex,follow" />
  <meta name="description" content="Search essays, interviews, reviews, and visual work by Camila Tiburcio Rubio." />

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400..800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','sans-serif'],
            serif: ['Source Serif 4','Georgia','serif']
          },
          colors: {
            ink: { 900:'#0E0E0E',700:'#1F1F1F',500:'#3A3A3A',400:'#6B7280',300:'#9CA3AF' },
            cream:'#FAF7F2',
            accent:{ DEFAULT:'#C53D2F', dark:'#9E2F24', light:'#E95A49' }
          },
          boxShadow:{ soft:'0 10px 30px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <style>
    .u-underline{position:relative}
    .u-underline::after{content:'';position:absolute;left:0;bottom:-2px;height:2px;width:100%;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .25s ease}
    .u-underline:hover::after{transform:scaleX(1)}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    ::selection{background:rgba(197,61,47,.15)}
    .result-title mark,.result-excerpt mark{background:rgba(197,61,47,.15);padding:0 .125rem;border-radius:.2rem}

    @keyframes fadeInPage {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    body.fade-in-page {
      animation: fadeInPage 0.35s ease-out;
    }

    /* full-card click affordance (same as other pages) */
    [data-href]{
      transition: box-shadow .2s ease, transform .2s ease, background-color .2s ease;
      cursor: pointer;
    }
    [data-href]:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06);
      background:#fff;
    }
    [data-href]:focus-visible{
      outline: 2px solid #C53D2F;
      outline-offset: 2px;
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06);
    }

    /* Number badge */
    .num-badge{
      position:absolute; top:.5rem; left:.5rem;
      background:rgba(229, 90, 73, .95);
      color:white; font-weight:700; font-size:.85rem;
      border-radius:.65rem; padding:.25rem .5rem;
      line-height:1;
    }

    /* hide native clear buttons */
    input[type="search"]::-webkit-search-cancel-button,
    input[type="search"]::-webkit-search-decoration,
    input[type="search"]::-webkit-search-results-button,
    input[type="search"]::-webkit-search-results-decoration { -webkit-appearance:none; appearance:none; display:none; }
    input[type="search"]::-ms-clear { display:none; }
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SearchResultsPage",
    "about": { "@type":"WebSite", "name":"Camila Tiburcio Rubio" }
  }
  </script>
</head>
<body class="bg-cream text-ink-900 antialiased fade-in-page">
  <!-- Top strip -->
  <div class="bg-ink-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
      <p>New: Fall features now live — interviews, essays & visual art</p>
      <a href="../newsletter/" class="u-underline">Subscribe</a>
    </div>
  </div>

    <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-cream/80 bg-cream/95 border-b border-black/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Brand: Lot K8 + subtitle -->
        <a href="../" class="flex items-center gap-3 group" aria-label="Home">
          <img
            src="../assets/logo.png"
            alt="Lot K8 logo"
            class="h-12 w-12 object-contain transition group-hover:opacity-90"
          />
          <div class="flex flex-col leading-tight">
            <span class="font-serif text-2xl tracking-[0.015em]">
              Lot K8
            </span>
            <span class="text-xs text-ink-300 tracking-wide -mt-0.5">
              Essays, interviews & visual culture
            </span>
          </div>
        </a>

        <!-- Desktop nav -->
        <nav class="hidden md:flex items-center gap-8" aria-label="Primary">
          <a class="u-underline" href="../features/">Features</a>
          <a class="u-underline" href="../latest/">Latest</a>
          <a class="u-underline" href="../sections/">Sections</a>
          <a class="u-underline" href="../about/">About</a>
        </nav>

        <!-- Mobile home link -->
        <a href="../" class="md:hidden u-underline text-sm">Home</a>
      </div>
    </div>
  </header>


  <!-- Search -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="font-serif text-3xl sm:text-4xl">Search</h1>

    <form id="searchForm" class="mt-5 grid gap-3 sm:grid-cols-[1fr,200px]">
      <label class="relative">
        <input id="q" name="q" type="search" autocomplete="off" placeholder="Search essays, interviews, reviews…" class="w-full pl-10 pr-10 py-3 rounded-xl border border-black/10 bg-white outline-none focus:ring-2 focus:ring-accent/40" aria-label="Search query" />
        <button type="button" id="clearQ" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-ink-300 hover:text-ink-500" aria-label="Clear search">✕</button>
      </label>
      <select id="sectionFilter" class="px-3 py-3 rounded-xl border border-black/10 bg-white outline-none focus:ring-2 focus:ring-accent/40" aria-label="Filter by section">
        <option value="">All sections</option>
      </select>
    </form>

    <!-- Stats / controls -->
    <div class="mt-6 flex flex-wrap items-center justify-between gap-3 text-sm text-ink-400">
      <div id="resultCount" aria-live="polite">0 results</div>

      <div class="flex items-center gap-2">
        <label class="mr-2" for="sortBy">Sort:</label>
        <select id="sortBy" class="px-3 py-2 rounded-lg border border-black/10 bg-white">
          <option value="best">Best match</option>
          <option value="dateDesc">Newest</option>
          <option value="dateAsc">Oldest</option>
          <option value="titleAsc">Title A–Z</option>
          <option value="titleDesc">Title Z–A</option>
        </select>

        <!-- View toggle + Numbered -->
        <div class="ml-4 inline-flex rounded-lg overflow-hidden border border-black/10">
          <button id="modeGrid" type="button" class="px-3 py-2 bg-white text-ink-500 hover:text-ink-900">Grid</button>
          <button id="modeList" type="button" class="px-3 py-2 bg-white text-ink-500 hover:text-ink-900">List</button>
        </div>
        <button id="toggleNums" type="button" class="px-3 py-2 rounded-lg border border-black/10 bg-white hover:shadow-soft">Numbered</button>
      </div>
    </div>

    <!-- Results -->
    <section id="results" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></section>

    <!-- Empty state -->
    <div id="emptyState" class="hidden mt-10 card p-8 text-center">
      <p class="text-lg">No matches yet.</p>
      <p class="text-ink-500 mt-1">Try different keywords or browse these:</p>
      <div class="mt-4 flex flex-wrap gap-3 justify-center">
        <a href="../features/" class="px-4 py-2 rounded-xl border border-black/10 hover:shadow-soft bg-white">Features</a>
        <a href="../latest/" class="px-4 py-2 rounded-xl border border-black/10 hover:shadow-soft bg-white">Latest</a>
        <a href="../sections/" class="px-4 py-2 rounded-xl border border-black/10 hover:shadow-soft bg-white">Sections</a>
      </div>
    </div>
  </main>

  <!-- Back to top -->
  <button id="backTop"
          class="fixed right-4 bottom-4 hidden px-3 py-2 rounded-full border border-black/10 bg-white shadow-soft text-sm"
          aria-label="Back to top">↑ Top</button>

  <!-- Footer -->
  <footer class="mt-16 bg-white border-t border-black/10 text-sm text-ink-500">
    <!-- Desktop / tablet grid footer -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 hidden sm:grid sm:grid-cols-2 md:grid-cols-4 gap-10">
      <!-- Brand -->
      <div>
        <div class="-ml-1.5">
          <div class="flex items-center gap-1">
            <img src="../assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
            <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
          </div>
        </div>
        <p class="mt-2 text-ink-400 text-sm max-w-xs">
          Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
        </p>
      </div>
      <!-- Explore -->
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Explore</h3>
        <ul class="space-y-2">
          <li><a href="../features/" class="u-underline">Features</a></li>
          <li><a href="../latest/" class="u-underline">Latest</a></li>
          <li><a href="../sections/" class="u-underline">Sections</a></li>
          <li><a href="../archive/" class="u-underline">Archive</a></li>
          <li><a href="../search/" class="u-underline font-semibold text-accent" aria-current="page">Search</a></li>
        </ul>
      </div>
      <!-- About -->
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">About</h3>
        <ul class="space-y-2">
          <li><a href="../about/" class="u-underline">About</a></li>
          <li><a href="../contact/" class="u-underline">Contact</a></li>
          <li><a href="../mission/" class="u-underline">Mission</a></li>
          <li><a href="../resume/" class="u-underline">Résumé</a></li>
          <li><a href="../newsletter/" class="u-underline">Newsletter</a></li>
        </ul>
      </div>
      <!-- Follow -->
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Follow</h3>
        <ul class="space-y-2">
          <li><a href="https://instagram.com" class="u-underline">Instagram</a></li>
          <li><a href="https://twitter.com" class="u-underline">X / Twitter</a></li>
          <li><a href="https://facebook.com" class="u-underline">Facebook</a></li>
          <li><a href="https://linkedin.com" class="u-underline">Linkedin</a></li>
          <li><a href="https://youtube.com" class="u-underline">YouTube</a></li>
        </ul>
      </div>
    </div>

    <!-- Mobile accordion footer -->
    <div class="sm:hidden border-t border-black/10">
      <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Brand -->
        <div class="mb-6">
          <div class="-ml-1.5">
            <div class="flex items-center gap-1">
              <img src="../assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
              <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
            </div>
          </div>
          <p class="mt-2 text-ink-400 text-sm max-w-xs">
            Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
          </p>
        </div>

        <!-- Explore -->
        <div class="border-t border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="explore"
            aria-expanded="false"
          >
            <span>Explore</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="explore"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="explore">
            <a href="../features/" class="block u-underline">Features</a>
            <a href="../latest/" class="block u-underline">Latest</a>
            <a href="../sections/" class="block u-underline">Sections</a>
            <a href="../archive/" class="block u-underline">Archive</a>
            <a href="../search/" class="block u-underline font-semibold text-accent" aria-current="page">Search</a>
          </div>
        </div>

        <!-- About -->
        <div class="border-t border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="about"
            aria-expanded="false"
          >
            <span>About</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="about"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="about">
            <a href="../about/" class="block u-underline">About</a>
            <a href="../contact/" class="block u-underline">Contact</a>
            <a href="../mission/" class="block u-underline">Mission</a>
            <a href="../resume/" class="block u-underline">Résumé</a>
            <a href="../newsletter/" class="block u-underline">Newsletter</a>
          </div>
        </div>

        <!-- Follow -->
        <div class="border-t border-black/10 border-b border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="follow"
            aria-expanded="false"
          >
            <span>Follow</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="follow"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="follow">
            <a href="https://instagram.com" class="block u-underline">Instagram</a>
            <a href="https://twitter.com" class="block u-underline">X / Twitter</a>
            <a href="https://facebook.com" class="block u-underline">Facebook</a>
            <a href="https://linkedin.com" class="block u-underline">Linkedin</a>
            <a href="https://youtube.com" class="block u-underline">YouTube</a>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center text-xs text-ink-300 border-t border-black/10 py-6">
      © <span id="year"></span> Camila Tiburcio Rubio. All rights reserved.
    </div>
  </footer>

  <script>
    /* ===== Subpath helper (same as index.html) ===== */
    function toRoot(path) {
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path;        // leave absolute URLs alone
      path = path.replace(/^\.?\//, '');                  // strip leading "./" or "/"
      return '../' + path;                                // go up one level
    }

    // Back to top
    const backTop = document.getElementById('backTop');
    const toggleTop = () => { if (window.scrollY > 600) backTop.classList.remove('hidden'); else backTop.classList.add('hidden'); };
    window.addEventListener('scroll', toggleTop, { passive:true });
    backTop.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    /* ===== Data loader (same as index) ===== */
    async function loadPosts(){
      const url = toRoot('posts.json');
      const res = await fetch(toRoot('posts.json'), { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to load ${url} (${res.status})`);
      const arr = await res.json();
      return arr.map(normalize).sort(byNewest);
    }
    function normalize(item){
      const href  = item.url || (item.slug ? `${item.slug}.html` : '#');
      const cover = (typeof item.cover === 'string' ? item.cover : (item.cover && item.cover.src)) || '';
      const tags  = Array.isArray(item.tags) ? item.tags :
                    (typeof item.tags === 'string' ? item.tags.split(',').map(s=>s.trim()).filter(Boolean) : []);
      return {
        title: item.title || '',
        href: toRoot(href),
        section: item.section || 'Article',
        excerpt: item.excerpt || item.description || '',
        date: item.date || '',
        readMinutes: item.readMinutes || '',
        cover: cover ? toRoot(cover) : '',
        tags,
        bodyText: String(item.bodyMarkdown || item.bodyHtml || '').replace(/<[^>]+>/g,' ')
      };
    }
    const byNewest = (a,b)=> new Date(b.date) - new Date(a.date);
    const fmtDate = iso => { try { return new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});} catch { return ''; } };

    /* ===== Search utilities ===== */
    const WORDS_RE = /[a-z0-9\u00C0-\u017F]+/gi;
    const words = s => (String(s||'').toLowerCase().match(WORDS_RE) || []);
    const esc = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    function highlight(text='', terms=[]){
      if (!terms.length || !text) return String(text || '');
      const pat = new RegExp('(' + terms.map(esc).join('|') + ')', 'ig');
      return String(text).replace(pat, '<mark>$1</mark>');
    }
    function matchesQuery(post, qTerms){
      if (!qTerms.length) return true;
      const fields = [
        post.title.toLowerCase(),
        post.excerpt.toLowerCase(),
        post.section.toLowerCase(),
        (post.tags||[]).join(' ').toLowerCase(),
        post.bodyText.toLowerCase()
      ];
      return fields.some(f => qTerms.every(t => f.includes(t)));
    }
    function sortItems(arr, mode){
      if (mode === 'dateAsc')  return arr.sort((a,b)=> new Date(a.date) - new Date(b.date));
      if (mode === 'dateDesc') return arr.sort((a,b)=> new Date(b.date) - new Date(a.date));
      if (mode === 'titleAsc') return arr.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      if (mode === 'titleDesc')return arr.sort((a,b)=> (b.title||'').localeCompare(a.title||''));
      return arr.sort((a,b)=> new Date(b.date) - new Date(a.date)); // 'best' → newest
    }
    function populateSectionsAll(items){
      const sel = document.getElementById('sectionFilter');
      const set = new Set(items.map(i => (i.section||'').trim()).filter(Boolean));
      sel.innerHTML = '<option value="">All sections</option>' +
        [...set].sort().map(s=>`<option value="${s}">${s}</option>`).join('');
    }

    /* ===== Full-card click behavior (same as other pages) ===== */
    function enableCardClicks(root=document){
      root.querySelectorAll('[data-href]').forEach(el => {
        if (el.__clickBound) return;
        el.__clickBound = true;
        el.setAttribute('role','link');
        el.setAttribute('tabindex','0');
        el.addEventListener('click', e => {
          if (e.target.closest && e.target.closest('a')) return;
          const url = el.getAttribute('data-href');
          if (url) window.location.href = url;
        });
        el.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const url = el.getAttribute('data-href');
            if (url) window.location.href = url;
          }
        });
      });
    }

    /* ===== Render ===== */
    const state = { mode:'grid', numbered:false }; // mode: 'grid' | 'list'
    function applyContainerLayout(){
      const wrap = document.getElementById('results');
      if (state.mode === 'list'){
        wrap.className = 'mt-6 space-y-4';
      } else {
        wrap.className = 'mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-8';
      }
    }

    function renderResults(list, qTerms){
      applyContainerLayout();
      const wrap = document.getElementById('results');
      wrap.innerHTML = '';

      document.getElementById('resultCount').textContent = `${list.length} ${list.length===1?'result':'results'}`;

      const empty = document.getElementById('emptyState');
      if (!list.length){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');

      list.forEach((it, idx) => {
        // CARD ROOT
        const card = document.createElement('article');
        card.setAttribute('data-href', it.href);

        if (state.mode === 'list'){
          card.className = 'bg-white rounded-2xl shadow-soft p-5 sm:p-6 flex gap-5 items-stretch';
        } else {
          card.className = 'bg-white rounded-2xl shadow-soft overflow-hidden flex flex-col';
        }

        // IMAGE
        if (it.cover){
          const img = document.createElement('img');
          img.alt = it.title || 'Cover image';
          img.loading = 'lazy';
          img.decoding = 'async';
          if (state.mode === 'list'){
            img.className = 'w-44 h-32 object-cover rounded-xl hidden sm:block';
          } else {
            img.className = 'aspect-[16/10] object-cover';
          }
          img.src = it.cover;
          card.appendChild(img);
        }

        // BODY
        const body = document.createElement('div');
        body.className = state.mode === 'list' ? 'flex-1 flex flex-col' : 'p-6 flex-1 flex flex-col';
        if (state.mode !== 'list' && !it.cover) body.classList.add('p-6');

        // number badge
        if (state.numbered){
          const badge = document.createElement('div');
          badge.className = 'num-badge';
          badge.textContent = (idx + 1) + '.';
          card.style.position = 'relative';
          card.appendChild(badge);
        }

        const meta = document.createElement('div');
        meta.className = 'text-xs uppercase tracking-wide text-accent';
        meta.textContent = it.section || 'Article';
        body.appendChild(meta);

        const h3 = document.createElement('h3');
        h3.className = state.mode === 'list' ? 'font-serif text-xl mt-1 leading-snug result-title' : 'font-serif text-xl mt-2 leading-snug result-title';
        h3.innerHTML = `<a class="u-underline" href="${it.href}">${highlight(it.title, qTerms)}</a>`;
        body.appendChild(h3);

        const p = document.createElement('p');
        p.className = 'text-ink-500 mt-2 result-excerpt';
        const raw = it.excerpt || (it.bodyText.slice(0,160)+'…');
        p.innerHTML = highlight(raw, qTerms);
        body.appendChild(p);

        // TAGS — accent scheme
        if (it.tags && it.tags.length){
          const tagsWrap = document.createElement('div');
          tagsWrap.className = 'mt-3 flex flex-wrap gap-2';
          it.tags.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = 'inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-accent/10 text-accent border border-accent/20 text-xs font-semibold';
            chip.innerHTML = highlight(tag, qTerms);
            tagsWrap.appendChild(chip);
          });
          body.appendChild(tagsWrap);
        }

        const f = document.createElement('div');
        f.className = 'mt-auto pt-4 text-sm text-ink-300';
        const bits = [];
        if (it.date) bits.push(fmtDate(it.date));
        if (it.readMinutes) bits.push(`${it.readMinutes} min`);
        f.textContent = bits.join(' • ');
        body.appendChild(f);

        card.appendChild(body);
        wrap.appendChild(card);
      });

      // activate stretched-click behavior
      enableCardClicks(wrap);
    }

    function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    const getParam = (name) => new URL(location.href).searchParams.get(name) || '';

    /* ===== Init ===== */
    (async function(){
      const ALL = await loadPosts();
      populateSectionsAll(ALL);

      const qInput = document.getElementById('q');
      const clearQ = document.getElementById('clearQ');
      const sectionSel = document.getElementById('sectionFilter');
      const sortSel = document.getElementById('sortBy');

      // controls
      const btnGrid = document.getElementById('modeGrid');
      const btnList = document.getElementById('modeList');
      const btnNums = document.getElementById('toggleNums');

      const initQ = getParam('q');
      if (initQ){ qInput.value = initQ; clearQ.classList.remove('hidden'); }

      function syncURL(){
        const u = new URL(location.href);
        const q = qInput.value.trim();
        if (q) u.searchParams.set('q', q); else u.searchParams.delete('q');
        history.replaceState({}, '', u.toString());
      }

      function run(){
        const q = qInput.value.trim();
        const qTerms = words(q);
        const sort = sortSel.value || 'best';

        // shrink section options based on query
        const allowed = new Set(ALL.filter(p => matchesQuery(p, qTerms)).map(p => p.section).filter(Boolean));
        const sel = sectionSel;
        const keep = sel.value;
        [...sel.options].forEach(opt => {
          if (opt.value === '') { opt.hidden = false; opt.disabled = false; return; }
          const ok = allowed.has(opt.value);
          opt.hidden = !ok; opt.disabled = !ok;
        });
        if (keep && !allowed.has(keep)) sel.value = '';

        const section = sectionSel.value;

        const filtered = ALL
          .filter(it => (!section || it.section === section))
          .filter(it => matchesQuery(it, qTerms));

        sortItems(filtered, sort === 'best' ? 'dateDesc' : sort);

        document.getElementById('resultCount').textContent = `${filtered.length} ${filtered.length===1?'result':'results'}`;

        renderResults(filtered, qTerms);
        clearQ.classList.toggle('hidden', q.length === 0);
      }

      document.getElementById('searchForm').addEventListener('submit', e => { e.preventDefault(); run(); syncURL(); });
      qInput.addEventListener('input', debounce(()=>{ run(); syncURL(); }, 120));
      clearQ.addEventListener('click', ()=>{ qInput.value=''; run(); syncURL(); qInput.focus(); });
      sectionSel.addEventListener('change', run);
      sortSel.addEventListener('change', run);

      // mode toggles
      btnGrid.addEventListener('click', () => { state.mode = 'grid'; btnGrid.classList.add('bg-accent','text-white'); btnList.classList.remove('bg-accent','text-white'); run(); });
      btnList.addEventListener('click', () => { state.mode = 'list'; btnList.classList.add('bg-accent','text-white'); btnGrid.classList.remove('bg-accent','text-white'); run(); });
      btnNums.addEventListener('click', () => { state.numbered = !state.numbered; btnNums.classList.toggle('bg-accent'); btnNums.classList.toggle('text-white'); run(); });

      // default active state
      btnGrid.classList.add('bg-accent','text-white');

      run();
    })().catch(err => {
      console.error('Search page failed:', err);
      document.getElementById('results').innerHTML =
        `<div class="card p-8 text-center text-ink-300">Couldn’t load posts.json</div>`;
    });

    /* ---------- Mobile footer accordion ---------- */
    document.querySelectorAll('[data-acc-btn]').forEach(btn => {
      const name = btn.getAttribute('data-acc-btn');
      const panel = document.querySelector(`[data-acc-panel="${name}"]`);
      const chevron = document.querySelector(`[data-acc-chevron="${name}"]`);

      if (!panel) return;

      btn.addEventListener('click', () => {
        const isOpen = !panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!isOpen));

        if (chevron) {
          chevron.classList.toggle('rotate-180', !isOpen);
        }
      });
    });
  </script>
</body>
</html>
