<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Latest — Camila Tiburcio Rubio</title>

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400..800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','sans-serif'],
            serif: ['Source Serif 4','Georgia','serif']
          },
          colors: {
            ink: { 900:'#0E0E0E',700:'#1F1F1F',500:'#3A3A3A',300:'#9CA3AF' },
            cream: '#FAF7F2',
            accent: { DEFAULT:'#C53D2F', dark:'#9E2F24', light:'#E95A49' }
          },
          boxShadow: { soft:'0 10px 30px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <style>
    .u-underline { position: relative; }
    .u-underline::after {
      content:''; position:absolute; left:0; bottom:-2px; height:2px; width:100%;
      background:currentColor; transform:scaleX(0); transform-origin:left; transition:transform .25s ease;
    }
    .u-underline:hover::after { transform:scaleX(1); }
    ::selection { background: rgba(197,61,47,0.15); }

    .author-link:hover .u-underline::after {
      transform: scaleX(1);
    }

    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden; }
    .chip { border:1px solid rgba(0,0,0,.10); border-radius:9999px; padding:.45rem .8rem; font-weight:600; font-size:.85rem; }
    .chip[data-active="true"] { background:rgba(197,61,47,.10); color:#C53D2F; border-color:rgba(197,61,47,.35); }
    mark.hl { background: rgba(197,61,47,.22); color:inherit; padding:0 .15em; border-radius:.25rem; }

    @keyframes fadeInPage {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    body.fade-in-page {
      animation: fadeInPage 0.35s ease-out;
    }

    /* Hide native search clear buttons */
    input[type="search"]::-webkit-search-cancel-button,
    input[type="search"]::-webkit-search-decoration,
    input[type="search"]::-webkit-search-results-button,
    input[type="search"]::-webkit-search-results-decoration { -webkit-appearance:none; appearance:none; display:none; }
    input[type="search"]::-ms-clear { display:none; }

    /* Stretched-click cues */
    [data-href]{ transition: box-shadow .2s ease, transform .2s ease, background-color .2s ease; }
    [data-href]:hover{ transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06); }
    [data-href]:focus-visible{ outline:2px solid #C53D2F; outline-offset:2px; transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06); }

    @media (prefers-reduced-motion: reduce){
      [data-href]{ transition: none !important; }
    }
  </style>

  <!-- Canonical / Social -->
  <link rel="canonical" href="https://example.com/latest" />
  <meta property="og:type" content="website">
  <meta property="og:title" content="Latest — Camila Tiburcio Rubio">
  <meta property="og:description" content="Fresh essays, interviews, reviews, and visual stories.">
  <meta property="og:url" content="https://example.com/latest">
  <meta property="og:image" content="https://picsum.photos/1200/630?latest">
  <meta name="twitter:card" content="summary_large_image">
</head>

<body class="bg-cream text-ink-900 antialiased fade-in-page">
  <!-- Top strip -->
  <div class="bg-ink-900 text-white text-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
      <p>New: Fall features now live — interviews, essays & visual art</p>
      <a href="../newsletter/" class="u-underline">Subscribe</a>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-cream/80 bg-cream/95 border-b border-black/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <a href="../" class="flex items-center gap-2" aria-label="Home">
          <img src="../assets/logo.png" alt="Camila Tiburcio Rubio logo" class="h-12 w-12 object-contain" />
          <span class="font-serif text-2xl tracking-tight">Camila Tiburcio Rubio</span>
        </a>

        <nav class="hidden md:flex items-center gap-8" aria-label="Primary">
          <a class="u-underline" href="../features/">Features</a>
          <a class="u-underline font-semibold text-accent" href="../latest/" aria-current="page">Latest</a>
          <a class="u-underline" href="../sections/">Sections</a>
          <a class="u-underline" href="../about/">About</a>
        </nav>

        <!-- Header search -->
        <div class="hidden md:flex items-center gap-4">
          <label class="relative" aria-label="Search site">
            <input id="q-desktop" type="search" placeholder="Search…" class="pl-10 pr-9 py-2 rounded-full border border-black/10 bg-white/70 focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-ink-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke-width="2"/><path stroke-width="2" d="M21 21l-3.5-3.5"/></svg>
            <button id="qHeaderBtn" class="absolute right-2 top-1/2 -translate-y-1/2 text-ink-300 hover:text-ink-500" aria-label="Go to search">↵</button>
          </label>
        </div>

        <div class="md:hidden">
          <button id="menuToggle" class="p-2 rounded-md border border-black/10 focus:outline-none" aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">
            <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile dropdown -->
    <div id="mobileMenu" class="hidden md:hidden bg-cream border-t border-black/10">
      <nav class="px-4 py-4 space-y-3" aria-label="Mobile">
        <a class="block u-underline" href="../features/">Features</a>
        <a class="block u-underline font-semibold text-accent" href="../latest/" aria-current="page">Latest</a>
        <a class="block u-underline" href="../sections/">Sections</a>
        <a class="block u-underline" href="../about/">About</a>
        <label class="relative block mt-3" aria-label="Search site">
          <input id="q-mobile" type="search" placeholder="Search..." class="w-full pl-10 pr-3 py-2 rounded-full border border-black/10 bg-white/70 focus:bg-white outline-none focus:ring-2 focus:ring-accent/40" />
          <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-ink-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke-width="2"/><path stroke-width="2" d="M21 21l-3.5-3.5"/></svg>
        </label>
      </nav>
    </div>
  </header>

  <!-- Page header -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div class="flex items-end justify-between">
      <div>
        <div class="text-[10px] sm:text-xs tracking-[0.14em] font-semibold text-accent uppercase">Browse</div>
        <h1 class="font-serif text-4xl sm:text-5xl leading-tight mt-1">Latest</h1>
        <p class="text-ink-500 mt-2">Newest posts across all sections.</p>
      </div>
      <div class="hidden sm:flex items-center gap-2">
        <label class="text-sm text-ink-500" for="sort">Sort by</label>
        <select id="sort" class="px-3 py-2 rounded-xl border border-black/10 bg-white">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Hero (newest overall) -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <article id="hero" class="grid lg:grid-cols-3 gap-8 items-stretch card hidden" data-href="#">
      <div class="lg:col-span-2">
        <img id="heroImg" class="w-full h-full object-cover aspect-[16/9]" src="" alt="Latest hero image">
      </div>
      <div class="p-6 sm:p-8 flex flex-col">
        <div class="flex items-center gap-3 text-xs uppercase tracking-wide text-accent">
          <span id="heroSection" class="bg-accent/10 text-accent px-2.5 py-1 rounded-full">Latest</span>
          <time id="heroDate" class="text-ink-300" datetime=""></time>
        </div>
        <h2 id="heroTitle" class="font-serif text-3xl mt-3 leading-tight"></h2>
        <p id="heroExcerpt" class="text-ink-500 mt-3"></p>

        <!-- HERO TAGS -->
        <div id="heroTags" class="hidden mt-3 flex flex-wrap gap-2"></div>

        <div class="mt-auto pt-5">
          <a href="../about/"
             class="author-link flex items-center gap-4 group"
             aria-label="About Camila Tiburcio Rubio">
            <img id="heroAvatar"
                 class="h-10 w-10 rounded-full object-cover group-hover:ring-2 group-hover:ring-accent group-hover:ring-offset-2 group-hover:ring-offset-cream"
                 src="../assets/camila.jpg"
                 alt="Camila Tiburcio Rubio" />
            <div>
              <p class="text-sm font-medium">
                By <span class="u-underline">Camila Tiburcio Rubio</span>
              </p>
              <p id="heroRead" class="text-xs text-ink-300"></p>
            </div>
          </a>
        </div>
        <a id="heroLink" href="#" class="mt-4 inline-block u-underline">Read the story →</a>
      </div>
    </article>
  </section>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10">
    <div class="flex flex-col lg:flex-row lg:items-center gap-3 justify-between">
      <div class="flex flex-wrap gap-2">
        <button class="chip" data-filter="all" data-active="true" aria-pressed="true">All</button>
        <button class="chip" data-filter="Essay">Essay</button>
        <button class="chip" data-filter="Interview">Interview</button>
        <button class="chip" data-filter="Review">Review</button>
        <button class="chip" data-filter="Visual">Visual</button>
        <button class="chip" data-filter="Community">Community</button>
        <button class="chip" data-filter="Memoirs">Memoirs</button>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
        <!-- Search input -->
        <div class="w-full sm:w-auto">
          <label class="sr-only" for="q-inline">Search titles, tags...</label>
          <input
            id="q-inline"
            type="search"
            placeholder="Search titles, tags…"
            class="w-full sm:w-64 px-3 py-2 rounded-xl border border-black/10 bg-white focus:bg-white outline-none focus:ring-2 focus:ring-accent/40"
          />
        </div>

        <!-- Per page selector -->
        <div class="flex items-center justify-end gap-2 text-xs sm:text-sm">
          <label class="text-ink-500" for="pageSize">Per page</label>
          <select
            id="pageSize"
            class="px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-xl border border-black/10 bg-white"
          >
            <option>6</option>
            <option selected>9</option>
            <option>12</option>
            <option>18</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>

    <!-- Pagination -->
    <div id="pager" class="mt-6 flex items-center justify-between">
      <button id="prevBtn" class="px-4 py-2 rounded-full border border-black/10 hover:bg-white disabled:opacity-40 disabled:pointer-events-none">← Previous</button>
      <div class="text-sm text-ink-300">
        Page <span id="pageNum">1</span> of <span id="pageTotal">1</span> • <span id="countShown">0</span>/<span id="countTotal">0</span> posts
      </div>
      <button id="nextBtn" class="px-4 py-2 rounded-full border border-black/10 hover:bg-white disabled:opacity-40 disabled:pointer-events-none">Next →</button>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="hidden text-ink-500 text-center py-16">
      <p class="text-lg">No posts match your filters.</p>
      <button id="resetFilters" class="mt-4 px-3 py-2 rounded-xl border border-black/10 bg-white hover:bg-cream">
        Clear filters
      </button>
    </div>

    <!-- Error state -->
    <div id="errorState" class="hidden text-center py-16 text-red-600">
      <p class="text-lg font-semibold">Couldn’t load posts. Please try again later.</p>
      <button id="retryBtn" class="mt-4 px-3 py-2 rounded-xl border border-red-200 bg-white hover:bg-red-50">
        Retry
      </button>
    </div>

    <!-- Card template -->
    <template id="cardTemplate">
      <article class="card flex flex-col" data-href="#">
        <img class="aspect-[16/10] object-cover" src="" alt="" />
        <div class="p-6 flex-1 flex flex-col">
          <div class="text-xs uppercase tracking-wide text-accent sectionLabel"></div>
          <h3 class="font-serif text-xl mt-2 leading-snug">
            <a class="u-underline link" href="#"></a>
          </h3>
          <p class="text-ink-500 mt-2 desc"></p>

          <!-- TAGS -->
          <div class="tagsWrap mt-3 flex flex-wrap gap-2"></div>

          <div class="mt-auto pt-4 text-sm text-ink-300 meta"></div>
        </div>
      </article>
    </template>
  </main>

  <!-- Back to top -->
  <button id="backTop"
          class="fixed right-4 bottom-4 hidden px-3 py-2 rounded-full border border-black/10 bg-white shadow-soft text-sm"
          aria-label="Back to top">↑ Top</button>

  <!-- Footer -->
  <footer class="mt-16 bg-white border-t border-black/10 text-sm text-ink-500">
    <!-- Desktop / tablet grid footer -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 hidden sm:grid sm:grid-cols-2 md:grid-cols-4 gap-10">
      <div>
        <div class="-ml-1.5">
          <div class="flex items-center gap-1">
            <img src="../assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
            <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
          </div>
        </div>
        <p class="mt-2 text-ink-400 text-sm max-w-xs">
          Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
        </p>
      </div>
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Explore</h3>
        <ul class="space-y-2">
          <li><a href="../features/" class="u-underline">Features</a></li>
          <li><a href="../latest/" class="u-underline font-semibold text-accent">Latest</a></li>
          <li><a href="../sections/" class="u-underline">Sections</a></li>
          <li><a href="../archive/" class="u-underline">Archive</a></li>
          <li><a href="../search/" class="u-underline">Search</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">About</h3>
        <ul class="space-y-2">
          <li><a href="../about/" class="u-underline">About</a></li>
          <li><a href="../contact/" class="u-underline">Contact</a></li>
          <li><a href="../mission/" class="u-underline">Mission</a></li>
          <li><a href="../resume/" class="u-underline">Résumé</a></li>
          <li><a href="../newsletter/" class="u-underline">Newsletter</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-ink-900 mb-3">Follow</h3>
        <ul class="space-y-2">
          <li><a href="https://instagram.com" class="u-underline">Instagram</a></li>
          <li><a href="https://twitter.com" class="u-underline">X / Twitter</a></li>
          <li><a href="https://facebook.com" class="u-underline">Facebook</a></li>
          <li><a href="https://linkedin.com" class="u-underline">Linkedin</a></li>
          <li><a href="https://youtube.com" class="u-underline">YouTube</a></li>
        </ul>
      </div>
    </div>

    <!-- Mobile accordion footer -->
    <div class="sm:hidden border-t border-black/10">
      <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Brand -->
        <div class="mb-6">
          <div class="-ml-1.5">
            <div class="flex items-center gap-1">
              <img src="../assets/logo.png" alt="Camila Tiburcio Rubio Logo" class="h-8 w-8 object-contain" />
              <span class="font-semibold text-ink-900">Camila Tiburcio Rubio</span>
            </div>
          </div>
          <p class="mt-2 text-ink-400 text-sm max-w-xs">
            Essays, interviews, and conversations from the life and mind of Camila Tiburcio Rubio.
          </p>
        </div>

        <!-- Explore -->
        <div class="border-t border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="explore"
            aria-expanded="false"
          >
            <span>Explore</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="explore"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="explore">
            <a href="../features/" class="block u-underline">Features</a>
            <a href="../latest/" class="block u-underline font-semibold text-accent" aria-current="page">Latest</a>
            <a href="../sections/" class="block u-underline">Sections</a>
            <a href="../archive/" class="block u-underline">Archive</a>
            <a href="../search/" class="block u-underline">Search</a>
          </div>
        </div>

        <!-- About -->
        <div class="border-t border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="about"
            aria-expanded="false"
          >
            <span>About</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="about"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="about">
            <a href="../about/" class="block u-underline">About</a>
            <a href="../contact/" class="block u-underline">Contact</a>
            <a href="../mission/" class="block u-underline">Mission</a>
            <a href="../resume/" class="block u-underline">Résumé</a>
            <a href="../newsletter/" class="block u-underline">Newsletter</a>
          </div>
        </div>

        <!-- Follow -->
        <div class="border-t border-black/10 border-b border-black/10">
          <button
            class="w-full flex items-center justify-between py-4 text-base font-medium text-ink-900"
            data-acc-btn="follow"
            aria-expanded="false"
          >
            <span>Follow</span>
            <svg
              class="w-4 h-4 transform transition-transform"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              data-acc-chevron="follow"
              aria-hidden="true"
            >
              <path d="M5 7.5L10 12.5L15 7.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="pb-4 space-y-2 text-sm text-ink-500 hidden" data-acc-panel="follow">
            <a href="https://instagram.com" class="block u-underline">Instagram</a>
            <a href="https://twitter.com" class="block u-underline">X / Twitter</a>
            <a href="https://facebook.com" class="block u-underline">Facebook</a>
            <a href="https://linkedin.com" class="block u-underline">Linkedin</a>
            <a href="https://youtube.com" class="block u-underline">YouTube</a>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center text-xs text-ink-300 border-t border-black/10 py-6">
      © <span id="year"></span> Camila Tiburcio Rubio. All rights reserved.
    </div>
  </footer>

  <script>
    // ---------- Year + mobile menu ----------
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    menuToggle?.addEventListener('click', () => {
      const isHidden = mobileMenu.classList.toggle('hidden');
      menuToggle.setAttribute('aria-expanded', String(!isHidden));
    });

    // Back to top
    const backTop = document.getElementById('backTop');
    const toggleTop = () => { if (window.scrollY > 600) backTop.classList.remove('hidden'); else backTop.classList.add('hidden'); };
    window.addEventListener('scroll', toggleTop, { passive:true });
    backTop.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

    // ---------- GitHub Pages subpath helper ----------
    function toRoot(path) {
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path;        // leave absolute URLs alone
      path = path.replace(/^\.?\//, '');                  // strip leading "./" or "/"
      return '../' + path;                                // go up one level
    }
    // ---------- Header search routing ----------
    function goSearch(q){
      const term = (q || '').trim();
      const url = toRoot(term
        ? `search/?q=${encodeURIComponent(term)}`
        : `search/`
      );
      window.location.href = url;
    }
    document.getElementById('qHeaderBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); goSearch(document.getElementById('q-desktop').value); });
    document.getElementById('q-desktop')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goSearch(e.target.value);} });
    document.getElementById('q-mobile')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goSearch(e.target.value);} });

    // ---------- Data loading ----------
    const FALLBACK = 'https://picsum.photos/seed/ctr-latest/1200/675';
    let LOAD_ERROR = false;

    async function fetchPostsJson(){
      try{
        const res = await fetch(toRoot('posts.json'), { cache: 'no-store' });
        if(!res.ok) throw new Error('bad status');
        const data = await res.json();
        LOAD_ERROR = false;
        document.getElementById('errorState').classList.add('hidden');
        return Array.isArray(data) ? data : null;
      }catch{
        LOAD_ERROR = true;
        // show error, hide main lists
        document.getElementById('errorState').classList.remove('hidden');
        document.getElementById('grid').classList.add('hidden');
        document.getElementById('pager').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('hero').classList.add('hidden');
        return null;
      }
    }

    function loadPublishedLocal(){
      const out=[];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('ctr:admin:published:')){
          try{ const obj = JSON.parse(localStorage.getItem(k)); if(obj && obj.title) out.push(obj);}catch{}
        }
      }
      return out;
    }

    function canonicalSection(s=''){
      const x = String(s).trim().toLowerCase();
      if (x==='essays') return 'Essay';
      if (x==='interviews') return 'Interview';
      if (x==='reviews') return 'Review';
      if (x==='visuals') return 'Visual';
      if (x==='memoir' || x==='memoirs') return 'Memoirs';
      if (x==='communities') return 'Community';
      return x ? x.charAt(0).toUpperCase()+x.slice(1) : 'Essay';
    }

    function normalize(p){
      const href = p.url || (p.slug ? `${p.slug}.html` : '#');
      const coverSrc =
        typeof p.cover === 'string'
          ? p.cover
          : (p.cover && p.cover.src ? p.cover.src : '');

      const tagsArr = Array.isArray(p.tags)
        ? p.tags
        : (typeof p.tags === 'string'
            ? p.tags.split(',').map(s => s.trim()).filter(Boolean)
            : []);

      return {
        title:   p.title || '',
        href:    toRoot(href),                              // ← up one level
        section: p.section || '',
        excerpt: p.excerpt || p.description || '',
        date:    p.date || p.publishedAt || '',
        read:    p.readMinutes || '',
        tags:    tagsArr,
        featured: !!p.featured,
        cover:   toRoot(coverSrc || 'images/default-cover.jpg'),
        author:  p.author || 'Camila Tiburcio Rubio'
      };
    }

    // ---------- Elements ----------
    const hero    = document.getElementById('hero');
    const heroImg = document.getElementById('heroImg');
    const heroSection = document.getElementById('heroSection');
    const heroDate = document.getElementById('heroDate');
    const heroTitle = document.getElementById('heroTitle');
    const heroExcerpt = document.getElementById('heroExcerpt');
    const heroRead = document.getElementById('heroRead');
    const heroLink = document.getElementById('heroLink');
    const heroTags = document.getElementById('heroTags');

    const gridEl = document.getElementById('grid');
    const tpl = document.getElementById('cardTemplate');

    const chips = Array.from(document.querySelectorAll('.chip'));
    const qInline = document.getElementById('q-inline');
    const sortSel = document.getElementById('sort');
    const pageSizeSel = document.getElementById('pageSize');

    const pageNumEl = document.getElementById('pageNum');
    const pageTotalEl = document.getElementById('pageTotal');
    const countShownEl = document.getElementById('countShown');
    const countTotalEl = document.getElementById('countTotal');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const pager = document.getElementById('pager');
    const emptyState = document.getElementById('emptyState');
    const errorState = document.getElementById('errorState');

    // ---------- State ----------
    let ALL = [];
    let state = {
      filter: 'all',
      sort: 'new',
      page: 1,
      pageSize: parseInt(pageSizeSel.value,10) || 9,
      q: ''
    };

    // ---------- Helpers ----------
    const fmtDate = iso => { try { return new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});} catch { return ''; } };
    const esc = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    function highlight(text, rawTerm){
      if (!rawTerm) return String(text || '');
      const parts = String(rawTerm).trim().split(/\s+/).filter(w => w.length >= 2);
      if (!parts.length) return String(text || '');
      const pat = new RegExp('(' + parts.map(esc).join('|') + ')', 'ig');
      return String(text || '').replace(pat, '<mark class="hl">$1</mark>');
    }

    const isNew = iso => {
      try { return (Date.now() - new Date(iso).getTime()) / 86400000 <= 7; }
      catch { return false; }
    };

    function bucketLabel(d){
      const now = new Date();
      const dt = new Date(d || 0);
      const days = Math.floor((now - dt)/86400000);
      if (days <= 7) return 'This week';
      return dt.toLocaleDateString(undefined, { month:'long', year:'numeric' });
    }

    function makeTagChip(text){
      const el=document.createElement('span');
      el.className='inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-accent/10 text-accent border border-accent/20 text-xs font-semibold';
      el.textContent=text;
      return el;
    }

    function buildCard(p, term){
      const node = tpl.content.cloneNode(true);
      const img = node.querySelector('img'); img.src = p.cover; img.alt = `${p.title} cover`;
      img.loading = 'lazy'; img.decoding = 'async';
      img.sizes = '(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw';

      const sectionEl = node.querySelector('.sectionLabel');
      sectionEl.textContent = p.section || 'Article';

      // NEW badge
      if (isNew(p.date)) {
        const tag = document.createElement('span');
        tag.className = 'inline-block ml-2 px-2 py-0.5 text-[10px] rounded-full bg-accent/10 text-accent border border-accent/30';
        tag.textContent = 'NEW';
        sectionEl.appendChild(tag);
      }

      const a = node.querySelector('.link'); a.href = p.href; a.innerHTML = highlight(p.title, term);
      const desc = node.querySelector('.desc'); desc.innerHTML = highlight(p.excerpt || '', term);

      // TAGS on card
      const wrap = node.querySelector('.tagsWrap');
      wrap.innerHTML = '';
      if (p.tags && p.tags.length) {
        p.tags.forEach(t => wrap.appendChild(makeTagChip(t)));
      }

      const meta = [];
      if (p.date) meta.push(fmtDate(p.date));
      if (p.read) meta.push(`${p.read} min`);
      node.querySelector('.meta').textContent = meta.join(' • ');

      // Stretched click
      const article = node.querySelector('article');
      article.setAttribute('data-href', p.href);
      return node;
    }

    function enableCardClicks(root=document){
      root.querySelectorAll('[data-href]').forEach(el => {
        if (el.__clickBound) return;
        el.__clickBound = true;
        el.classList.add('cursor-pointer');
        el.setAttribute('role','link');
        el.setAttribute('tabindex','0');
        el.addEventListener('click', e => {
          if (e.target.closest && e.target.closest('a')) return;
          const url = el.getAttribute('data-href');
          if (url) window.location.href = url;
        });
        el.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const url = el.getAttribute('data-href');
            if (url) window.location.href = url;
          }
        });
        el.addEventListener('mouseenter', () => {
          const url = el.getAttribute('data-href');
          if (!url || !('requestIdleCallback' in window)) return;
          const link = document.createElement('link');
          link.rel = 'prefetch'; link.href = url;
          document.head.appendChild(link);
          setTimeout(()=>link.remove(), 5000);
        });
      });
    }

    function applyFilters(list){
      const norm = s => (s||'').toLowerCase();
      let out = list.slice();

      if (state.filter !== 'all'){
        const f = norm(state.filter);
        out = out.filter(p => norm(p.section) === f || (p.tags||[]).map(norm).includes(f));
      }

      if (state.q){
        const q = norm(state.q);
        out = out.filter(p =>
          norm(p.title).includes(q) || norm(p.excerpt).includes(q) || (p.tags||[]).some(t => norm(t).includes(q))
        );
      }

      out.sort((a,b) => {
        if (state.sort === 'title') return (a.title||'').localeCompare(b.title||'');
        if (state.sort === 'old')   return new Date(a.date||0) - new Date(b.date||0);
        if (state.sort === 'read')  return (a.read||0) - (b.read||0);
        return new Date(b.date||0) - new Date(a.date||0); // 'new'
      });

      return out;
    }

    function renderGridWithGroups(items, term){
      gridEl.innerHTML = '';
      let current = '';
      items.forEach(p => {
        const label = bucketLabel(p.date);
        if (label !== current){
          current = label;
          const h = document.createElement('h2');
          h.className = 'col-span-full text-sm uppercase tracking-wide text-ink-300 mt-2';
          h.textContent = label;
          gridEl.appendChild(h);
        }
        gridEl.appendChild(buildCard(p, term));
      });
    }

    // ---------- URL state sync ----------
    function stateToURL(){
      const params = new URLSearchParams();
      if (state.filter !== 'all') params.set('filter', state.filter);
      if (state.sort !== 'new') params.set('sort', state.sort);
      if (state.q) params.set('q', state.q);
      if (state.page > 1) params.set('page', String(state.page));
      const url = `${location.pathname}?${params.toString()}`;
      history.replaceState(null, '', url);
    }

    function stateFromURL(){
      const sp = new URLSearchParams(location.search);
      state.filter = sp.get('filter') || 'all';
      state.sort = sp.get('sort') || 'new';
      state.q = sp.get('q') || '';
      state.page = parseInt(sp.get('page') || '1', 10) || 1;

      // reflect in controls
      chips.forEach(c => {
        const active = (c.dataset.filter || 'all') === state.filter;
        c.dataset.active = String(active);
        c.setAttribute('aria-pressed', String(active));
      });
      sortSel.value = state.sort;
      qInline.value = state.q;
      pageSizeSel.value = String(state.pageSize);
    }

    // ---------- Render ----------
    function render(){
      // If we’re in an error state, keep error visible and skip rendering lists
      if (LOAD_ERROR) {
        errorState.classList.remove('hidden');
        gridEl.classList.add('hidden');
        pager.classList.add('hidden');
        hero.classList.add('hidden');
        emptyState.classList.add('hidden');
        return;
      }

      const filtered = applyFilters(ALL);
      const total = filtered.length;
      const perPage = state.pageSize;

      // pagination calc
      const pages = Math.max(1, Math.ceil(total / perPage));
      if (state.page > pages) state.page = pages;

      const start = (state.page - 1) * perPage;
      const end = start + perPage;
      const pageItems = filtered.slice(start, end);

      // Hero visible only on page 1 and when there are posts
      const heroVisible = (state.page === 1 && ALL.length > 0);
      if (heroVisible){
        // NEWEST OVERALL: always use ALL[0], which is sorted by date desc in init()
        const h = ALL[0];

        heroImg.src = h.cover; heroImg.alt = h.title || 'Latest hero image';
        heroImg.fetchpriority = 'high';
        heroSection.textContent = h.section || 'Latest';
        heroDate.textContent = fmtDate(h.date); heroDate.dateTime = h.date || '';
        heroTitle.innerHTML = highlight(h.title, state.q);
        heroExcerpt.innerHTML = highlight(h.excerpt || '', state.q);
        heroRead.textContent = h.read ? `${h.read} min read` : '';
        heroLink.href = h.href || '#';
        hero.setAttribute('data-href', h.href || '#');

        // NEW badge near the date
        const old = hero.querySelector('[data-hero-new]'); old?.remove();
        if (isNew(h.date)) {
          const badge = document.createElement('span');
          badge.setAttribute('data-hero-new','');
          badge.className = 'ml-2 px-2 py-0.5 text-[10px] rounded-full bg-accent/10 text-accent border border-accent/30';
          badge.textContent = 'NEW';
          heroDate.parentElement.appendChild(badge);
        }

        // HERO TAGS
        heroTags.innerHTML = '';
        if (h.tags && h.tags.length){
          heroTags.classList.remove('hidden');
          h.tags.forEach(t => heroTags.appendChild(makeTagChip(t)));
        } else {
          heroTags.classList.add('hidden');
        }

        hero.classList.remove('hidden');
        enableCardClicks(hero.parentElement);
      } else {
        hero.classList.add('hidden');
      }

      // render grid (grouped labels)
      const term = (state.q || '').trim();
      renderGridWithGroups(pageItems, term);
      enableCardClicks(gridEl);

      // Show/hide empty state
      const empty = pageItems.length === 0;
      emptyState.classList.toggle('hidden', !empty);
      gridEl.classList.toggle('hidden', empty);

      // footer stats + buttons
      pageNumEl.textContent = String(state.page);
      pageTotalEl.textContent = String(pages);
      countShownEl.textContent = String(pageItems.length);
      countTotalEl.textContent = String(total);

      pager.classList.toggle('hidden', total === 0);
      prevBtn.disabled = state.page <= 1;
      nextBtn.disabled = state.page >= pages;

      errorState.classList.add('hidden');
      stateToURL();
    }

    // ---------- Events ----------
    document.querySelectorAll('.chip').forEach(chip => chip.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(c => { c.dataset.active = 'false'; c.setAttribute('aria-pressed','false'); });
      chip.dataset.active = 'true'; chip.setAttribute('aria-pressed','true');
      state.filter = chip.dataset.filter || 'all';
      state.page = 1;
      render();
    }));
    qInline?.addEventListener('input', (e)=>{ state.q = e.target.value; state.page = 1; render(); });
    sortSel?.addEventListener('change', ()=>{ state.sort = sortSel.value; state.page = 1; render(); });
    pageSizeSel.addEventListener('change', ()=>{ state.pageSize = parseInt(pageSizeSel.value,10)||9; state.page = 1; render(); });
    prevBtn.addEventListener('click', ()=>{ state.page = Math.max(1, state.page - 1); render(); });
    nextBtn.addEventListener('click', ()=>{ state.page = state.page + 1; render(); });

    // Reset filters (empty state)
    document.getElementById('resetFilters')?.addEventListener('click', () => {
      state = { filter: 'all', sort: 'new', page: 1, pageSize: 9, q: '' };
      chips.forEach(c => {
        const on = c.dataset.filter === 'all';
        c.dataset.active = on;
        c.setAttribute('aria-pressed', String(on));
      });
      sortSel.value = 'new';
      qInline.value = '';
      pageSizeSel.value = '9';
      render();
    });

    // Retry (error state)
    document.getElementById('retryBtn')?.addEventListener('click', () => {
      errorState.classList.add('hidden');
      LOAD_ERROR = false;
      init();
    });

    // ---------- Init ----------
    async function init(){
      stateFromURL();

      let data = await fetchPostsJson();

      // If fetch failed, keep error visible and bail out early
      if (LOAD_ERROR) return;

      if (!data || !data.length){
        const local = loadPublishedLocal();
        if (local.length) data = local;
      }
      if (!data) data = [];

      // Sort newest first by publish date
      ALL = data.map(normalize).sort((a,b)=> new Date(b.date||0)-new Date(a.date||0));
      render();
    }

    init();

    /* ---------- Mobile footer accordion ---------- */
    document.querySelectorAll('[data-acc-btn]').forEach(btn => {
      const name = btn.getAttribute('data-acc-btn');
      const panel = document.querySelector(`[data-acc-panel="${name}"]`);
      const chevron = document.querySelector(`[data-acc-chevron="${name}"]`);

      if (!panel) return;

      btn.addEventListener('click', () => {
        const isOpen = !panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!isOpen));

        if (chevron) {
          chevron.classList.toggle('rotate-180', !isOpen);
        }
      });
    });
  </script>
</body>
</html>
